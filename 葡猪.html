<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- ç¢ºä¿æ‰‹æ©Ÿè£ç½®çš„éŸ¿æ‡‰å¼è¨­è¨ˆå’Œ PWA é«”é©— -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‘¡è±¬è±¬æ—…éŠè¨ˆç•« | é€²éšè¡Œç¨‹ç·¨è¼¯</title>
    
    <!-- PWA: iOS ä¸»ç•«é¢åœ–ç¤º (å·²æ‡‰è¦æ±‚åŠ å…¥) -->
    <link rel="apple-touch-icon" href="/lisboagogo/apple-touch-icon.png">
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet CSS (åœ°åœ–) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #F0FDF4; 
            -webkit-tap-highlight-color: transparent; 
        }
        /* éš±è—æ»¾å‹•æ¢ */
        .hide-scroll::-webkit-scrollbar { display: none; } 
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; } /* Firefox */

        /* Firebase é€£ç·šç‹€æ…‹è„ˆè¡ */
        .sync-pulse { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        /* GPS å®šä½é»å‹•ç•« */
        .gps-marker {
            background-color: #3b82f6; /* è—è‰² */
            border: 2px solid white;
            border-radius: 50%;
            width: 16px; height: 16px;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.6); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        /* é¿å…è¼¸å…¥æ¡†èšç„¦æ™‚å‡ºç¾è—è‰²å¤–æ¡† */
        input:focus, select:focus, textarea:focus { outline: none; border-color: #10B981 !important; box-shadow: 0 0 0 1px #10B981 !important; }
        
        /* è®“åœ°åœ–åœ¨è¡Œå‹•è£ç½®ä¸Šä¿æŒå®Œæ•´é«˜åº¦ */
        #map { height: 100%; }
        
        /* è¦†å¯« Leaflet é è¨­é™°å½±, è®“æ¨™è¨˜æ›´è²¼åˆç¾ä»£ UI */
        .leaflet-marker-icon {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
    </style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden fixed inset-0">

    <!-- ä¸» App å®¹å™¨ï¼Œé™åˆ¶å¯¬åº¦ä»¥æ¨¡æ“¬æ‰‹æ©Ÿä»‹é¢ -->
    <div id="app" class="flex flex-col h-full max-w-md mx-auto w-full bg-white shadow-2xl relative sm:border-x sm:border-slate-200">

        <!-- Header -->
        <header class="bg-teal-600 text-white shrink-0 z-20 shadow-md transition-all duration-300">
            <div class="p-4 flex items-center justify-between pb-2">
                <!-- é–‹å§‹æ–°è¡Œç¨‹æŒ‰éˆ• -->
                <button v-if="roomId" @click="startNewTrip" class="text-white hover:text-teal-200 transition active:scale-95 p-1" title="é–‹å§‹æ–°è¡Œç¨‹">
                    <i class="ph-bold ph-house text-xl"></i>
                </button>
                <div v-else class="w-8 h-8"></div> <!-- ä¿æŒå°é½Šçš„ä½”ä½ç¬¦ -->
                
                <!-- æ—…ç¨‹åç¨±èˆ‡é€£ç·šç‹€æ…‹ -->
                <div class="flex items-center gap-3 min-w-0 flex-1 mx-3">
                    <!-- é€£ç·šç‹€æ…‹æŒ‡ç¤ºç‡ˆ -->
                    <div class="relative shrink-0">
                         <div v-if="isConnected" class="w-3 h-3 bg-green-400 rounded-full sync-pulse border border-white" title="å·²é€£ç·š"></div>
                         <div v-else class="w-3 h-3 bg-red-400 rounded-full border border-white" title="é›¢ç·šä¸­"></div>
                    </div>
                    <!-- æ—…ç¨‹åç¨±è¼¸å…¥æ¡† -->
                    <div class="overflow-hidden flex-1">
                        <input v-model="currentTrip.destination" class="bg-transparent border-none text-lg font-bold text-white placeholder-teal-200 w-full p-0 focus:ring-0 truncate" placeholder="è¼¸å…¥æ—…ç¨‹åç¨±...">
                    </div>
                </div>
                <!-- æˆ¿é–“ ID èˆ‡åˆ†äº«æŒ‰éˆ• -->
                <button @click="copyShareLink" class="text-[10px] bg-teal-700/50 px-2 py-1 rounded-full flex items-center gap-1 hover:bg-teal-700 transition active:scale-95">
                    <i class="ph-bold ph-users"></i> ID: {{ roomId || '...' }}
                </button>
            </div>

            <!-- æ¨¡å¼åˆ‡æ› Tabs -->
            <div class="px-4 pb-3 flex gap-2">
                 <button @click="viewMode = 'plan'" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-colors flex justify-center gap-1 active:scale-95" :class="viewMode === 'plan' ? 'bg-white text-teal-600' : 'bg-teal-700/30 text-teal-100'">
                    <i class="ph-bold ph-list-dashes text-sm"></i> è¡Œç¨‹
                 </button>
                 <button @click="viewMode = 'map'" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-colors flex justify-center gap-1 active:scale-95" :class="viewMode === 'map' ? 'bg-white text-teal-600' : 'bg-teal-700/30 text-teal-100'">
                    <i class="ph-bold ph-map-trifold text-sm"></i> åœ°åœ–
                 </button>
                 <button @click="viewMode = 'money'" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-colors flex justify-center gap-1 active:scale-95" :class="viewMode === 'money' ? 'bg-white text-teal-600' : 'bg-teal-700/30 text-teal-100'">
                    <i class="ph-bold ph-coins text-sm"></i> åˆ†å¸³
                 </button>
            </div>

            <!-- è¡Œç¨‹æ¨¡å¼ä¸‹çš„æ—¥æœŸé¸æ“‡å™¨ -->
            <div v-if="viewMode === 'plan' && days.length > 0" class="flex overflow-x-auto hide-scroll px-2 pb-3 space-x-2 snap-x items-center bg-teal-50 border-t border-teal-100 pt-2">
                <div v-for="(day, index) in days" :key="index" @click="currentDayIdx = index" class="snap-center shrink-0 flex flex-col items-center justify-center w-12 h-14 rounded-xl cursor-pointer transition-all border-2 relative overflow-hidden active:scale-105" :class="currentDayIdx === index ? 'bg-white text-teal-600 border-teal-400 shadow-md scale-105' : 'bg-white border-transparent text-slate-400 hover:bg-slate-50'">
                    <span class="text-[10px] font-medium opacity-80">Day</span>
                    <span class="text-sm font-black">{{ index + 1 }}</span>
                </div>
                <button @click="addDay" class="shrink-0 w-10 h-14 rounded-xl flex items-center justify-center border-2 border-dashed border-teal-300 border-dashed text-teal-300 hover:text-teal-500 hover:border-teal-500 transition active:scale-95"><i class="ph-bold ph-plus"></i></button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto bg-slate-50 relative hide-scroll">
            
            <!-- è¼‰å…¥ä¸­é®ç½© -->
            <div v-if="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 backdrop-blur-sm z-50">
                <i class="ph-duotone ph-spinner-gap animate-spin text-4xl text-teal-500 mb-3"></i>
                <p class="text-sm font-medium text-slate-500">æ­£åœ¨é€£ç·šåŒæ­¥ä¸­...</p>
            </div>

            <!-- 1. è¡Œç¨‹è¡¨ (Plan) -->
            <div v-show="viewMode === 'plan' && !loading" class="p-4 pb-16">
            
                <!-- èˆªç­è³‡è¨Šå¡ç‰‡ -->
                <div class="bg-indigo-50 p-4 rounded-xl shadow-sm mb-4 border border-indigo-200">
                    <div @click="showFlightDetails = !showFlightDetails" class="flex justify-between items-center cursor-pointer">
                        <h3 class="font-bold text-indigo-700 flex items-center gap-2">
                            <i class="ph-bold ph-airplane-takeoff"></i> èˆªç­/äº¤é€šè³‡è¨Š
                        </h3>
                        <i class="ph-bold ph-caret-down text-indigo-500 transition-transform" :class="{'rotate-180': showFlightDetails}"></i>
                    </div>
                    <!-- å¯å±•é–‹çš„è©³ç´°å…§å®¹ -->
                    <div v-show="showFlightDetails" class="mt-4 space-y-3 pt-3 border-t border-indigo-200">
                        <!-- å»ç¨‹ -->
                        <div class="space-y-1 p-2 bg-white rounded-lg border border-indigo-100 shadow-sm">
                            <div class="font-bold text-sm text-indigo-600 flex items-center gap-1">
                                <i class="ph-bold ph-arrow-circle-right"></i> å»ç¨‹ (Outbound)
                            </div>
                            <input v-model="currentTrip.travelDetails.outbound.flight" placeholder="èˆªç­è™Ÿç¢¼/è»Šæ¬¡" class="w-full text-xs border-none p-0 bg-transparent focus:ring-0">
                            <input v-model="currentTrip.travelDetails.outbound.time" placeholder="æ™‚é–“/èˆªç·š (TPE -> LIS)" class="w-full text-xs border-none p-0 bg-transparent focus:ring-0 text-slate-500">
                            <input v-model="currentTrip.travelDetails.outbound.pnr" placeholder="PNR è¨‚ä½ä»£è™Ÿ" class="w-full text-xs border-none p-0 bg-transparent focus:ring-0 text-orange-500">
                            <input v-model="currentTrip.travelDetails.outbound.note" placeholder="å‚™è¨» (å¦‚: è½‰æ©Ÿè³‡è¨Š)" class="w-full text-xs border-none p-0 bg-transparent focus:ring-0 text-slate-400">
                        </div>
                        <!-- å›ç¨‹ -->
                        <div class="space-y-1 p-2 bg-white rounded-lg border border-indigo-100 shadow-sm">
                            <div class="font-bold text-sm text-indigo-600 flex items-center gap-1">
                                <i class="ph-bold ph-arrow-circle-left"></i> å›ç¨‹ (Inbound)
                            </div>
                            <input v-model="currentTrip.travelDetails.inbound.flight" placeholder="èˆªç­è™Ÿç¢¼/è»Šæ¬¡" class="w-full text-xs border-none p-0 bg-transparent focus:ring-0">
                            <input v-model="currentTrip.travelDetails.inbound.time" placeholder="æ™‚é–“/èˆªç·š (LIS -> TPE)" class="w-full text-xs border-none p-0 bg-transparent focus:ring-0 text-slate-500">
                            <input v-model="currentTrip.travelDetails.inbound.pnr" placeholder="PNR è¨‚ä½ä»£è™Ÿ" class="w-full text-xs border-none p-0 bg-transparent focus:ring-0 text-orange-500">
                            <input v-model="currentTrip.travelDetails.inbound.note" placeholder="å‚™è¨» (å¦‚: è½‰æ©Ÿè³‡è¨Š)" class="w-full text-xs border-none p-0 bg-transparent focus:ring-0 text-slate-400">
                        </div>
                    </div>
                </div>
                <!-- èˆªç­è³‡è¨Šå¡ç‰‡çµæŸ -->

                <!-- æ¯æ—¥æ¨™é¡Œå¡ç‰‡ -->
                <div class="bg-white p-3 rounded-xl shadow-sm mb-4 border border-slate-100">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="ph-bold ph-calendar-blank text-teal-500"></i>
                        <!-- ç·¨è¼¯æ—¥æœŸåŠŸèƒ½ -->
                        <input type="date" v-model="currentDay.fullDate" class="text-xs text-slate-500 bg-transparent border-none p-0">
                        <span class="text-xs text-slate-400 ml-auto">{{ formatDate(currentDay.fullDate) }}</span>
                    </div>
                    <!-- ç·¨è¼¯ç•¶æ—¥ä¸»é¡ŒåŠŸèƒ½ -->
                    <input v-model="currentDay.title" class="text-base font-bold w-full border-none p-0 placeholder-slate-300 focus:ring-0" placeholder="ç•¶æ—¥ä¸»é¡Œ (ä¾‹å¦‚: æŠµé”é‡Œæ–¯æœ¬)">
                </div>

                <!-- è¡Œç¨‹åˆ—è¡¨ -->
                <div class="space-y-3 relative pl-4 border-l-2 border-teal-100 ml-1">
                    <div v-for="(item, idx) in currentDay.items" :key="idx" 
                         class="relative group cursor-pointer transition-all active:scale-[0.99]">
                        <!-- æ™‚é–“è»¸åœ“é» -->
                        <div class="absolute -left-[23px] top-4 w-4 h-4 rounded-full border-2 border-white shadow-sm z-10" :class="getTypeColor(item.type)"></div>
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-all">
                            <div class="flex items-start gap-2">
                                <!-- æ™‚é–“èˆ‡é¡å‹ -->
                                <div class="flex flex-col items-center w-14 shrink-0 gap-1">
                                    <div class="w-full text-center">
                                        <!-- ç·¨è¼¯æ™‚é–“åŠŸèƒ½ -->
                                        <input v-model="item.time" type="time" class="text-sm font-black bg-slate-100 rounded px-1 w-full text-center border-none text-slate-600 focus:ring-0">
                                    </div>
                                    <!-- ç·¨è¼¯è¡Œç¨‹é¡å‹åŠŸèƒ½ -->
                                    <select v-model="item.type" class="text-[10px] w-full bg-transparent border-none text-center p-0 cursor-pointer text-slate-400 focus:ring-0">
                                        <option value="spot">ğŸ“ æ™¯é»</option>
                                        <option value="restaurant">ğŸ´ é¤å»³</option>
                                        <option value="cafe">â˜• å’–å•¡å»³/ç”œé»</option>
                                        <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                                        <option value="transport">ğŸš‡ äº¤é€š</option>
                                        <option value="hotel">ğŸ¨ ä½å®¿</option>
                                    </select>
                                </div>
                                <!-- å…§å®¹ -->
                                <div class="flex-1 min-w-0 space-y-1">
                                    <!-- ç·¨è¼¯è¡Œç¨‹åç¨±åŠŸèƒ½ -->
                                    <input v-model="item.activity" class="w-full font-bold text-sm border-none p-0 text-slate-800 placeholder-slate-300 bg-transparent focus:ring-0" placeholder="è¡Œç¨‹åç¨±">
                                    <!-- ç·¨è¼¯åœ°é»/é—œéµå­—åŠŸèƒ½ -->
                                    <input v-model="item.location" class="w-full text-xs text-slate-500 border-none p-0 bg-transparent truncate focus:ring-0" placeholder="åœ°é» / å°èˆªé—œéµå­— (æ¨è–¦è‹±æ–‡)">

                                    <!-- æ–°å¢ï¼šé–‹æ”¾æ™‚é–“èˆ‡é–€ç¥¨è²»ç”¨ (æ‰€æœ‰é¡å‹å…±ç”¨) -->
                                    <div class="flex flex-wrap gap-2 items-center text-xs">
                                        <div class="flex items-center gap-1 bg-slate-50 rounded px-1 py-0.5 border border-slate-200">
                                            <i class="ph-bold ph-clock text-slate-400"></i>
                                            <input v-model="item.openingTime" class="w-20 bg-transparent border-none p-0 text-slate-600 focus:ring-0 text-xs" placeholder="é–‹æ”¾æ™‚é–“">
                                        </div>
                                        
                                        <!-- æ­å…ƒè¼¸å…¥èˆ‡å°å¹£é¡¯ç¤ºçš„å€å¡Š -->
                                        <!-- æ­å…ƒè¼¸å…¥ -->
                                        <div class="flex items-center gap-1 bg-slate-50 rounded px-1 py-0.5 border border-slate-200">
                                            <i class="ph-bold ph-ticket text-slate-400"></i>
                                            <input 
                                                v-model.number="item.euroFee" 
                                                @input="updateTwdFee(item)" 
                                                type="number" 
                                                min="0"
                                                step="0.01"
                                                class="w-14 bg-transparent border-none p-0 text-slate-600 focus:ring-0 text-xs text-right" 
                                                placeholder="æ­å…ƒ">
                                            <span class="text-[10px] text-slate-400">â‚¬</span>
                                        </div>
                                        <!-- å°å¹£é ä¼°é¡¯ç¤º -->
                                        <div class="flex items-center gap-1 bg-green-50 rounded px-1 py-0.5 border border-green-200">
                                            <span class="text-[10px] text-green-500 font-medium">é ä¼°</span>
                                            <span class="text-xs font-semibold text-green-700">{{ item.entryFee.toLocaleString() }}</span>
                                            <span class="text-[10px] text-green-400">NT$</span>
                                        </div>
                                    </div>

                                    <!-- æ–°å¢ï¼šæ¨è–¦èœè‰²/å¿…é»æ¸…å–® (é¤å»³/å’–å•¡å»³é™å®š) -->
                                    <div v-if="['restaurant', 'cafe'].includes(item.type)" class="bg-yellow-50/50 rounded px-1.5 py-0.5">
                                        <textarea v-model="item.recommendedDishes" rows="1" class="w-full text-[10px] text-yellow-700 px-0 py-0 bg-transparent border-none placeholder-yellow-400 focus:ring-0 resize-none" placeholder="æ¨è–¦èœè‰²/å¿…é»æ¸…å–® (ä¾‹å¦‚: ç¶“å…¸è›‹å¡”, ç¾©å¼æ¿ƒç¸®)"></textarea>
                                    </div>

                                    <!-- ç·¨è¼¯å‚™è¨»åŠŸèƒ½ (å¤šè¡Œè¼¸å…¥) -->
                                    <textarea v-model="item.note" rows="2" class="w-full text-[10px] bg-orange-50/50 text-orange-600 px-1.5 py-0.5 rounded border-none placeholder-orange-300 focus:ring-0 resize-none" placeholder="å‚™è¨»..."></textarea>
                                </div>
                                <!-- åˆªé™¤å–®ä¸€è¡Œç¨‹åŠŸèƒ½ -->
                                <button @click.stop="confirmAndDeleteItem(idx)" class="text-slate-200 hover:text-red-400 p-1 shrink-0"><i class="ph-bold ph-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    <!-- æ–°å¢è¡Œç¨‹æŒ‰éˆ•åŠŸèƒ½ -->
                    <button @click="addItem" class="w-full py-3 border-2 border-dashed border-teal-200 rounded-xl text-teal-400 font-bold text-sm hover:bg-teal-50 flex items-center justify-center gap-2 transition active:scale-95">
                        <i class="ph-bold ph-plus-circle"></i> æ–°å¢è¡Œç¨‹
                    </button>
                </div>
                <!-- åˆªé™¤æ•´æ—¥è¡Œç¨‹åŠŸèƒ½ -->
                <div class="mt-8 text-center">
                     <button @click="confirmAndDeleteDay" class="text-xs text-slate-300 hover:text-red-400 underline transition">åˆªé™¤ç•¶å¤©è¡Œç¨‹</button>
                </div>
            </div>

            <!-- 2. åœ°åœ– (Map) -->
            <div v-show="viewMode === 'map'" class="h-full flex flex-col relative">
                <!-- åœ°åœ–æœå°‹æ¬„ -->
                <div class="absolute top-4 left-4 right-4 z-[1000] p-1 bg-white rounded-xl shadow-xl flex gap-2">
                    <input v-model="mapSearchQuery" @keyup.enter="performMapSearch" placeholder="è¼¸å…¥åœ°é»é—œéµå­— (æ¨è–¦ä½¿ç”¨è‹±æ–‡)" class="flex-1 border-none text-sm px-2 py-1.5 focus:ring-0">
                    <button @click="performMapSearch" :disabled="!mapSearchQuery" class="shrink-0 bg-teal-600 text-white rounded-lg px-3 py-1.5 font-bold text-sm transition active:scale-95 disabled:opacity-50 hover:bg-teal-700">
                        <i class="ph-bold ph-magnifying-glass"></i>
                    </button>
                </div>

                <div id="map" class="flex-1 w-full h-full bg-slate-100 z-0"></div>
                <!-- åœ°åœ–ä¸Šè¦†è“‹çš„æ“ä½œæŒ‰éˆ• -->
                <div class="absolute bottom-6 left-4 right-4 z-[1000] flex gap-2 justify-center">
                    <!-- GPS å®šä½åŠŸèƒ½ -->
                    <button @click="locateUser" class="bg-blue-600 text-white px-4 py-2.5 rounded-full shadow-xl font-bold text-sm flex items-center gap-2 active:scale-95 transition hover:bg-blue-700">
                        <i v-if="isLocating" class="ph-bold ph-spinner-gap animate-spin"></i>
                        <i v-else class="ph-bold ph-crosshair"></i>
                        {{ isLocating ? 'å®šä½ä¸­...' : 'æˆ‘çš„ä½ç½®' }}
                    </button>
                    <!-- é¡¯ç¤ºè¡Œç¨‹åœ°é» -->
                    <button @click="plotPlannedLocations(true)" class="bg-white text-slate-600 px-4 py-2.5 rounded-full shadow-xl font-bold text-sm flex items-center gap-2 active:scale-95 transition hover:bg-slate-100">
                        <i class="ph-bold ph-map-pin"></i> é‡æ–°æ•´ç†æ™¯é»
                    </button>
                </div>
            </div>

            <!-- 3. åˆ†å¸³ (Money) -->
            <div v-show="viewMode === 'money'" class="p-4 pb-32">
                <!-- ç¸½æ”¯å‡ºé¡¯ç¤ºåŠŸèƒ½ -->
                <div class="bg-slate-800 text-white rounded-2xl p-6 shadow-lg mb-4 text-center">
                    <div class="text-xs text-slate-400 mb-1">ç¸½æ”¯å‡º (Total)</div>
                    <div class="text-3xl font-bold font-mono tracking-tight">NT$ {{ totalExpense.toLocaleString() }}</div>
                </div>
                <!-- æ–°å¢æ”¯å‡ºè¡¨å–®åŠŸèƒ½ -->
                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 mb-6">
                    <h3 class="font-bold text-sm text-slate-700 mb-3">æ–°å¢æ”¯å‡ºé …ç›®</h3>
                    <div class="flex gap-2 mb-2">
                         <input v-model="newExpense.item" placeholder="é …ç›® (å¦‚: æ™šé¤)" class="flex-[2] bg-slate-100 border-none rounded-lg px-3 py-2 text-sm focus:ring-teal-500">
                         <input v-model="newExpense.payer" placeholder="èª°ä»˜çš„" class="flex-1 bg-slate-100 border-none rounded-lg px-3 py-2 text-sm text-center focus:ring-teal-500">
                    </div>
                    <div class="flex gap-2">
                         <input v-model.number="newExpense.amount" type="number" placeholder="é‡‘é¡" class="flex-1 bg-slate-100 border-none rounded-lg px-3 py-2 text-sm font-mono focus:ring-teal-500">
                         <button @click="addExpense" class="bg-teal-600 text-white rounded-lg px-4 py-2 font-bold text-sm transition active:scale-95 hover:bg-teal-700"><i class="ph-bold ph-plus"></i> æ–°å¢</button>
                    </div>
                </div>
                <!-- æ”¯å‡ºåˆ—è¡¨èˆ‡åˆªé™¤åŠŸèƒ½ -->
                <div class="space-y-2">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-teal-50 text-teal-600 flex items-center justify-center text-xs font-bold shrink-0">{{ exp.payer ? exp.payer[0].toUpperCase() : '?' }}</div>
                            <div>
                                <div class="font-bold text-slate-700 text-sm">{{ exp.item }}</div>
                                <div class="text-xs text-slate-400">by {{ exp.payer || 'æœªçŸ¥' }}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 shrink-0">
                            <span class="font-bold font-mono text-lg text-teal-600">NT${{ exp.amount.toLocaleString() }}</span>
                            <button @click="expenses.splice(idx, 1)" class="text-slate-300 hover:text-red-400 p-1"><i class="ph-bold ph-x"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- æ¨¡æ…‹æ¡†ï¼šé€²å…¥/å»ºç«‹æˆ¿é–“ -->
        <div v-if="showRoomModal" class="fixed inset-0 bg-slate-900/80 z-[999] flex items-center justify-center p-6 backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-8 w-full max-w-sm text-center shadow-2xl">
                <div class="w-20 h-20 bg-teal-50 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="ph-duotone ph-airplane-tilt text-4xl text-teal-600"></i>
                </div>
                <h2 class="text-2xl font-black text-slate-800 mb-5">è‘¡è±¬è±¬æ—…éŠè¨ˆç•«</h2>
                <div class="space-y-4">
                    <input v-model="inputRoomId" class="w-full bg-slate-100 border-2 border-slate-200 rounded-xl px-4 py-3 text-center font-mono text-lg uppercase placeholder-slate-400 focus:ring-teal-500" placeholder="è¼¸å…¥è¡Œç¨‹ ID">
                    <button @click="joinRoom" class="w-full bg-teal-600 text-white font-bold py-3 rounded-xl transition hover:bg-teal-700 active:scale-95">é€²å…¥ç¾æœ‰è¡Œç¨‹</button>
                    <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-slate-200"></div><span class="flex-shrink mx-4 text-slate-300 text-xs">æˆ–</span><div class="flex-grow border-t border-slate-200"></div></div>
                    <button @click="createNewRoom" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl transition hover:bg-slate-700 active:scale-95">å»ºç«‹æ–°è¡Œç¨‹</button>
                </div>
            </div>
        </div>
        
        <!-- æ¨¡æ…‹æ¡†ï¼šé€šç”¨ç¢ºèª/è­¦å‘Š -->
        <div v-if="alertMessage" class="fixed inset-0 bg-slate-900/80 z-[1000] flex items-center justify-center p-6 backdrop-blur-sm">
            <div class="bg-white rounded-xl p-6 w-full max-w-xs text-center shadow-2xl">
                <p class="text-lg font-medium text-slate-700 mb-4">{{ alertMessage }}</p>
                <button @click="closeAlert" class="w-full bg-teal-600 text-white font-bold py-2 rounded-lg transition hover:bg-teal-700">ç¢ºèª</button>
            </div>
        </div>
        
        <!-- æ¨¡æ…‹æ¡†ï¼šé€šç”¨ç¢ºèªå°è©±æ¡† -->
        <div v-if="confirmPrompt" class="fixed inset-0 bg-slate-900/80 z-[1001] flex items-center justify-center p-6 backdrop-blur-sm">
            <div class="bg-white rounded-xl p-6 w-full max-w-xs text-center shadow-2xl">
                <p class="text-lg font-medium text-slate-700 mb-4">{{ confirmPrompt }}</p>
                <div class="flex gap-3">
                    <button @click="confirmCancel" class="flex-1 bg-slate-200 text-slate-700 font-bold py-2 rounded-lg transition hover:bg-slate-300">å–æ¶ˆ</button>
                    <button @click="confirmProceed" class="flex-1 bg-red-500 text-white font-bold py-2 rounded-lg transition hover:bg-red-600">ç¢ºå®š</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, reactive, watch, computed, nextTick, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        
        // Firebase Realtime Database Imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        // å°å…¥ onValue, ref as dbRef, set
        import { getDatabase, ref as dbRef, onValue, set } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // ç”±æ–¼æˆ‘å€‘ä¸åœ¨ Canvas ç’°å¢ƒä¸­ï¼Œéœ€è¦æ‰‹å‹•æä¾› Firebase Realtime Database é…ç½®
        const firebaseConfig = {
            // IMPORTANT: å¯¦éš›æ‡‰ç”¨ä¸­è«‹æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„é…ç½®
            apiKey: "YOUR_API_KEY_HERE", 
            authDomain: "tripplanner-demo.firebaseapp.com",
            databaseURL: "https://tripplanner-demo-default-rtdb.firebaseio.com",
            projectId: "tripplanner-demo",
            storageBucket: "tripplanner-demo.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890",
        };
        
        // æª¢æŸ¥æ˜¯å¦æä¾›äº†ç¤ºç¯„ç”¨çš„é…ç½®ï¼Œå¦å‰‡ä½¿ç”¨é ç•™é…ç½®
        if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
             // è­¦å‘Š: é€™æ˜¯ä¸€å€‹å…¬å…±æ¸¬è©¦ç”¨çš„ RDBï¼Œä¸ä¿è­‰è³‡æ–™æŒä¹…æ€§æˆ–å®‰å…¨æ€§ã€‚
             console.warn("Firebase è­¦å‘Š: æ­£åœ¨ä½¿ç”¨å…¬å…±ç¤ºç¯„æ•¸æ“šåº«ã€‚è«‹è‡ªè¡Œé…ç½®ã€‚");
             firebaseConfig.databaseURL = "https://lisboaaa-2c65b-default-rtdb.firebaseio.com";
             firebaseConfig.projectId = "lisboaaa-2c65b";
        }

        const fbApp = initializeApp(firebaseConfig);
        const db = getDatabase(fbApp);

        createApp({
            setup() {
                // --- æ­å…ƒåˆ°å°å¹£çš„æ¨¡æ“¬åŒ¯ç‡ ---
                const MOCK_EXCHANGE_RATE_EUR_TO_TWD = 35.00; // æ¨¡æ“¬åŒ¯ç‡
                
                const viewMode = ref('plan');
                const currentDayIdx = ref(0);
                const isConnected = ref(false);
                const loading = ref(false);
                const showRoomModal = ref(true);
                const inputRoomId = ref('');
                const urlParams = new URLSearchParams(window.location.search);
                const roomId = ref(urlParams.get('room') || ''); 
                const isLocating = ref(false); 
                
                // æ§åˆ¶èˆªç­è³‡è¨Šå¡ç‰‡æ˜¯å¦å±•é–‹
                const showFlightDetails = ref(false); 
                
                // åœ°åœ–æœå°‹ç‹€æ…‹
                const mapSearchQuery = ref('');
                let map = null;
                let userMarker = null;
                let geocodingMarkers = L.layerGroup(); 
                let tripMarkers = L.layerGroup();      

                // é€šç”¨è­¦å ±èˆ‡ç¢ºèªæ¡†ç‹€æ…‹
                const alertMessage = ref('');
                const confirmPrompt = ref('');
                let confirmResolve = null;
                
                let unsubscribe = null; 

                // --- é è¨­è¡Œç¨‹çµæ§‹ ---
                const defaultTrip = { 
                    destination: 'é‡Œæ–¯æœ¬ X è‘¡è±¬è±¬ä¹‹æ—…', 
                    travelDetails: {
                        outbound: { flight: 'CX359', time: 'TPE 18:00 -> LIS 08:00', note: 'è½‰æ©Ÿä¸€æ¬¡', pnr: 'ABCDEF' },
                        inbound: { flight: 'TK1385', time: 'LIS 10:00 -> TPE 09:00', note: 'åœŸè€³å…¶èˆªç©º', pnr: 'GHIJKL' },
                    },
                    days: [
                        { fullDate: new Date().toISOString().split('T')[0], title: 'Day 1: æŠµé”èˆ‡å•Ÿç¨‹', items: [
                            { 
                                time: '09:00', type: 'spot', activity: 'ç¾…è¥¿æ­å»£å ´', location: 'Rossio Square', note: 'é‡Œæ–¯æœ¬å¸‚ä¸­å¿ƒçš„å¤§å»£å ´', 
                                openingTime: 'å…¨å¤©é–‹æ”¾', euroFee: 0, entryFee: 0, recommendedDishes: '' 
                            },
                            { 
                                time: '11:00', type: 'restaurant', activity: 'è‘¡å¼è›‹å¡”åº—', location: 'PastÃ©is de BelÃ©m', note: 'é€™å®¶åº—è¶…ç´šå¥½åƒï¼Œä¸€å®šè¦æ’éšŠï¼', 
                                openingTime: '10:00 - 20:00', euroFee: 0, entryFee: 0, recommendedDishes: 'ç¶“å…¸è‘¡å¼è›‹æ’», å’–å•¡' 
                            },
                            { 
                                time: '13:00', type: 'cafe', activity: 'A Brasileira å’–å•¡å»³', location: 'A Brasileira', note: 'æ­·å²æ‚ ä¹…ï¼Œè©©äººè²»çˆ¾å—å¤šÂ·ä½©ç´¢äºå¸¸å»çš„å’–å•¡é¤¨', 
                                openingTime: '08:00 - 00:00', euroFee: 0, entryFee: 0, recommendedDishes: 'Bica æ¿ƒç¸®å’–å•¡, è›‹ç³•' 
                            },
                            { 
                                time: '15:00', type: 'transport', activity: 'æ­ä¹˜ 28 è™Ÿé›»è»Š', location: 'Alfama å€', note: 'é«”é©—å¾©å¤é›»è»Šï¼Œæ³¨æ„æ‰’æ‰‹ï¼', 
                                openingTime: '06:00 - 22:30', euroFee: 4.5, entryFee: Math.round(4.5 * MOCK_EXCHANGE_RATE_EUR_TO_TWD), recommendedDishes: '' 
                            },
                            { 
                                time: '18:00', type: 'hotel', activity: 'å…¥ä½é£¯åº—', location: 'Lisbon Marriott Hotel', note: 'ç¢ºèªè¨‚å–®ç·¨è™Ÿ', 
                                openingTime: '24å°æ™‚', euroFee: 0, entryFee: 0, recommendedDishes: '' 
                            }
                        ] }
                    ], 
                    expenses: [] 
                };
                const currentTrip = ref(JSON.parse(JSON.stringify(defaultTrip)));
                const isRemoteUpdate = ref(false); 

                // è¨ˆç®—å±¬æ€§
                const days = computed(() => currentTrip.value.days || []);
                const currentDay = computed(() => days.value[currentDayIdx.value] || {});
                const expenses = computed(() => currentTrip.value.expenses || []);
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (Number(item.amount) || 0), 0));
                const newExpense = reactive({ item: '', amount: null, payer: '' });
                
                // ç”¨ä¾†è§¸ç™¼åœ°åœ–ç¹ªè£½çš„è¨ˆç®—å±¬æ€§ (ç•¶ viewMode æ˜¯ map æ™‚ï¼Œè¡Œç¨‹å…§å®¹è®Šå‹•æœƒæ›´æ–°æ­¤ key)
                const plottingKey = computed(() => {
                    const items = currentDay.value.items || [];
                    if (viewMode.value === 'map') {
                         return items.map(i => `${i.location}|${i.activity}|${i.type}`).join(';'); 
                    }
                    return null; // åœ¨éåœ°åœ–æ¨¡å¼ä¸‹ï¼Œä¸è§¸ç™¼ç›£è½
                });

                // --- æ¨¡æ…‹æ¡†æ“ä½œ ---
                const showAlert = (message) => {
                    alertMessage.value = message;
                };
                const closeAlert = () => {
                    alertMessage.value = '';
                };
                const showConfirm = (prompt) => {
                    confirmPrompt.value = prompt;
                    return new Promise((resolve) => {
                        confirmResolve = resolve;
                    });
                };
                const confirmProceed = () => {
                    confirmPrompt.value = '';
                    if (confirmResolve) confirmResolve(true);
                    confirmResolve = null;
                };
                const confirmCancel = () => {
                    confirmPrompt.value = '';
                    if (confirmResolve) confirmResolve(false);
                    confirmResolve = null;
                };


                // --- Firebase é€£ç·šèˆ‡åŒæ­¥ ---
                const connectToFirebase = () => {
                    if (!roomId.value) return;
                    loading.value = true;
                    
                    if (unsubscribe) {
                        unsubscribe(); 
                        unsubscribe = null;
                    }

                    const tripRef = dbRef(db, 'trips/' + roomId.value);
                    
                    unsubscribe = onValue(tripRef, (snapshot) => {
                        isConnected.value = true;
                        const val = snapshot.val();
                        
                        isRemoteUpdate.value = true;
                        if (val) {
                            // ç¢ºä¿çµæ§‹å®Œæ•´æ€§
                            if(!val.days || val.days.length === 0) val.days = JSON.parse(JSON.stringify(defaultTrip.days));
                            if(!val.expenses) val.expenses = [];
                            if(!val.travelDetails) val.travelDetails = JSON.parse(JSON.stringify(defaultTrip.travelDetails));

                            // è™•ç†èˆŠæ•¸æ“šçµæ§‹ï¼Œç¢ºä¿æ‰€æœ‰ item éƒ½æœ‰ euroFee æ¬„ä½ (æ•¸æ“šé·ç§»ä¿è­·)
                            if (val.days) {
                                val.days.forEach(day => {
                                    if (day.items) {
                                        day.items.forEach(item => {
                                            if (typeof item.euroFee !== 'number') { item.euroFee = 0; }
                                            if (typeof item.entryFee !== 'number' || item.entryFee === 0 && item.euroFee > 0) {
                                                item.entryFee = Math.round(item.euroFee * MOCK_EXCHANGE_RATE_EUR_TO_TWD);
                                            }
                                        });
                                    }
                                });
                            }
                            currentTrip.value = val;
                        } else {
                            // å¦‚æœæˆ¿é–“ä¸å­˜åœ¨ï¼Œå‰‡åˆå§‹åŒ–
                            set(tripRef, defaultTrip);
                            currentTrip.value = JSON.parse(JSON.stringify(defaultTrip));
                        }
                        
                        if (currentDayIdx.value >= days.value.length) {
                             currentDayIdx.value = Math.max(0, days.value.length - 1);
                        }
                        
                        loading.value = false;
                        nextTick(() => isRemoteUpdate.value = false);

                    }, (error) => {
                        isConnected.value = false;
                        loading.value = false;
                        console.error("Firebase é€£ç·šéŒ¯èª¤:", error.message);
                        if (unsubscribe) unsubscribe = null; 
                    });
                };

                // æ·±åº¦ç›£è½ currentTripï¼Œç•¶æœ¬åœ°æ•¸æ“šè®ŠåŒ–æ™‚ï¼ŒåŒæ­¥å¯«å…¥ Firebase
                watch(currentTrip, (newVal) => {
                    if (roomId.value && !loading.value && !isRemoteUpdate.value) {
                        newVal.days = newVal.days || [];
                        newVal.expenses = newVal.expenses || [];
                        newVal.travelDetails = newVal.travelDetails || JSON.parse(JSON.stringify(defaultTrip.travelDetails));
                        
                        const tripRef = dbRef(db, 'trips/' + roomId.value);
                        set(tripRef, newVal).catch(e => console.error("Firebase å¯«å…¥å¤±æ•—:", e));
                    }
                }, { deep: true });

                // --- æˆ¿é–“ç®¡ç† ---
                const startNewTrip = async () => {
                    const result = await showConfirm('ç¢ºå®šè¦é›¢é–‹ç›®å‰çš„è¡Œç¨‹ä¸¦é–‹å§‹æ–°çš„è¡Œç¨‹å—ï¼Ÿ (æ‚¨éš¨æ™‚å¯ä»¥é€éè¡Œç¨‹ ID é‡æ–°åŠ å…¥)');
                    if (result) {
                        if (unsubscribe) {
                            unsubscribe();
                            unsubscribe = null;
                        }
                        
                        const url = new URL(window.location); 
                        url.searchParams.delete('room');
                        window.history.pushState({}, '', url); 

                        roomId.value = '';
                        inputRoomId.value = '';
                        currentTrip.value = JSON.parse(JSON.stringify(defaultTrip));
                        currentDayIdx.value = 0;
                        isConnected.value = false;

                        showRoomModal.value = true;
                    }
                };

                const createNewRoom = () => { 
                    roomId.value = Math.random().toString(36).substr(2, 6).toUpperCase(); 
                    finalizeJoin(); 
                };
                const joinRoom = () => { 
                    if(!inputRoomId.value.trim()) return showAlert("è«‹è¼¸å…¥æœ‰æ•ˆçš„è¡Œç¨‹ ID"); 
                    roomId.value = inputRoomId.value.trim().toUpperCase(); 
                    finalizeJoin(); 
                };
                const finalizeJoin = () => { 
                    const url = new URL(window.location); 
                    url.searchParams.set('room', roomId.value); 
                    window.history.pushState({}, '', url); 
                    
                    showRoomModal.value = false; 
                    connectToFirebase(); 
                };
                const copyShareLink = () => { 
                    if (!roomId.value) return showAlert("è«‹å…ˆå»ºç«‹æˆ–åŠ å…¥è¡Œç¨‹ï¼");
                    navigator.clipboard.writeText(window.location.href); 
                    showAlert("è¡Œç¨‹é€£çµå·²è¤‡è£½ï¼åˆ†äº«çµ¦æ—…ä¼´å³å¯å…±åŒç·¨è¼¯ã€‚"); 
                };
                
                // --- è¡Œç¨‹æ“ä½œ ---
                const addDay = () => {
                    const last = days.value[days.value.length-1]; 
                    const next = new Date(last ? last.fullDate : new Date()); 
                    if(last) next.setDate(next.getDate() + 1);
                    
                    days.value.push({ fullDate: next.toISOString().split('T')[0], title: 'æ–°çš„ä¸€å¤©', items: [] }); 
                    currentDayIdx.value = days.value.length - 1;
                };

                const addItem = () => { 
                    if(!currentDay.value.items) currentDay.value.items = []; 
                    currentDay.value.items.push({ 
                        time: '09:00', 
                        type: 'spot', 
                        activity: 'æ–°æ™¯é»', 
                        location: '', 
                        note: '',
                        openingTime: '', 
                        euroFee: 0,      
                        entryFee: 0,     
                        recommendedDishes: '' 
                    }); 
                };
                
                const confirmAndDeleteItem = async (idx) => {
                    event.stopPropagation(); 
                    const item = currentDay.value.items[idx];
                    const result = await showConfirm(`ç¢ºå®šè¦åˆªé™¤è¡Œç¨‹ "${item.activity}" å—ï¼Ÿ`);
                    if (result) {
                        currentDay.value.items.splice(idx, 1);
                    }
                }
                const confirmAndDeleteDay = async () => { 
                    if(days.value.length <= 1) return showAlert('æ—…éŠè¨ˆç•«è‡³å°‘éœ€è¦ä¿ç•™ä¸€å¤©ï¼'); 
                    const result = await showConfirm('ç¢ºå®šè¦åˆªé™¤ Day ' + (currentDayIdx.value + 1) + ' å—ï¼Ÿ');
                    if (result) {
                        days.value.splice(currentDayIdx.value, 1); 
                        currentDayIdx.value = Math.max(0, currentDayIdx.value - 1); 
                    }
                };
                
                // --- æ­å…ƒæ›ç®—å°å¹£å‡½æ•¸ ---
                const updateTwdFee = (item) => {
                    let euro = (Number(item.euroFee) || 0);
                    if (euro < 0) euro = 0;
                    item.euroFee = parseFloat(euro.toFixed(2));
                    item.entryFee = Math.round(item.euroFee * MOCK_EXCHANGE_RATE_EUR_TO_TWD);
                };

                const getTypeColor = (type) => { 
                    return ({ 
                        spot: 'bg-teal-500', 
                        restaurant: 'bg-orange-500', 
                        cafe: 'bg-yellow-500',       
                        shop: 'bg-purple-500', 
                        transport: 'bg-blue-500', 
                        hotel: 'bg-indigo-500' 
                    })[type] || 'bg-slate-400'; 
                };

                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    try {
                        const date = new Date(dateStr + 'T00:00:00'); 
                        return date.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric', weekday: 'short' });
                    } catch {
                        return dateStr;
                    }
                };
                
                // --- åˆ†å¸³æ“ä½œ ---
                const addExpense = () => { 
                    if(newExpense.item && newExpense.amount > 0) { 
                        expenses.value.unshift({ 
                            item: newExpense.item,
                            amount: Number(newExpense.amount),
                            payer: newExpense.payer || 'æˆ‘'
                        }); 
                        newExpense.item = ''; 
                        newExpense.amount = null; 
                        newExpense.payer = '';
                    } else {
                        showAlert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é …ç›®åç¨±å’Œé‡‘é¡ã€‚");
                    }
                };
                
                // --- åœ°åœ–èˆ‡å®šä½ (å·²ä¿®å¾©æ¨™è¨»é‚è¼¯) ---
                
                const initMap = () => {
                    const mapContainer = document.getElementById('map');
                    if (!mapContainer || viewMode.value !== 'map') return;

                    if (map) { map.remove(); map = null; }
                    
                    const defaultLat = 38.7223; // Lisbon default
                    const defaultLng = -9.1393;
                    
                    map = L.map('map').setView([defaultLat, defaultLng], 13); 
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                        maxZoom: 19,
                    }).addTo(map);

                    geocodingMarkers.clearLayers();
                    tripMarkers.clearLayers();
                    geocodingMarkers.addTo(map);
                    tripMarkers.addTo(map);

                    if (userMarker) {
                         userMarker.addTo(map);
                    }
                    
                    map.whenReady(() => {
                        map.invalidateSize();
                    });
                };

                const locateUser = () => {
                    if (!navigator.geolocation) return showAlert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚");
                    isLocating.value = true;
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            if(!map) initMap();

                            map.flyTo([latitude, longitude], 16);

                            if(userMarker) map.removeLayer(userMarker);
                            const myIcon = L.divIcon({ className: 'gps-marker', iconSize: [16, 16], iconAnchor: [8, 8] });
                            userMarker = L.marker([latitude, longitude], {icon: myIcon}).addTo(map).bindPopup("æˆ‘ç¾åœ¨çš„ä½ç½®").openPopup();
                            
                            isLocating.value = false;
                        },
                        (error) => {
                            let errMsg = "ç„¡æ³•ç²å–ä½ç½®ï¼Œè«‹ç¢ºèªæ˜¯å¦å…è¨±å®šä½æ¬Šé™ã€‚";
                            if (error.code === error.PERMISSION_DENIED) {
                                errMsg = "å®šä½æ¬Šé™è¢«æ‹’çµ•ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚";
                            } else if (error.code === error.POSITION_UNAVAILABLE) {
                                errMsg = "ä½ç½®è³‡è¨Šç„¡æ³•å–å¾—ã€‚";
                            }
                            showAlert(errMsg);
                            isLocating.value = false;
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                    );
                };
                
                const geocodeLocation = async (query) => {
                    if (!query) return;
                    
                    // ä½¿ç”¨ OpenStreetMap çš„ Nominatim æœå‹™é€²è¡Œåœ°ç†ç·¨ç¢¼
                    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&accept-language=en`;
                    
                    try {
                        const response = await fetch(url);
                        
                        if (!response.ok) throw new Error("Geocoding æœå‹™éŒ¯èª¤");
                        
                        const results = await response.json();
                        return results;

                    } catch (error) {
                        console.error("Geocoding æŸ¥è©¢å¤±æ•—:", error);
                        return [];
                    }
                };

                const plotPlannedLocations = async (shouldAlert = true) => {
                    if (!map) return; 
                    
                    tripMarkers.clearLayers(); // æ¸…é™¤ä¸Šæ¬¡çš„è¡Œç¨‹æ¨™è¨˜
                    
                    // å–å¾—ç•¶å‰æ‰€æœ‰åœ°é»ï¼Œä¸¦å»é‡ (å¦‚æœå…©å€‹è¡Œç¨‹æœ‰ç›¸åŒåœ°é»ï¼ŒåªæŸ¥ä¸€æ¬¡åº§æ¨™)
                    const locationsToGeocode = currentDay.value.items
                        .map(item => ({ location: item.location, activity: item.activity, type: item.type }))
                        .filter(item => item.location && item.location.trim())
                        .reduce((acc, item) => {
                            if (!acc.some(existing => existing.location === item.location)) {
                                acc.push(item);
                            }
                            return acc;
                        }, []);
                        
                    if (locationsToGeocode.length === 0) {
                        if (shouldAlert) showAlert("ç•¶å¤©è¡Œç¨‹æ²’æœ‰å¯ä»¥å®šä½çš„åœ°é»é—œéµå­—ï¼");
                        return;
                    }

                    loading.value = true;
                    let bounds = [];
                    let locationsFound = 0;
                    
                    // ç”¨æ–¼ç·©å­˜å·²æŸ¥è©¢çš„åº§æ¨™
                    const geocodeCache = {};

                    for (const item of locationsToGeocode) {
                        let results = [];
                        
                        if (geocodeCache[item.location]) {
                            results = geocodeCache[item.location];
                        } else {
                            results = await geocodeLocation(item.location);
                            geocodeCache[item.location] = results;
                        }
                        
                        if (results && results.length > 0) {
                            const firstResult = results[0];
                            const lat = parseFloat(firstResult.lat);
                            const lng = parseFloat(firstResult.lon);
                            
                            const popupContent = `
                                <div class="font-sans text-sm p-1">
                                    <p class="font-bold text-teal-600">${item.activity || 'åœ°é»'}</p>
                                    <p class="text-xs text-slate-500">${item.location}</p>
                                </div>
                            `;
                            
                            const colorClass = getTypeColor(item.type).replace('bg-', '');
                            const markerHtml = `<div class="p-1 rounded-full text-white shadow-md bg-${colorClass}"><i class="ph-bold ph-map-pin-line text-lg"></i></div>`;
                            const customIcon = L.divIcon({ html: markerHtml, className: '', iconSize: [24, 24], iconAnchor: [12, 24] });

                            L.marker([lat, lng], {icon: customIcon})
                                .bindPopup(popupContent)
                                .addTo(tripMarkers);
                            
                            bounds.push([lat, lng]);
                            locationsFound++;
                        }
                    }
                    
                    loading.value = false;
                    
                    if (bounds.length > 0) {
                        map.fitBounds(bounds, { padding: [50, 50] });
                        if (shouldAlert) showAlert(`æˆåŠŸåœ¨åœ°åœ–ä¸Šæ¨™è¨˜äº† ${locationsFound} å€‹è¡Œç¨‹åœ°é»ï¼`);
                    } else {
                        if (shouldAlert) showAlert("æŠ±æ­‰ï¼Œç„¡æ³•åœ¨åœ°åœ–ä¸Šæ‰¾åˆ°ä»»ä½•è¡Œç¨‹åœ°é»çš„åº§æ¨™ã€‚è«‹å˜—è©¦ä½¿ç”¨æ›´ç²¾ç¢ºçš„è‹±æ–‡é—œéµå­—ã€‚");
                    }
                };
                
                const performMapSearch = async () => {
                    if (!mapSearchQuery.value) return;
                    if (!map) initMap();
                    
                    loading.value = true;
                    geocodingMarkers.clearLayers(); 
                    
                    const results = await geocodeLocation(mapSearchQuery.value);
                    
                    if (results && results.length > 0) {
                        const firstResult = results[0];
                        const lat = parseFloat(firstResult.lat);
                        const lng = parseFloat(firstResult.lon);
                        
                        map.flyTo([lat, lng], 16);

                        const markerHtml = `<div class="p-1 rounded-full text-white shadow-md bg-pink-500"><i class="ph-bold ph-magnifying-glass-plus text-lg"></i></div>`;
                        const customIcon = L.divIcon({ html: markerHtml, className: '', iconSize: [24, 24], iconAnchor: [12, 24] });

                        L.marker([lat, lng], {icon: customIcon})
                            .bindPopup(`<div class="font-sans text-sm p-1"><p class="font-bold">${firstResult.display_name}</p></div>`)
                            .openPopup()
                            .addTo(geocodingMarkers);

                        showAlert(`å·²æ‰¾åˆ°ä¸¦æ¨™è¨˜ "${mapSearchQuery.value}" çš„ä½ç½®ã€‚`);
                    } else {
                        showAlert(`æ‰¾ä¸åˆ° "${mapSearchQuery.value}" çš„åº§æ¨™ã€‚è«‹å˜—è©¦ä½¿ç”¨æ›´ç²¾ç¢ºçš„è‹±æ–‡é—œéµå­—ï¼`);
                    }
                    loading.value = false;
                }

                // --- ç›£è½å™¨èˆ‡ç”Ÿå‘½é€±æœŸ ---
                
                // ç›£è½å™¨ 1: åˆ‡æ›åˆ°åœ°åœ–æ¨¡å¼æ™‚ï¼Œåˆå§‹åŒ–åœ°åœ–ä¸¦ç¹ªè£½åœ°é» (å·²ä¿®å¾©)
                watch(viewMode, (v) => { 
                    if(v==='map') nextTick(() => {
                        initMap();
                        // ç¢ºä¿åœ°åœ–åˆå§‹åŒ–å¾Œï¼Œç«‹å³ç¹ªè£½è¡Œç¨‹åœ°é»
                        plotPlannedLocations(false);
                    }); 
                });
                
                // ç›£è½å™¨ 2: è¡Œç¨‹å…§å®¹æˆ–æ—¥æœŸæ”¹è®Šæ™‚ï¼Œé‡æ–°ç¹ªè£½åœ°åœ–
                watch(plottingKey, (newKey) => {
                    // åªæœ‰åœ¨åœ°åœ–æ¨¡å¼ä¸”åœ°åœ–å·²åˆå§‹åŒ–æ™‚æ‰åŸ·è¡Œç¹ªè£½
                    if (viewMode.value === 'map' && map) {
                        // çµ¦ Leaflet ä¸€é»æ™‚é–“è™•ç†å¯èƒ½çš„ DOM è®Šå‹•
                        setTimeout(() => {
                            if (map) {
                                 map.invalidateSize(); 
                                 plotPlannedLocations(false);
                            }
                        }, 50); 
                    }
                }, { immediate: false }); // é¿å…åœ¨åˆå§‹åŒ–æ™‚é‹è¡Œï¼Œç”± watch(viewMode) è™•ç†

                // ç›£è½å™¨ 3: æ¯æ—¥ç´¢å¼•æ”¹è®Šæ™‚ï¼Œä¹Ÿæœƒè§¸ç™¼ plottingKey è®Šå‹•ï¼Œè‡ªå‹•æ›´æ–°åœ°åœ–
                watch(currentDayIdx, () => {
                    if (viewMode.value === 'map') {
                        // åªéœ€è¦ç¢ºä¿ viewMode ç›£è½å™¨æœƒè™•ç†å®ƒ
                        if (map) {
                             plotPlannedLocations(false);
                        }
                    }
                });


                onMounted(() => { 
                    if (roomId.value) { 
                        showRoomModal.value = false; 
                        connectToFirebase(); 
                    } else {
                         showRoomModal.value = true;
                    }
                });

                return {
                    viewMode, currentTrip, currentDayIdx, days, currentDay, expenses, totalExpense, newExpense,
                    loading, isConnected, showRoomModal, inputRoomId, roomId, isLocating, alertMessage, confirmPrompt,
                    showFlightDetails, 
                    // åœ°åœ–æœå°‹ç›¸é—œ
                    mapSearchQuery, performMapSearch, plotPlannedLocations,
                    // å¸¸ç”¨å‡½æ•¸
                    createNewRoom, joinRoom, copyShareLink, addDay, addItem, removeCurrentDay: confirmAndDeleteDay, addExpense, 
                    getTypeColor, initMap, locateUser, formatDate, closeAlert, confirmProceed, confirmCancel, confirmAndDeleteItem,
                    updateTwdFee, startNewTrip,
                };
            }
        }).mount('#app');
    </script>
</body>
</html>


