<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="apple-touch-icon" href="/lisboagogo/apple-touch-icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‘¡è±¬è±¬æ—…éŠè¨ˆç•« | æ™ºæ…§æç¤ºç‰ˆ</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F0FDF4; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; } 
        .sync-pulse { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .gps-marker {
            background-color: #3b82f6; border: 2px solid white; border-radius: 50%;
            width: 16px; height: 16px; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.6); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* éŒ¯èª¤æç¤ºå½ˆå‡ºå‹•ç•« */
        .slide-down-enter-active, .slide-down-leave-active { transition: all 0.3s ease-out; }
        .slide-down-enter-from, .slide-down-leave-to { transform: translateY(-100%); opacity: 0; }
        
        input:focus, select:focus { outline: none; }
    </style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden fixed inset-0">

    <div id="app" class="flex flex-col h-full max-w-md mx-auto w-full bg-white shadow-2xl relative sm:border-x sm:border-slate-200">

        <!-- Header -->
        <header class="bg-teal-600 text-white shrink-0 z-20 shadow-md transition-all duration-300">
            <div class="p-4 flex justify-between items-start">
                <div class="flex flex-col min-w-0 flex-1 mr-2">
                    <div class="flex items-center gap-2 mb-1">
                         <div v-if="isConnected" class="w-2.5 h-2.5 bg-green-400 rounded-full sync-pulse border border-white" title="å·²é€£ç·š"></div>
                         <div v-else class="w-2.5 h-2.5 bg-red-400 rounded-full border border-white" title="é›¢ç·š/å„²å­˜ä¸­"></div>
                         <input v-model="currentTrip.destination" class="bg-transparent border-none text-lg font-bold text-white placeholder-teal-200 w-full p-0 focus:ring-0 truncate leading-tight" placeholder="æ—…ç¨‹åç¨±...">
                    </div>
                    <button @click="copyShareLink" class="text-[10px] bg-teal-800/40 px-2 py-0.5 rounded text-teal-100 self-start flex items-center gap-1">
                        <i class="ph-bold ph-users"></i> ID: {{ roomId }} (è¤‡è£½)
                    </button>
                </div>
                <div class="text-right shrink-0">
                    <div class="flex items-center justify-end gap-1 text-white">
                        <i :class="['ph-duotone', weatherDisplay.icon, 'text-xl']"></i>
                        <span class="text-lg font-bold font-mono">{{ weatherDisplay.temp }}</span>
                    </div>
                    <div class="text-[10px] text-teal-100 flex items-center gap-1 justify-end mt-0.5 opacity-80">{{ weatherDisplay.label }}</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="px-2 pb-2 flex justify-between items-center gap-1">
                <div class="flex bg-teal-800/30 p-1 rounded-lg flex-1 mr-2">
                    <button @click="viewMode = 'plan'" :class="viewMode === 'plan' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200 hover:text-white'" class="flex-1 p-1.5 rounded-md transition-all flex justify-center items-center gap-1 text-xs font-bold"><i class="ph-bold ph-calendar-check"></i> è¡Œç¨‹</button>
                    <button @click="viewMode = 'map'" :class="viewMode === 'map' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200 hover:text-white'" class="flex-1 p-1.5 rounded-md transition-all flex justify-center items-center gap-1 text-xs font-bold"><i class="ph-bold ph-map-trifold"></i> åœ°åœ–</button>
                    <button @click="viewMode = 'money'" :class="viewMode === 'money' ? 'bg-white text-teal-700 shadow-sm' : 'text-teal-200 hover:text-white'" class="flex-1 p-1.5 rounded-md transition-all flex justify-center items-center gap-1 text-xs font-bold"><i class="ph-bold ph-coins"></i> åˆ†å¸³</button>
                </div>
                <button @click="viewMode = 'translate'" :class="viewMode === 'translate' ? 'bg-white text-teal-700' : 'bg-teal-800/30 text-teal-200'" class="p-2 rounded-lg transition-all h-9 w-9 flex items-center justify-center">
                    <i class="ph-bold ph-translate text-lg"></i>
                </button>
            </div>

            <div v-if="viewMode === 'plan' && days.length > 0" class="flex overflow-x-auto hide-scroll px-2 pb-3 space-x-2 snap-x items-center bg-teal-600/10 pt-1 border-t border-white/10">
                <div v-for="(day, index) in days" :key="index" @click="currentDayIdx = index" class="snap-center shrink-0 flex flex-col items-center justify-center w-12 h-14 rounded-xl cursor-pointer transition-all border-2 relative overflow-hidden" :class="currentDayIdx === index ? 'bg-white text-teal-600 border-white shadow-md scale-105' : 'bg-teal-700/20 border-transparent text-teal-100 hover:bg-teal-700/40'">
                    <span class="text-[10px] font-medium opacity-80">Day</span>
                    <span class="text-sm font-black">{{ index + 1 }}</span>
                </div>
                <button @click="addDay" class="shrink-0 w-10 h-14 rounded-xl flex items-center justify-center border-2 border-teal-300/50 border-dashed text-teal-200 hover:text-white hover:border-white transition"><i class="ph-bold ph-plus"></i></button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto bg-slate-50 relative hide-scroll">
            
            <div v-if="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 backdrop-blur-sm z-50">
                <i class="ph-duotone ph-spinner animate-spin text-4xl text-teal-500 mb-3"></i>
                <p class="text-sm font-medium text-slate-500">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</p>
            </div>

            <!-- 1. è¡Œç¨‹è¡¨ View -->
            <div v-show="viewMode === 'plan' && !loading" class="p-4 pb-32">
                <div class="bg-white p-3 rounded-xl shadow-sm mb-4 border border-slate-100 flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <i class="ph-bold ph-calendar-blank text-teal-500"></i>
                            <input type="date" v-model="currentDay.fullDate" class="text-xs text-slate-500 bg-transparent border-none p-0">
                        </div>
                        <input v-model="currentDay.title" class="text-base font-bold w-full border-none p-0 placeholder-slate-300 bg-transparent" placeholder="ç•¶æ—¥ä¸»é¡Œ (ä¾‹å¦‚: æ³¢å¤šä¸€æ—¥éŠ)">
                    </div>
                </div>

                <!-- èˆªç­å¡ç‰‡ -->
                <div class="mb-6">
                    <div v-if="currentDay.flight" class="relative bg-gradient-to-r from-blue-600 to-teal-500 rounded-2xl text-white shadow-lg overflow-hidden">
                        <div class="absolute -left-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-50 rounded-full z-10"></div>
                        <div class="absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-50 rounded-full z-10"></div>
                        <button @click="toggleFlightCard" class="absolute top-2 right-2 text-white/40 hover:text-white hover:bg-white/20 rounded-full p-1 z-20"><i class="ph-bold ph-x"></i></button>
                        <div class="p-4 relative z-0">
                            <div class="flex justify-between items-center mb-1 pt-2">
                                <div class="flex flex-col items-center w-1/3">
                                    <input v-model="currentDay.flight.startTime" type="time" class="text-2xl font-black bg-transparent border-b border-white/30 w-full text-center text-white focus:border-white font-mono p-0">
                                    <div class="text-[9px] opacity-60 mt-1">èµ·é£›</div>
                                    <input v-model="currentDay.flight.startAirport" class="text-sm font-bold bg-transparent border-none text-center w-full text-teal-100 uppercase p-0" placeholder="TPE">
                                </div>
                                <div class="flex flex-col items-center justify-center w-1/3 px-2">
                                    <i class="ph-fill ph-airplane text-2xl mb-1 transform rotate-90"></i>
                                    <input v-model="currentDay.flight.number" class="text-[10px] font-mono tracking-widest opacity-80 bg-transparent border-none text-center w-full text-white uppercase p-0" placeholder="BR198">
                                </div>
                                <div class="flex flex-col items-center w-1/3">
                                    <input v-model="currentDay.flight.endTime" type="time" class="text-2xl font-black bg-transparent border-b border-white/30 w-full text-center text-white focus:border-white font-mono p-0">
                                    <div class="relative w-full mt-0.5">
                                        <select v-model="currentDay.flight.arrivalOffset" class="appearance-none bg-black/20 text-white text-[9px] rounded border-none w-full py-0.5 px-1 text-center cursor-pointer">
                                            <option value="0" class="text-slate-800">åŒæ—¥</option>
                                            <option value="1" class="text-slate-800">+1å¤©</option>
                                        </select>
                                    </div>
                                    <input v-model="currentDay.flight.endAirport" class="text-sm font-bold bg-transparent border-none text-center w-full text-teal-100 uppercase p-0" placeholder="LIS">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button v-else @click="toggleFlightCard" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 hover:border-teal-400 hover:text-teal-500 hover:bg-teal-50/50 transition flex items-center justify-center gap-2 group">
                        <i class="ph-bold ph-airplane-tilt text-lg group-hover:scale-110 transition-transform"></i> <span class="text-sm font-bold">æ–°å¢ç•¶æ—¥èˆªç­è³‡è¨Š</span>
                    </button>
                </div>

                <!-- è¡Œç¨‹åˆ—è¡¨ -->
                <div class="relative pl-4 border-l-2 border-teal-100 space-y-4 ml-1">
                    <div v-for="(item, idx) in currentDay.items" :key="idx" class="relative group">
                        <div class="absolute -left-[23px] top-4 w-4 h-4 rounded-full border-2 border-white shadow-sm z-10" :class="getTypeColor(item.type)"></div>
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-all">
                            <div class="flex items-start gap-2">
                                <div class="flex flex-col items-center w-16 shrink-0 gap-1">
                                    <input v-model="item.time" type="time" class="text-sm font-black bg-slate-100 rounded px-1 w-full text-center border-none text-slate-600">
                                    <select v-model="item.type" class="text-[10px] w-full bg-transparent border-none text-center p-0 cursor-pointer text-slate-400">
                                        <option value="spot">ğŸ“ æ™¯é»</option>
                                        <option value="food">ğŸ´ ç¾é£Ÿ</option>
                                        <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                                        <option value="transport">ğŸš‡ äº¤é€š</option>
                                        <option value="hotel">ğŸ¨ ä½å®¿</option>
                                    </select>
                                </div>
                                <div class="flex-1 min-w-0 space-y-1 pt-1">
                                    <input v-model="item.activity" class="w-full font-bold text-sm border-none p-0 text-slate-800 placeholder-slate-300 bg-transparent" placeholder="è¡Œç¨‹åç¨±">
                                    <div class="flex items-center gap-1 bg-slate-50 rounded px-1.5 py-1" :class="{'border border-teal-200': item.lat, 'border border-red-200 bg-red-50': item.searchStatus === 'failed'}">
                                         <!-- ç‹€æ…‹åœ–ç¤ºï¼šæˆåŠŸ=ç¶ , å¤±æ•—=ç´…, æœªçŸ¥=ç° -->
                                         <i v-if="item.lat" class="ph-bold ph-check-circle text-teal-500 text-xs" title="å·²å®šä½"></i>
                                         <i v-else-if="item.searchStatus === 'failed'" class="ph-bold ph-warning-circle text-red-500 text-xs" title="æ‰¾ä¸åˆ°"></i>
                                         <i v-else class="ph-fill ph-map-pin text-xs text-slate-300"></i>
                                         
                                         <input v-model="item.location" @change="markLocationDirty(item)" class="flex-1 text-xs text-slate-600 border-none p-0 bg-transparent truncate" :class="{'text-red-500': item.searchStatus === 'failed'}" placeholder="è¼¸å…¥åœ°é» (ä¾‹å¦‚: è–èƒ¡æ–¯å¡”é›»æ¢¯)">
                                    </div>
                                    <input v-model="item.note" class="w-full text-[10px] bg-orange-50 text-orange-600 px-1.5 py-0.5 rounded border-none placeholder-orange-300" placeholder="å‚™è¨»...">
                                </div>
                                <button @click="currentDay.items.splice(idx, 1)" class="text-slate-200 hover:text-red-400 p-1"><i class="ph-bold ph-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    <button @click="addItem" class="w-full py-3 border-2 border-dashed border-teal-200 rounded-xl text-teal-400 font-bold text-sm hover:bg-teal-50 flex items-center justify-center gap-2">
                        <i class="ph-bold ph-plus-circle"></i> æ–°å¢è¡Œç¨‹
                    </button>
                </div>
            </div>

            <!-- 2. åœ°åœ– View (åŒ…å«æ™ºæ…§æç¤º) -->
            <div v-show="viewMode === 'map'" class="h-full flex flex-col relative text-center">
                <!-- éŒ¯èª¤é€šçŸ¥è¦–çª— -->
                <transition name="slide-down">
                    <div v-if="errorMsg" class="absolute top-0 left-0 right-0 bg-red-500 text-white z-[2000] p-3 text-left shadow-lg">
                        <div class="flex justify-between items-start">
                             <div class="flex gap-2">
                                <i class="ph-bold ph-warning text-xl shrink-0 mt-0.5"></i>
                                <div class="text-xs">
                                    <p class="font-bold mb-1 text-sm">æ‰¾ä¸åˆ°ä»¥ä¸‹åœ°é»ï¼š</p>
                                    <p>{{ errorMsg }}</p>
                                    <p class="mt-1 opacity-80 text-[10px]">ğŸ’¡ å»ºè­°ï¼šè©¦è‘—ç¸®çŸ­é—œéµå­— (å¦‚: "è‘¡è„ç‰™é‡Œæ–¯æœ¬è²å€«å¡”" æ”¹ç‚º "è²å€«å¡”")</p>
                                </div>
                             </div>
                             <button @click="errorMsg = ''" class="text-white/80 hover:text-white"><i class="ph-bold ph-x text-lg"></i></button>
                        </div>
                    </div>
                </transition>

                <div id="map" class="flex-1 w-full h-full bg-slate-100 z-0"></div>
                
                <div v-if="isGeocoding" class="absolute top-16 left-1/2 -translate-x-1/2 bg-white/90 px-4 py-2 rounded-full shadow-lg z-[1000] text-xs font-bold text-teal-600 flex items-center gap-2 border border-teal-100">
                    <i class="ph-bold ph-spinner animate-spin"></i> æ­£åœ¨å°‹æ‰¾åœ°é» ({{ geocodeProgress }})...
                </div>
                
                <div class="absolute bottom-6 left-4 right-4 z-[1000] flex gap-2 justify-center">
                    <button @click="locateUser" class="bg-blue-600 text-white px-4 py-2.5 rounded-full shadow-xl font-bold text-sm flex items-center gap-2 active:scale-95 transition hover:bg-blue-700">
                        <i v-if="isLocating" class="ph-bold ph-spinner animate-spin"></i><i v-else class="ph-bold ph-crosshair"></i> {{ isLocating ? 'å®šä½ä¸­...' : 'æˆ‘çš„ä½ç½®' }}
                    </button>
                    <button @click="initMap" class="bg-white text-slate-600 px-4 py-2.5 rounded-full shadow-xl font-bold text-sm flex items-center gap-2 active:scale-95 transition"><i class="ph-bold ph-arrows-clockwise"></i> é‡æ•´åœ°åœ–</button>
                </div>
            </div>

            <!-- 3. åˆ†å¸³ View -->
            <div v-show="viewMode === 'money'" class="p-4 pb-32">
                 <!-- (åŒä¹‹å‰ç‰ˆæœ¬ï¼Œçœç•¥é‡è¤‡ä»£ç¢¼ä¿æŒæ¸…çˆ½) -->
                 <div class="bg-slate-800 text-white rounded-2xl p-6 shadow-lg mb-4 text-center relative overflow-hidden"><div class="relative z-10"><div class="text-xs text-slate-400 mb-1">ç¸½æ”¯å‡º Total Expense</div><div class="text-3xl font-bold font-mono tracking-tight">NT$ {{ totalExpense.toLocaleString() }}</div></div><i class="ph-duotone ph-coins absolute -right-6 -bottom-6 text-8xl text-white/5 rotate-12"></i></div><div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 mb-6"><div class="text-xs font-bold text-slate-400 mb-2 ml-1">å¿«é€Ÿè¨˜å¸³</div><div class="flex gap-2 mb-2"><input v-model="newExpense.item" placeholder="é …ç›®" class="flex-[2] bg-slate-100 border-none rounded-lg px-3 py-2 text-sm"><input v-model="newExpense.payer" placeholder="èª°ä»˜?" class="flex-1 bg-slate-100 border-none rounded-lg px-3 py-2 text-sm text-center"></div><div class="flex gap-2"><input v-model.number="newExpense.amount" type="number" placeholder="é‡‘é¡" class="flex-1 bg-slate-100 border-none rounded-lg pl-3 pr-3 py-2 text-sm font-mono"><button @click="addExpense" class="bg-teal-600 text-white rounded-lg px-4 py-2 font-bold text-sm hover:bg-teal-700"><i class="ph-bold ph-plus"></i></button></div></div><div v-if="expenses.length > 0" class="space-y-2"><div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-xs font-bold">{{ exp.payer ? exp.payer[0] : '?' }}</div><div class="flex flex-col"><span class="font-bold text-slate-700 text-sm">{{ exp.item }}</span><span class="text-[10px] text-slate-400">{{ exp.date }}</span></div></div><div class="flex items-center gap-3"><span class="font-bold font-mono text-slate-700">NT$ {{ exp.amount }}</span><button @click="expenses.splice(idx, 1)" class="text-slate-300 hover:text-red-400"><i class="ph-bold ph-x"></i></button></div></div></div>
            </div>

            <!-- 4. ç¿»è­¯ View -->
            <div v-show="viewMode === 'translate'" class="p-6 h-full flex flex-col items-center pb-32 overflow-y-auto">
                 <div class="text-center mb-8 mt-4"><h2 class="text-2xl font-bold text-slate-800 mb-2">ç¿»è­¯å·¥å…·ç®±</h2><p class="text-sm text-slate-400">é¸æ“‡ç¿»è­¯æ¨¡å¼</p></div><div class="w-full space-y-4"><a href="https://translate.google.com/?op=images" target="_blank" class="block w-full group"><div class="bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-2xl p-6 shadow-lg relative overflow-hidden"><div class="relative z-10 flex items-center justify-between"><div><div class="text-xs opacity-80 mb-1">ç›¸æ©Ÿ</div><div class="text-xl font-bold">ğŸ“· ç…§ç›¸ç¿»è­¯</div></div><i class="ph-bold ph-camera text-3xl opacity-60"></i></div></div></a><a href="https://translate.google.com/?sl=zh-TW&tl=pt&op=translate" target="_blank" class="block w-full group"><div class="bg-gradient-to-br from-indigo-500 to-blue-600 text-white rounded-2xl p-6 shadow-lg relative overflow-hidden"><div class="relative z-10 flex items-center justify-between"><div><div class="text-xs opacity-80 mb-1">ä¸­æ–‡ -> è‘¡æ–‡</div><div class="text-xl font-bold">ğŸ—£ï¸ å°è©±ç¿»è­¯</div></div><i class="ph-bold ph-microphone text-3xl opacity-60"></i></div></div></a></div>
            </div>
        </main>

        <!-- ç™»å…¥é  -->
        <div v-if="showRoomModal" class="fixed inset-0 bg-slate-900/80 z-[999] flex items-center justify-center p-6 backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-8 w-full max-w-sm text-center shadow-2xl">
                <div class="w-20 h-20 bg-teal-50 rounded-full flex items-center justify-center mx-auto mb-6"><i class="ph-duotone ph-airplane-tilt text-4xl text-teal-600"></i></div>
                <h2 class="text-2xl font-black text-slate-800 mb-2">è‘¡è±¬è±¬æ—…éŠè¨ˆç•«</h2>
                <div class="space-y-3">
                    <input v-model="inputRoomId" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-center font-mono text-lg uppercase placeholder-slate-400" placeholder="è¼¸å…¥æˆ¿é–“ ID">
                    <button @click="joinRoom" class="w-full bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg">é€²å…¥è¡Œç¨‹</button>
                    <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-slate-200"></div><span class="flex-shrink mx-4 text-slate-300 text-xs">æˆ–</span><div class="flex-grow border-t border-slate-200"></div></div>
                    <button @click="createNewRoom" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg">å»ºç«‹æ–°è¡Œç¨‹</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createApp, ref, reactive, watch, computed, nextTick, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref as dbRef, onValue, set } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC_mIkGuJCMKAcoRf78bipUJzzodTk_zVs",
            authDomain: "lisboaaa-2c65b.firebaseapp.com",
            databaseURL: "https://lisboaaa-2c65b-default-rtdb.firebaseio.com",
            projectId: "lisboaaa-2c65b",
            storageBucket: "lisboaaa-2c65b.firebasestorage.app",
            messagingSenderId: "391483387676",
            appId: "1:391483387676:web:d527043aee656dfc5854d9",
            measurementId: "G-NPDLH60580"
        };

        const fbApp = initializeApp(firebaseConfig);
        const db = getDatabase(fbApp);

        createApp({
            setup() {
                const viewMode = ref('plan');
                const currentDayIdx = ref(0);
                const isConnected = ref(false);
                const loading = ref(false);
                const showRoomModal = ref(true);
                const inputRoomId = ref('');
                const roomId = ref(new URLSearchParams(window.location.search).get('room'));
                const isLocating = ref(false);
                const isGeocoding = ref(false); 
                const geocodeProgress = ref('0/0'); // é¡¯ç¤ºé€²åº¦
                const errorMsg = ref(''); // éŒ¯èª¤è¨Šæ¯

                const defaultTrip = { destination: 'æ–°æ—…ç¨‹', days: [{ fullDate: new Date().toISOString().split('T')[0], title: '', items: [], flight: null }], expenses: [] };
                const currentTrip = ref(JSON.parse(JSON.stringify(defaultTrip)));
                const isRemoteUpdate = ref(false);

                const days = computed(() => currentTrip.value.days || []);
                const currentDay = computed(() => days.value[currentDayIdx.value] || {});
                const expenses = computed(() => currentTrip.value.expenses || []);
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (Number(item.amount) || 0), 0));
                const newExpense = reactive({ item: '', amount: null, payer: '' });
                const weatherDisplay = computed(() => ({ temp: '18Â°C', icon: 'ph-cloud-sun', label: 'è‘¡è„ç‰™ (Portugal)' }));

                // Firebase
                const connectToFirebase = () => {
                    if (!roomId.value) return;
                    loading.value = true;
                    const tripRef = dbRef(db, 'trips/' + roomId.value);
                    onValue(tripRef, (snapshot) => {
                        isConnected.value = true;
                        const val = snapshot.val();
                        isRemoteUpdate.value = true;
                        if (val) {
                            if(!val.days) val.days = [];
                            if(!val.expenses) val.expenses = [];
                            val.days.forEach(d => { if(d.flight === undefined) d.flight = null; });
                            currentTrip.value = val;
                        } else {
                            set(tripRef, defaultTrip);
                            currentTrip.value = JSON.parse(JSON.stringify(defaultTrip));
                        }
                        loading.value = false;
                        nextTick(() => isRemoteUpdate.value = false);
                    });
                };
                watch(currentTrip, (newVal) => {
                    if (roomId.value && !loading.value && !isRemoteUpdate.value) {
                        const tripRef = dbRef(db, 'trips/' + roomId.value);
                        set(tripRef, newVal).catch(e => console.error(e));
                    }
                }, { deep: true });

                const createNewRoom = () => { roomId.value = Math.random().toString(36).substr(2, 6).toUpperCase(); finalizeJoin(); };
                const joinRoom = () => { if(!inputRoomId.value.trim()) return; roomId.value = inputRoomId.value.trim().toUpperCase(); finalizeJoin(); };
                const finalizeJoin = () => { const url = new URL(window.location); url.searchParams.set('room', roomId.value); window.history.pushState({}, '', url); showRoomModal.value = false; connectToFirebase(); };
                const copyShareLink = () => { navigator.clipboard.writeText(window.location.href); alert("å·²è¤‡è£½ï¼"); };
                const addDay = () => { const last = days.value[days.value.length-1]; const next = new Date(last ? last.fullDate : new Date()); if(last) next.setDate(next.getDate() + 1); days.value.push({ fullDate: next.toISOString().split('T')[0], title: '', items: [], flight: null }); currentDayIdx.value = days.value.length - 1; };
                const addItem = () => { if(!currentDay.value.items) currentDay.value.items = []; currentDay.value.items.push({ time: '', type: 'spot', activity: '', location: '', note: '' }); };
                const removeCurrentDay = () => { if(days.value.length<=1) return alert('ä¸å¯å…¨åˆª'); if(confirm('åˆªé™¤?')) { days.value.splice(currentDayIdx.value, 1); currentDayIdx.value = Math.max(0, currentDayIdx.value - 1); } }
                const addExpense = () => { if(newExpense.item && newExpense.amount) { expenses.value.unshift({ ...newExpense, date: new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'}) }); newExpense.item = ''; newExpense.amount = null; } };
                const getTypeColor = (type) => ({ spot: 'bg-teal-500', food: 'bg-orange-500', shop: 'bg-purple-500', transport: 'bg-blue-500', hotel: 'bg-indigo-500' })[type] || 'bg-slate-400';
                const toggleFlightCard = () => { if (currentDay.value.flight) { currentDay.value.flight = null; } else { currentDay.value.flight = { startTime: '10:00', startAirport: 'TPE', endTime: '14:00', endAirport: 'LIS', number: '', arrivalOffset: 0 }; } };

                // Map & Geocoding Logic
                const markLocationDirty = (item) => { 
                    item.lat = null; 
                    item.lng = null; 
                    item.searchStatus = 'pending'; // ç‹€æ…‹é‡ç½®
                };
                
                const fetchCoordinates = async (query) => {
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                        const data = await response.json();
                        if (data && data.length > 0) return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                    } catch (e) { console.error("Geocoding failed", e); }
                    return null;
                };

                let map = null; let userMarker = null;
                const initMap = async () => {
                    if (map) { map.remove(); map = null; }
                    map = L.map('map').setView([38.722, -9.139], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);

                    const items = currentDay.value.items || [];
                    const bounds = [];
                    const itemsToSearch = [];
                    
                    // 1. å…ˆç•«ç¾æœ‰çš„ï¼Œä¸¦æ”¶é›†éœ€è¦æœå°‹çš„
                    items.forEach((item, idx) => {
                        if (item.lat && item.lng) {
                            L.marker([item.lat, item.lng]).addTo(map).bindPopup(`<b>${idx+1}. ${item.activity}</b><br>${item.location}`);
                            bounds.push([item.lat, item.lng]);
                        } else if (item.location && item.searchStatus !== 'failed') { // å¤±æ•—éçš„ä¸è¦ä¸€ç›´é‡è©¦ï¼Œé™¤éä¿®æ”¹éæ–‡å­—
                             itemsToSearch.push({item, idx});
                        }
                    });

                    // 2. è™•ç†æœå°‹
                    if (itemsToSearch.length > 0) {
                        isGeocoding.value = true;
                        errorMsg.value = ''; // æ¸…ç©ºèˆŠéŒ¯èª¤
                        const failedNames = [];
                        
                        for (let i = 0; i < itemsToSearch.length; i++) {
                            geocodeProgress.value = `${i+1}/${itemsToSearch.length}`;
                            const { item, idx } = itemsToSearch[i];
                            const coords = await fetchCoordinates(item.location);
                            
                            if (coords) {
                                item.lat = coords.lat;
                                item.lng = coords.lng;
                                item.searchStatus = 'found';
                                L.marker([coords.lat, coords.lng]).addTo(map).bindPopup(`<b>${idx+1}. ${item.activity}</b><br>${item.location}`);
                                bounds.push([coords.lat, coords.lng]);
                            } else {
                                item.searchStatus = 'failed'; // æ¨™è¨˜ç‚ºå¤±æ•—
                                failedNames.push(item.location);
                            }
                            await new Promise(r => setTimeout(r, 800)); // Rate limit
                        }
                        
                        if (failedNames.length > 0) {
                            errorMsg.value = failedNames.join(', '); // é¡¯ç¤ºéŒ¯èª¤æç¤º
                        }
                        isGeocoding.value = false;
                    }

                    if(bounds.length > 0) map.fitBounds(bounds, {padding: [50,50]});
                };

                const locateUser = () => {
                    if (!navigator.geolocation) return alert("ä¸æ”¯æ´å®šä½");
                    isLocating.value = true;
                    navigator.geolocation.getCurrentPosition((pos) => {
                        const { latitude, longitude } = pos.coords;
                        if(!map) initMap();
                        if(userMarker) map.removeLayer(userMarker);
                        const myIcon = L.divIcon({ className: 'gps-marker', iconSize: [16, 16], iconAnchor: [8, 8] });
                        userMarker = L.marker([latitude, longitude], {icon: myIcon}).addTo(map).bindPopup("æˆ‘çš„ä½ç½®").openPopup();
                        map.flyTo([latitude, longitude], 16);
                        isLocating.value = false;
                    }, () => { alert("å®šä½å¤±æ•—"); isLocating.value = false; }, { enableHighAccuracy: true });
                };

                watch(viewMode, (v) => { if(v==='map') nextTick(initMap); });
                onMounted(() => { if (roomId.value) { showRoomModal.value = false; connectToFirebase(); } });

                return {
                    viewMode, currentTrip, currentDayIdx, days, currentDay, expenses, totalExpense, newExpense, weatherDisplay,
                    loading, isConnected, showRoomModal, inputRoomId, roomId, isLocating, 
                    isGeocoding, geocodeProgress, errorMsg, // æ–°å¢çš„ç‹€æ…‹
                    createNewRoom, joinRoom, copyShareLink, addDay, addItem, removeCurrentDay, addExpense, getTypeColor, 
                    initMap, locateUser, toggleFlightCard, markLocationDirty
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
