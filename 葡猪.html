<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="apple-touch-icon" href="/lisboagogo/apple-touch-icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è‘¡è±¬è±¬ä¹‹æ—… V9.4 | é¡å€¼å›æ­¸ç‰ˆ</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Oswald:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        [v-cloak] { display: none !important; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .h-dynamic-screen { height: 100vh; height: 100dvh; }
        
        /* â˜… æ©Ÿç¥¨æ¨£å¼ä¿®å¾© (Boarding Pass Style Fix) */
        .boarding-pass {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); /* æ¼¸å±¤èƒŒæ™¯ */
            color: white;
            z-index: 1;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* æ©Ÿç¥¨ä¸­é–“çš„åˆ‡ç·š */
        .dashed-line { border-top: 2px dashed rgba(255,255,255,0.3); margin: 0; width: 100%; position: absolute; top: 50%; left: 0; z-index: 0; }
        
        /* æ©Ÿç¥¨ä¸­é–“çš„æ‡¸æµ®æ¡† (èˆªç­è™Ÿ) */
        .center-floating-box { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; pointer-events: none; }
        .center-content { pointer-events: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(15, 118, 110, 0.4); padding: 4px 12px; border-radius: 12px; backdrop-filter: blur(2px); border: 1px solid rgba(255,255,255,0.1); }
        
        .flight-no-input { background: transparent; border: none; color: white; width: 90px; text-align: center; font-size: 16px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; padding: 0; margin: 0; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .flight-no-input:focus { outline: none; color: #FEF3C7; }

        .invisible-input { 
            background-color: transparent !important; background: transparent !important;
            border: none; border-bottom: 1px solid rgba(255,255,255,0.3); 
            color: white; width: 30px; text-align: center; font-family: monospace; font-weight: bold; border-radius: 0; padding: 0;
        }
        .invisible-input:focus { outline: none; border-bottom: 1px solid white; background: transparent !important; }

        .weather-font { font-family: 'Oswald', sans-serif; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        
        #map { height: 100%; width: 100%; z-index: 0; position: relative; } 
        .leaflet-top, .leaflet-bottom { z-index: 400 !important; }
        
        input:focus, select:focus, textarea:focus { outline: none; border-color: #10B981 !important; }
        
        .connector-active { background: #F1F5F9; color: #64748B; padding: 6px 0; margin: -4px 4px; border-left: 2px dashed #CBD5E1; border-right: 2px dashed #CBD5E1; cursor: pointer; font-size: 12px; font-weight: bold; text-align: center; }
        .link-btn { background: white; border: 1px solid #E2E8F0; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* é€£çµæŒ‰éˆ• (å¾®å‹ç‰ˆ) */
        .subtle-link-btn { 
            pointer-events: auto;
            color: #94A3B8; background: white; border: 1px solid #E2E8F0; 
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; 
            font-size: 10px; cursor: pointer; transition: all 0.2s; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            z-index: 60;
        }
        .subtle-link-btn:hover { color: #fff; background: #2DD4BF; border-color: #2DD4BF; transform: scale(1.2); }
        
        /* è™›ç·šåˆ†å‰²ç·š (ç¾¤çµ„å…§éƒ¨) */
        .group-divider {
            position: absolute; bottom: 0; left: 16px; right: 16px; height: 1px;
            border-bottom: 1px dashed #E2E8F0;
        }

        /* äº¤é€šæ¢å…¨å¯¬æ¨£å¼ */
        .transport-strip-full {
            width: 100%;
            background-color: #F8FAFC; 
            border-top: 1px dashed #E2E8F0;
            border-bottom: 1px dashed #E2E8F0;
            padding: 4px 8px; /* ä¸€é»é»é«˜å³å¯ */
            display: flex; align-items: center; justify-content: center; 
            color: #64748B; font-size: 11px; font-weight: bold; gap: 8px; 
            z-index: 40; position: relative;
            pointer-events: auto;
        }

        .gps-pulsing-icon {
            width: 20px; height: 20px;
            background-color: #3B82F6;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
            position: relative;
        }
        .gps-pulsing-icon::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 40px; height: 40px;
            background-color: rgba(59, 130, 246, 0.4);
            border-radius: 50%;
            z-index: -1;
            animation: gps-pulse 2s infinite;
        }
        @keyframes gps-pulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        .header-tabs::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-slate-700 h-dynamic-screen flex flex-col overflow-hidden fixed inset-0">

    <div id="app" v-cloak class="flex flex-col h-full max-w-md mx-auto w-full bg-white shadow-2xl sm:border-x sm:border-slate-200 relative">

        <header class="bg-teal-600 text-white shrink-0 z-20 shadow-md relative transition-all duration-300">
            <div class="px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3 flex-1">
                    <button @click="showTripList = true" class="relative group">
                        <i class="ph-bold ph-house text-2xl text-teal-100 group-hover:text-white transition group-active:scale-95"></i>
                        <div v-if="isConnected" class="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-green-400 rounded-full border-2 border-teal-600"></div>
                        <div v-else class="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-red-400 rounded-full border-2 border-teal-600"></div>
                    </button>
                    <input v-model="currentTripName" class="bg-transparent border-b border-transparent hover:border-white/50 focus:border-white text-lg font-bold tracking-wide w-full max-w-[140px] focus:outline-none transition leading-tight truncate" placeholder="æ—…ç¨‹åç¨±">
                </div>
                <div class="flex flex-col items-end text-right">
                    <div class="flex items-center gap-1.5">
                        <i v-if="weather.icon === 'sun'" class="ph-fill ph-sun text-xl text-yellow-300"></i>
                        <i v-else-if="weather.icon === 'cloud'" class="ph-fill ph-cloud text-xl text-white/90"></i>
                        <i v-else-if="weather.icon === 'rain'" class="ph-fill ph-cloud-rain text-xl text-blue-200"></i>
                        <i v-else class="ph-fill ph-cloud-sun text-xl text-white/90"></i>
                        <span class="weather-font text-2xl font-bold leading-none">{{ weather.temp }}Â°C</span>
                    </div>
                    <span class="text-[10px] opacity-80 font-bold uppercase tracking-widest -mt-0.5">Lisbon</span>
                </div>
            </div>
            <div class="px-4 pb-3 flex gap-2 overflow-x-auto header-tabs">
                 <button @click="viewMode='flight'" class="flex-1 py-1.5 rounded-lg text-xs font-bold flex justify-center gap-1 items-center" :class="viewMode==='flight'?'bg-white text-teal-600':'bg-teal-700/30 text-teal-100'"><i class="ph-bold ph-airplane-tilt"></i> èˆªç­</button>
                 <button @click="viewMode='plan'" class="flex-1 py-1.5 rounded-lg text-xs font-bold flex justify-center gap-1 items-center" :class="viewMode==='plan'?'bg-white text-teal-600':'bg-teal-700/30 text-teal-100'"><i class="ph-bold ph-list-dashes"></i> è¡Œç¨‹</button>
                 <button @click="viewMode='map'" class="flex-1 py-1.5 rounded-lg text-xs font-bold flex justify-center gap-1 items-center" :class="viewMode==='map'?'bg-white text-teal-600':'bg-teal-700/30 text-teal-100'"><i class="ph-bold ph-map-trifold"></i> åœ°åœ–</button>
                 <button @click="viewMode='money'" class="flex-1 py-1.5 rounded-lg text-xs font-bold flex justify-center gap-1 items-center" :class="viewMode==='money'?'bg-white text-teal-600':'bg-teal-700/30 text-teal-100'"><i class="ph-bold ph-coins"></i> åˆ†å¸³</button>
            </div>
        </header>

        <!-- æ—…ç¨‹ç®¡ç† Modal -->
        <div v-if="showTripList" class="modal-overlay" @click.self="showTripList = false">
            <div class="bg-white w-11/12 max-w-sm rounded-2xl shadow-2xl p-4 animate__animated animate__zoomIn pointer-events-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2"><i class="ph-fill ph-house text-teal-600"></i> æˆ‘çš„æ—…ç¨‹</h2>
                    <button @click="showTripList = false" class="text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x text-lg"></i></button>
                </div>
                <div class="space-y-2 max-h-60 overflow-y-auto mb-4 hide-scroll pr-1">
                    <div v-for="(t, id) in allTrips" :key="id" @click="switchTrip(id)" class="p-3 rounded-xl border flex justify-between items-center cursor-pointer transition hover:bg-slate-50 group" :class="currentTripId === id ? 'border-teal-500 bg-teal-50 ring-1 ring-teal-500' : 'border-slate-200'">
                        <div class="min-w-0 flex-1"><div class="font-bold text-sm truncate" :class="currentTripId === id ? 'text-teal-700' : 'text-slate-700'">{{ t.name || 'æœªå‘½åæ—…ç¨‹' }}</div><div class="text-[10px] text-slate-400 mt-0.5">ID: {{ id.slice(-4) }}</div></div>
                        <div class="flex items-center gap-2 ml-2 relative z-20">
                            <span v-if="currentTripId === id" class="text-teal-600 text-xs font-bold bg-white px-2 py-0.5 rounded-full shadow-sm shrink-0">ä½¿ç”¨ä¸­</span>
                            <div v-else @click.stop="deleteTrip(id)" class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-100 rounded-full transition cursor-pointer active:scale-95"><i class="ph-bold ph-trash text-lg pointer-events-none"></i></div>
                        </div>
                    </div>
                </div>
                <div class="pt-3 border-t border-slate-100">
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input v-model="newTripNameInput" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:border-teal-500 focus:bg-white transition" placeholder="è¼¸å…¥æ—…ç¨‹åç¨±...">
                        <button @click="createNewTrip" class="bg-teal-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md active:scale-95 transition whitespace-nowrap w-full sm:w-auto flex justify-center items-center gap-1">
                            <i class="ph-bold ph-plus"></i> æ–°å¢
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <main class="flex-1 overflow-y-auto bg-slate-50 relative hide-scroll">
            <div v-if="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-[1000]">
                <i class="ph-duotone ph-spinner-gap animate-spin text-4xl text-teal-500 mb-2"></i><p class="text-xs text-slate-400">{{ loadingText }}</p>
            </div>
            
            <!-- 1. èˆªç­ (â˜… ä¿®å¾©ï¼šæ¢å¾©é«˜é¡å€¼æ¼¸å±¤è¨­è¨ˆ) -->
            <div v-show="viewMode === 'flight'" class="p-4 space-y-0 pb-20">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-6 relative overflow-hidden"><div class="absolute -right-6 -top-6 text-teal-50 opacity-20"><i class="ph-fill ph-airplane-tilt text-9xl"></i></div><h2 class="font-bold text-slate-700 mb-3 text-sm relative z-10">æ–°å¢èˆªç­</h2>
                    <div class="flex gap-2 mb-2 relative z-10"><input v-model="newFlight.dep" placeholder="TPE" class="w-1/2 bg-slate-50 p-2 rounded text-sm uppercase font-bold text-center border-none focus:ring-1 focus:ring-teal-500"><div class="self-center text-slate-300"><i class="ph-bold ph-airplane-tilt"></i></div><input v-model="newFlight.arr" placeholder="HKG" class="w-1/2 bg-slate-50 p-2 rounded text-sm uppercase font-bold text-center border-none focus:ring-1 focus:ring-teal-500"></div>
                    <div class="flex gap-2 items-center mb-3 relative z-10"><div class="flex-[2]"><label class="text-[10px] text-slate-400 block mb-1 pl-1">èµ·é£›</label><input v-model="newFlight.depTime" type="time" class="w-full bg-slate-50 p-2 rounded text-sm border-none"></div><div class="flex-[2]"><label class="text-[10px] text-slate-400 block mb-1 pl-1">æŠµé”</label><input v-model="newFlight.arrTime" type="time" class="w-full bg-slate-50 p-2 rounded text-sm border-none"></div><div class="flex-1"><label class="text-[10px] text-slate-400 block mb-1 pl-1">è·¨æ—¥</label><select v-model="newFlight.nextDay" class="w-full bg-slate-50 p-2 rounded text-sm h-[36px] border-none"><option :value="false">ç„¡</option><option :value="true">+1</option></select></div></div><button @click="addFlight" class="w-full bg-teal-600 text-white py-2 rounded-lg font-bold text-sm shadow-md active:scale-95 transition relative z-10">æ–°å¢è‡³æ­¤æ—…ç¨‹</button>
                </div>
                <template v-for="(flight, index) in sortedFlights" :key="flight.id">
                    <div class="boarding-pass p-5 relative transition-all duration-300" :class="[(flight.connected && index < sortedFlights.length - 1) ? 'rounded-b-none mb-0 bg-teal-700 shadow-none border-b border-white/20 z-0' : 'rounded-b-2xl mb-4 shadow-lg z-10', (index > 0 && sortedFlights[index-1].connected) ? 'rounded-t-none mt-0' : 'rounded-t-2xl mt-0']">
                         <div class="dashed-line"></div>
                         <div class="center-floating-box"><div class="center-content"><i class="ph-fill ph-airplane-tilt text-2xl text-white mb-0.5"></i><input v-model="flight.flightNumber" class="flight-no-input" placeholder="èˆªç­è™Ÿ"></div></div>
                         <div class="flex justify-between items-end mb-6 relative z-0"><div class="text-left w-2/5"><div class="text-3xl font-bold tracking-wider leading-none shadow-sm">{{ flight.dep }}</div><div class="text-[10px] opacity-80 mt-1 pl-1 tracking-widest font-bold">DEPARTURE</div></div><div class="text-right w-2/5"><div class="text-3xl font-bold tracking-wider leading-none shadow-sm">{{ flight.arr }}</div><div class="text-[10px] opacity-80 mt-1 pr-1 tracking-widest font-bold">ARRIVAL</div></div></div>
                        <div class="flex justify-between items-start mt-6 relative z-0"><div class="text-left w-2/5"><div class="text-2xl font-bold font-mono leading-none tracking-tight">{{ flight.depTime }}</div><div class="text-xs font-medium mt-1.5 flex items-center gap-1 opacity-90"><i class="ph-fill ph-door opacity-70"></i> <span>Term.</span><input v-model="flight.depTerminal" class="invisible-input" placeholder="-"></div></div><div class="text-right w-2/5"><div class="flex items-start justify-end"><div class="text-2xl font-bold font-mono leading-none tracking-tight">{{ flight.arrTime }}</div><span v-if="flight.nextDay" class="text-[10px] text-yellow-300 font-black ml-0.5 -mt-1">+1</span></div><div class="text-xs font-medium mt-1.5 flex items-center justify-end gap-1 opacity-90"><i class="ph-fill ph-door opacity-70"></i> <span>Term.</span><input v-model="flight.arrTerminal" class="invisible-input" placeholder="-"></div></div></div><button @click="removeFlight(flight.id)" class="absolute top-3 right-3 text-white/20 hover:text-white transition z-20"><i class="ph-bold ph-trash"></i></button>
                    </div>
                    <div v-if="index < sortedFlights.length - 1"><div v-if="!flight.connected" class="flex justify-center -my-3 relative z-20"><button @click="flight.connected = true" class="link-btn"><i class="ph-bold ph-link text-lg text-slate-400 hover:text-white"></i></button></div><div v-else @click="flight.connected = false" class="connector-active" title="é»æ“Šæ–·é–‹"><div class="flex items-center justify-center gap-2"><span>â€¢</span><i class="ph-fill ph-hourglass-medium text-teal-600"></i><span>è½‰æ©Ÿç­‰å¾… {{ calculateLayover(index) }}</span><span>â€¢</span></div></div></div>
                </template>
            </div>

            <!-- 2. è¡Œç¨‹ (ç¶­æŒ V9.3 ä¿®å¾©å¾Œçš„å®Œç¾æ’ç‰ˆ) -->
            <div v-show="viewMode === 'plan'" class="p-4 pb-20">
                <div v-if="days.length > 0" class="flex overflow-x-auto hide-scroll space-x-2 mb-4"><div v-for="(day, index) in days" :key="index" @click="currentDayIdx = index" class="shrink-0 w-12 h-14 rounded-xl flex flex-col items-center justify-center border-2 cursor-pointer transition" :class="currentDayIdx === index ? 'bg-teal-500 text-white border-teal-500' : 'bg-white border-slate-100 text-slate-400'"><span class="text-[10px] font-bold">D{{ index + 1 }}</span><span class="text-sm font-black">{{ new Date(day.fullDate).getDate() }}</span></div><button @click="addDay" class="shrink-0 w-10 h-14 rounded-xl border-2 border-dashed border-teal-300 text-teal-400 flex items-center justify-center"><i class="ph-bold ph-plus"></i></button></div><div class="bg-white p-3 rounded-xl shadow-sm mb-4 border border-slate-100"><div class="flex justify-between"><input type="date" v-model="currentDay.fullDate" class="text-xs text-slate-400 bg-transparent border-none p-0"><button @click="confirmAndDeleteDay" class="text-slate-300 hover:text-red-400"><i class="ph-bold ph-trash"></i></button></div><input v-model="currentDay.title" class="text-lg font-black w-full border-none p-0 text-slate-700 focus:ring-0" placeholder="è¨­å®šæœ¬æ—¥ä¸»é¡Œ"></div>
                
                <div class="space-y-0 pl-2">
                    <template v-for="(item, idx) in currentDay.items" :key="idx">
                        <div class="p-3 shadow-sm bg-white relative transition hover:shadow-md z-10 flex gap-3"
                             :class="[
                                item.connected || (idx > 0 && currentDay.items[idx-1].connected) 
                                    ? 'border-2 border-dashed border-teal-400/60 shadow-none'
                                    : 'border border-slate-100 rounded-xl mb-5',
                                item.connected ? 'border-b-0 rounded-b-none mb-0' : '',
                                (idx > 0 && currentDay.items[idx-1].connected) ? 'border-t-0 rounded-t-none' : '',
                                (item.connected && (!idx || !currentDay.items[idx-1].connected)) ? 'rounded-t-xl' : '',
                                (!item.connected && (idx > 0 && currentDay.items[idx-1].connected)) ? 'rounded-b-xl mb-5' : ''
                             ]">
                            
                            <div v-if="idx > 0 && currentDay.items[idx-1].connected && !currentDay.items[idx-1].showTransport" class="group-divider"></div>
                            <div class="absolute left-0 top-4 bottom-4 w-1 rounded-r-md" :class="getTypeColor(item.type)"></div>
                            
                            <!-- å·¦å´æ™‚é–“æ¬„ (Layout Fixed) -->
                            <div class="flex flex-col items-center w-20 shrink-0 gap-1 pt-1">
                                <input v-model="item.time" type="time" class="text-xs font-black bg-transparent rounded px-1 w-full text-center border-none p-1 text-slate-600">
                                <select v-model="item.type" class="text-[10px] w-full bg-transparent border border-slate-200 rounded p-1 text-slate-500 font-bold cursor-pointer text-center"><option value="spot">æ™¯é»</option><option value="restaurant">é¤å»³</option><option value="cafe">å’–å•¡</option><option value="shop">è³¼ç‰©</option><option value="transport">äº¤é€š</option><option value="hotel">ä½å®¿</option></select>
                            </div>

                            <!-- å³å´å…§å®¹æ¬„ -->
                            <div class="flex-1 min-w-0 space-y-2">
                                <div class="flex justify-between items-start">
                                    <input v-model="item.activity" class="font-bold text-sm border-none p-0 w-full bg-transparent placeholder-slate-300 focus:ring-0 text-slate-800" placeholder="è¡Œç¨‹åç¨±">
                                    <button @click="deleteItem(idx)" class="text-slate-200 hover:text-red-400 ml-2"><i class="ph-bold ph-x"></i></button>
                                </div>
                                <div class="relative">
                                    <div class="flex items-center gap-1 bg-slate-50 rounded-lg p-1.5 pr-2 border transition-colors" :class="item.error ? 'border-rose-300 bg-rose-50' : 'border-transparent'">
                                        <i :class="item.error ? 'ph-warning-circle text-rose-500' : 'ph-map-pin text-slate-400'" class="ph-bold text-xs ml-1"></i>
                                        <input v-model="item.location" @input="item.error = false" class="w-full bg-transparent border-none p-0 text-xs focus:ring-0 placeholder-slate-400" :class="item.error ? 'text-rose-600' : 'text-slate-700'" placeholder="è¼¸å…¥åœ°é»">
                                    </div>
                                    <div v-if="item.error" class="text-[10px] text-rose-500 mt-1 ml-1 font-bold animate-pulse">âš ï¸ æ‰¾ä¸åˆ°åœ°é»</div>
                                </div>
                                <div class="flex gap-2">
                                    <div class="flex-1 flex items-center gap-1 bg-slate-50 rounded px-2 py-1"><i class="ph-bold ph-ticket text-slate-400 text-xs"></i><input v-model="item.ticket" class="w-full bg-transparent border-none p-0 text-xs focus:ring-0 placeholder-slate-300" placeholder="è²»ç”¨"></div>
                                    <div class="flex-1 flex items-center gap-1 bg-slate-50 rounded px-2 py-1"><i class="ph-bold ph-clock text-slate-400 text-xs"></i><input v-model="item.openTime" class="w-full bg-transparent border-none p-0 text-xs focus:ring-0 placeholder-slate-300" placeholder="æ™‚é–“"></div>
                                </div>
                                <textarea v-model="item.note" rows="3" class="w-full text-xs text-orange-600 bg-orange-50/50 rounded border-none p-1.5 placeholder-orange-300 resize-y focus:ring-0" placeholder="å‚™è¨»..."></textarea>
                            </div>
                            
                            <div v-if="item.connected && idx < currentDay.items.length - 1 && !item.showTransport" class="absolute left-0 right-0 -bottom-2.5 z-50 flex justify-center pointer-events-none">
                                <template v-if="!item.showTransport">
                                    <div @click="item.showTransport = true" class="subtle-link-btn" title="åŠ å…¥äº¤é€š"><i class="ph-bold ph-plus"></i></div>
                                    <div @click="item.connected = false" class="absolute right-2 text-slate-200 hover:text-red-400 cursor-pointer p-1 pointer-events-auto" title="æ–·é–‹é€£çµ"><i class="ph-bold ph-link-break"></i></div>
                                </template>
                            </div>
                        </div>

                        <div v-if="item.connected && item.showTransport && idx < currentDay.items.length - 1">
                             <div class="transport-strip-full animate__animated animate__fadeIn">
                                <i class="ph-fill ph-car-profile text-slate-400"></i>
                                <input v-model="item.transportNote" class="bg-transparent border-none text-[10px] w-full text-center text-slate-600 focus:ring-0 p-0 placeholder-slate-400" placeholder="è¼¸å…¥äº¤é€šæ–¹å¼ (ä¾‹å¦‚: Uber 15åˆ†)">
                                <button @click="item.showTransport = false" class="text-slate-300 hover:text-teal-500 px-1"><i class="ph-bold ph-minus-circle"></i></button>
                                <div class="w-px h-3 bg-slate-200 mx-1"></div>
                                <button @click="item.connected = false" class="text-slate-300 hover:text-red-400 px-1"><i class="ph-bold ph-link-break"></i></button>
                            </div>
                        </div>

                        <div v-if="!item.connected && idx < currentDay.items.length - 1" class="flex justify-center -mt-2.5 mb-2.5 relative z-20 h-4 items-center">
                            <div @click="item.connected = true; item.showTransport = false" class="subtle-link-btn text-slate-300 shadow-sm" title="é€£çµ"><i class="ph-bold ph-link-simple"></i></div>
                        </div>
                    </template>
                </div>
                <button @click="addItem" class="w-full mt-4 py-2 border-2 border-dashed border-teal-200 rounded-xl text-teal-400 font-bold text-xs hover:bg-teal-50">+ æ–°å¢è¡Œç¨‹</button>
            </div>
            
            <!-- 3. åœ°åœ– -->
            <div v-show="viewMode === 'map'" class="h-full flex flex-col relative w-full">
                <div id="map" class="flex-1"></div>
                <div class="absolute top-4 left-0 right-0 z-[5000] flex justify-center pointer-events-none">
                    <div class="bg-white/95 backdrop-blur-sm shadow-lg rounded-full px-1 py-1 flex items-center gap-1 pointer-events-auto border border-white/50 ring-1 ring-black/5">
                        <button @click="prevDay" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:text-teal-600 hover:bg-teal-50 transition" :disabled="currentDayIdx <= 0" :class="{'opacity-30 cursor-not-allowed': currentDayIdx <= 0}"><i class="ph-bold ph-caret-left text-lg"></i></button>
                        <div class="px-2 text-center min-w-[80px]"><div class="text-xs text-slate-400 font-bold uppercase tracking-wider">Day {{ currentDayIdx + 1 }}</div><div class="text-sm font-black text-slate-700 leading-none truncate max-w-[100px]">{{ new Date(currentDay.fullDate).toLocaleDateString(undefined, {month:'numeric', day:'numeric'}) }}</div></div>
                        <button @click="nextDay" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:text-teal-600 hover:bg-teal-50 transition" :disabled="currentDayIdx >= days.length - 1" :class="{'opacity-30 cursor-not-allowed': currentDayIdx >= days.length - 1}"><i class="ph-bold ph-caret-right text-lg"></i></button>
                    </div>
                </div>
                <div class="absolute bottom-6 left-4 right-4 z-[5000] flex justify-center gap-3"><button @click="locateUser" class="bg-slate-800 text-white px-5 py-2.5 rounded-full shadow-xl font-bold text-sm flex items-center gap-2 transition hover:bg-slate-700 active:scale-95 border border-slate-600"><i class="ph-bold ph-navigation-arrow"></i> æˆ‘çš„ä½ç½®</button></div>
            </div>

            <!-- 4. åˆ†å¸³ -->
            <div v-show="viewMode === 'money'" class="p-4"><div class="bg-slate-800 text-white p-6 rounded-2xl mb-4 text-center shadow-lg"><div class="text-xs text-slate-400">ç¸½æ”¯å‡º</div><div class="text-3xl font-bold font-mono">NT$ {{ totalExpense }}</div></div><div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex gap-2 mb-4"><input v-model="newExpense.item" placeholder="é …ç›®" class="flex-[2] bg-slate-50 border-none rounded text-sm p-2"><input v-model.number="newExpense.amount" type="number" placeholder="$" class="flex-1 bg-slate-50 border-none rounded text-sm p-2"><button @click="addExpense" class="bg-teal-600 text-white px-3 rounded text-sm font-bold">åŠ å…¥</button></div><div class="space-y-2"><div v-for="(exp, idx) in expenses" :key="idx" class="bg-white p-3 rounded-xl border border-slate-50 flex justify-between items-center shadow-sm"><span class="text-sm font-bold text-slate-700">{{ exp.item }}</span><div class="flex items-center gap-2"><span class="font-mono text-teal-600 font-bold">${{ exp.amount }}</span><button @click="expenses.splice(idx, 1)" class="text-slate-300 hover:text-red-400"><i class="ph-bold ph-x"></i></button></div></div></div></div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, reactive, watch, nextTick, onMounted } = Vue;

        const firebaseConfig = {
            apiKey: "AIzaSyC_mIkGuJCMKAcoRf78bipUJzzodTk_zVs",
            authDomain: "lisboaaa-2c65b.firebaseapp.com",
            databaseURL: "https://lisboaaa-2c65b-default-rtdb.firebaseio.com",
            projectId: "lisboaaa-2c65b",
            storageBucket: "lisboaaa-2c65b.firebasestorage.app",
            messagingSenderId: "391483387676",
            appId: "1:391483387676:web:d527043aee656dfc5854d9",
            measurementId: "G-NPDLH60580"
        };
        let db; try { firebase.initializeApp(firebaseConfig); db = firebase.database(); } catch(e){}

        const app = createApp({
            setup() {
                const viewMode = ref('plan');
                const loading = ref(false); 
                const loadingText = ref('');
                const isConnected = ref(false);
                
                const allTrips = ref({});
                const currentTripId = ref(null);
                const showTripList = ref(false);
                const currentTripName = ref('è‘¡è±¬è±¬ä¹‹æ—…');
                const newTripNameInput = ref('');

                const flights = ref([]);
                const newFlight = reactive({ dep:'TPE', arr:'DXB', depTime:'23:30', arrTime:'06:15', depTerminal:'2', arrTerminal:'3', flightNumber:'EK367', nextDay:false });
                const currentDayIdx = ref(0);
                const days = ref([{ fullDate: new Date().toISOString().split('T')[0], title: 'Day 1', items: [] }]);
                const expenses = ref([]);
                const newExpense = reactive({ item:'', amount:null });
                const weather = reactive({ temp: '--', icon: 'sun' });

                let map=null, markersLayer=null, routeLine=null, userMarker=null;

                const syncData = () => {
                    if(!db) return;
                    db.ref('trips').on('value', s => {
                        const v = s.val();
                        isConnected.value = true;
                        allTrips.value = v || {};
                        if (!currentTripId.value || !allTrips.value[currentTripId.value]) {
                            const keys = Object.keys(allTrips.value);
                            if(keys.length > 0) { currentTripId.value = keys[0]; loadCurrentTripData(); } 
                            else { createNewTripDefaults(); }
                        } else { loadCurrentTripData(); }
                    });
                };
                const createNewTripDefaults = () => { const newId = 'trip_' + Date.now(); const newTripData = { name: 'æ–°æ—…ç¨‹', days: [{ fullDate: new Date().toISOString().split('T')[0], title: 'Day 1', items: [] }] }; currentTripId.value = newId; if(db) db.ref('trips/' + newId).set(newTripData); };

                const loadCurrentTripData = () => {
                    if(!allTrips.value || !currentTripId.value) return;
                    const t = allTrips.value[currentTripId.value];
                    if(!t) return;
                    currentTripName.value = t.name || 'æœªå‘½åæ—…ç¨‹';
                    flights.value = t.flights ? Object.values(t.flights) : [];
                    days.value = t.days ? t.days : [{ fullDate: new Date().toISOString().split('T')[0], title: 'Day 1', items: [] }];
                    if(days.value) {
                        days.value.forEach(day => {
                            if(day.items) {
                                day.items.forEach(item => {
                                    if(item.connected === undefined) item.connected = false;
                                    if(item.showTransport === undefined) item.showTransport = false;
                                });
                            }
                        });
                    }
                    expenses.value = t.expenses ? t.expenses : [];
                };

                const switchTrip = (id) => { currentTripId.value = id; currentDayIdx.value = 0; loadCurrentTripData(); showTripList.value = false; };
                const createNewTrip = () => {
                    if(!newTripNameInput.value.trim()) return;
                    const newId = 'trip_' + Date.now();
                    const newTripData = { name: newTripNameInput.value, days: [{ fullDate: new Date().toISOString().split('T')[0], title: 'Day 1', items: [] }], flights: {}, expenses: [] };
                    const temp = { ...allTrips.value }; temp[newId] = newTripData; allTrips.value = temp;
                    switchTrip(newId);
                    if(db) db.ref('trips/' + newId).set(newTripData);
                    newTripNameInput.value = '';
                };

                const deleteTrip = (id) => {
                    if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹æ—…ç¨‹ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) return;
                    const newTripsList = { ...allTrips.value }; 
                    delete newTripsList[id]; 
                    allTrips.value = newTripsList;

                    if(currentTripId.value === id) {
                        const remainingIds = Object.keys(newTripsList);
                        if(remainingIds.length > 0) switchTrip(remainingIds[0]);
                        else currentTripId.value = null;
                    }
                    if(db) db.ref('trips/' + id).remove();
                };

                const saveToTrip = (path, data) => { if(db && currentTripId.value && allTrips.value[currentTripId.value]) { db.ref(`trips/${currentTripId.value}/${path}`).set(data); }};
                watch(days, (v) => saveToTrip('days', v), { deep: true });
                watch(flights, (v) => { if(db && currentTripId.value && allTrips.value[currentTripId.value]) { const flightObj = {}; v.forEach(f => flightObj[f.id] = f); db.ref(`trips/${currentTripId.value}/flights`).set(flightObj); } }, { deep: true });
                watch(expenses, (v) => saveToTrip('expenses', v), { deep: true });
                watch(currentTripName, (v) => { if(db && currentTripId.value && allTrips.value[currentTripId.value]) { db.ref(`trips/${currentTripId.value}/name`).set(v); allTrips.value[currentTripId.value].name = v; }});
                watch(currentDayIdx, () => { if (viewMode.value === 'map') { loading.value = true; nextTick(() => { setTimeout(() => drawRoute(), 300); }); } });

                const prevDay = () => { if(currentDayIdx.value > 0) currentDayIdx.value--; };
                const nextDay = () => { if(currentDayIdx.value < days.value.length - 1) currentDayIdx.value++; };

                const sortedFlights = computed(() => flights.value);
                const addFlight = () => { const f = { id:Date.now(), ...newFlight, depTerminal:'', arrTerminal:'', flightNumber:newFlight.flightNumber, connected: false }; flights.value.push(f); newFlight.dep = newFlight.arr; newFlight.arr = ''; };
                const removeFlight = (id) => { flights.value = flights.value.filter(x=>x.id!==id); };
                const currentDay = computed(() => days.value[currentDayIdx.value] || {});
                const addDay = () => { const last = days.value[days.value.length-1]; const next = new Date(last.fullDate); next.setDate(next.getDate()+1); days.value.push({ fullDate: next.toISOString().split('T')[0], title:'', items:[] }); };
                const addItem = () => { if(!currentDay.value.items) currentDay.value.items=[]; currentDay.value.items.push({ time:'10:00',type:'spot',activity:'',location:'',note:'',ticket:'',openTime:'',error:false, connected: false, showTransport: false }); };
                const deleteItem = (idx) => currentDay.value.items.splice(idx, 1);
                const confirmAndDeleteDay = () => { if(confirm('åˆªé™¤?')) { days.value.splice(currentDayIdx.value, 1); currentDayIdx.value=0; }};
                const addExpense = () => { if(newExpense.item && newExpense.amount) { expenses.value.push({...newExpense}); newExpense.item=''; newExpense.amount=null; }};
                const totalExpense = computed(()=>expenses.value.reduce((a,b)=>a+b.amount,0));
                const fetchWeather = async () => { try { const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=38.72&longitude=-9.14&current=temperature_2m,weather_code&timezone=auto'); const data = await res.json(); if(data.current) { weather.temp = Math.round(data.current.temperature_2m); const c = data.current.weather_code; if(c<=3) weather.icon='sun'; else if(c<=48) weather.icon='cloud'; else if(c<=82) weather.icon='rain'; else weather.icon='cloud'; } } catch(e){} };
                const calculateLayover = (index) => { const current = sortedFlights.value[index]; const next = sortedFlights.value[index + 1]; if (!current || !next) return ''; const getMins = (t, isNextDay) => { if(!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m + (isNextDay ? 24 * 60 : 0); }; let arrMins = getMins(current.arrTime, current.nextDay); let depMins = getMins(next.depTime, false); if (depMins < arrMins) depMins += 24 * 60; const diff = depMins - arrMins; const h = Math.floor(diff / 60); const m = diff % 60; return `${h}h ${m}m`; };
                const getTypeColor = (t) => ({ spot:'bg-teal-500', restaurant:'bg-orange-500', cafe:'bg-yellow-500', shop:'bg-purple-500', transport:'bg-blue-500', hotel:'bg-indigo-500' }[t] || 'bg-slate-400');
                const initMap = () => { if(map) return; map = L.map('map').setView([38.72,-9.14], 14); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; CartoDB', maxZoom: 20 }).addTo(map); markersLayer = L.layerGroup().addTo(map); };
                const getCustomIcon = (t) => { let c='#64748b',i='ph-map-pin'; if(t=='spot'){c='#10b981';i='ph-flag-banner'} if(t=='restaurant'){c='#f97316';i='ph-fork-knife'} if(t=='cafe'){c='#eab308';i='ph-coffee'} if(t=='shop'){c='#a855f7';i='ph-shopping-bag'} if(t=='transport'){c='#3b82f6';i='ph-train'} if(t=='hotel'){c='#6366f1';i='ph-bed'} return L.divIcon({ html:`<div class="custom-pin" style="background-color:${c};width:34px;height:34px;"><i class="ph-fill ${i}" style="color:white;font-size:18px;"></i></div>`, className:'', iconSize:[34,34], iconAnchor:[17,34], popupAnchor:[0,-34] }); };
                const drawRoute = async () => { if(!map) initMap(); markersLayer.clearLayers(); if(routeLine){map.removeLayer(routeLine);routeLine=null;} const items=currentDay.value.items||[]; items.forEach(i=>i.error=false); const locs=items.filter(i=>i.location&&i.location.trim()); if(!locs.length) { loading.value=false; return; } loading.value=true; let arr=[],bounds=[]; for(let i=0;i<locs.length;i++){ try{ const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(locs[i].location)}&format=json&limit=1`); const d=await r.json(); if(d.length){ const lat=parseFloat(d[0].lat),lon=parseFloat(d[0].lon); L.marker([lat,lon],{icon:getCustomIcon(locs[i].type)}).addTo(markersLayer).bindPopup(locs[i].activity); arr.push([lat,lon]); bounds.push([lat,lon]); }else{ locs[i].error=true; } }catch{ locs[i].error=true; } } if(arr.length>1) routeLine=L.polyline(arr,{color:'#475569',weight:3,opacity:0.6,dashArray:'8,8'}).addTo(map); if(bounds.length) map.fitBounds(bounds,{padding:[60,60]}); loading.value=false; };
                
                const locateUser = () => {
                    if (!navigator.geolocation) { alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½"); return; }
                    loading.value = true;
                    loadingText.value = "æ­£åœ¨ç²å–æ‚¨çš„ä½ç½®...";
                    navigator.geolocation.getCurrentPosition(
                        (p) => {
                            loading.value = false;
                            const { latitude, longitude } = p.coords;
                            if (userMarker) map.removeLayer(userMarker);
                            const userIcon = L.divIcon({ className: 'gps-pulsing-icon', iconSize: [20, 20], iconAnchor: [10, 10] });
                            userMarker = L.marker([latitude, longitude], { icon: userIcon }).addTo(map);
                            userMarker.bindPopup("<b>ğŸ˜Š ä½ åœ¨é€™è£¡</b>").openPopup();
                            map.flyTo([latitude, longitude], 16);
                        },
                        (err) => {
                            loading.value = false;
                            console.error(err);
                            alert("ç„¡æ³•ç²å–ä½ç½®ï¼Œè«‹ç¢ºèªç€è¦½å™¨å·²å…è¨±å®šä½æ¬Šé™ã€‚");
                        }
                    );
                };

                onMounted(() => { syncData(); fetchWeather(); });
                watch(viewMode, v=>{ if(v=='map') nextTick(()=>{ initMap(); map.invalidateSize(); drawRoute(); }) });

                return {
                    viewMode, loading, loadingText, isConnected, flights, newFlight, addFlight, removeFlight, sortedFlights, calculateLayover,
                    days, currentDayIdx, currentDay, addDay, addItem, deleteItem, confirmAndDeleteDay,
                    drawRoute, locateUser, expenses, newExpense, addExpense, totalExpense, getTypeColor, weather,
                    allTrips, currentTripId, showTripList, switchTrip, createNewTrip, deleteTrip, currentTripName, newTripNameInput,
                    prevDay, nextDay
                };
            }
        });
        app.mount('#app');
    </script>
</body>
</html>

