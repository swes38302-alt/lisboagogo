<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="apple-touch-icon" href="/lisboagogo/apple-touch-icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‰Ω†ÊòØ‰ªÄÈ∫ΩË±¨ | ÂÖ®ÁêÉÈÄöÁî®ÊóÖÁ®ãË¶èÂäÉÂô®</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --theme-primary: #006C84;
            --theme-light: #6EB5C0;
            --theme-accent: #FFCC00;
            --theme-bg: #FDFBF7;
            --theme-text: #334155;
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--theme-bg);
            color: var(--theme-text);
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s ease;
        }
        
        [v-cloak] { display: none !important; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .h-dynamic-screen { height: 100vh; height: 100dvh; }
        .bg-theme-main { background-color: var(--theme-primary); transition: background-color 0.5s ease; }
        .text-theme-main { color: var(--theme-primary); transition: color 0.5s ease; }

        .locked-mode input,
        .locked-mode textarea,
        .locked-mode select,
        .locked-mode button:not(.unlock-btn):not(.lock-toggle-btn) {
            pointer-events: none;
            opacity: 0.7;
            cursor: not-allowed !important;
        }

        .locked-mode .drag-handle,
        .locked-mode .trip-drag-handle {
            display: none;
        }

        .locked-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .lock-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            background: #EF4444;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .password-input {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            letter-spacing: 2px;
            width: 100%;
        }

        .password-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: normal;
        }

        .boarding-pass-light {
            background: #ffffff;
            color: var(--theme-text);
            border-radius: 20px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.03);
            transition: all 0.3s;
            margin-bottom: 16px;
            overflow: hidden;
            z-index: 10;
        }
        .boarding-pass-light.connected-top { border-top-left-radius: 0; border-top-right-radius: 0; margin-top: 0; border-top: 1px dashed #e2e8f0; }
        .boarding-pass-light.connected-bottom { border-bottom-left-radius: 0; border-bottom-right-radius: 0; margin-bottom: 0; border-bottom: none; box-shadow: none; z-index: 20; }
        .flight-connector-strip { background-color: #F8FAFC; color: #94a3b8; font-size: 11px; font-weight: bold; text-align: center; padding: 4px 0; border-left: 2px dashed #e2e8f0; border-right: 2px dashed #e2e8f0; margin: 0 12px; cursor: pointer; transition: background 0.2s; }
        .flight-header { background: var(--theme-bg); padding: 10px 16px; border-bottom: 1px dashed #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .flight-body { padding: 16px; }
        .flight-code { 
            font-family: 'Oswald', sans-serif; 
            font-size: 32px; 
            font-weight: 700; 
            color: var(--theme-primary); 
            line-height: 1;
            text-transform: uppercase;
        }
        .flight-label { font-size: 10px; color: #94a3b8; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; }
        .flight-time { font-size: 20px; font-weight: 800; color: #334155; display: block; }
        .flight-meta { background: #f8fafc; padding: 8px; border-radius: 12px; margin-top: 8px; display: flex; gap: 8px; }
        .flight-input-meta { background: transparent; border: none; font-size: 11px; font-weight: bold; width: 100%; color: #64748b; text-align: center; }

        .transport-connector-bridge { position: absolute; bottom: -14px; left: 0; right: 0; height: 28px; z-index: 60; pointer-events: none; }
        .transport-btn-car { 
            pointer-events: auto; position: absolute; left: 24px; top: 50%; transform: translateY(-50%); 
            background-color: white; border: 1px solid #CBD5E1; color: var(--theme-primary); 
            width: 28px; height: 28px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 14px; 
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; 
            z-index: 60; 
        }
        .transport-break-btn { 
            pointer-events: auto; position: absolute; right: 24px; top: 50%; transform: translateY(-50%); 
            color: #94a3b8; cursor: pointer; font-size: 12px; 
            background: white; border: 1px solid #E2E8F0; 
            width: 24px; height: 24px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s; 
            z-index: 60; 
        }
        .map-day-selector { position: absolute; top: 12px; left: 12px; right: 12px; z-index: 1000; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px); padding: 8px; border-radius: 12px; display: flex; gap: 6px; overflow-x: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .map-day-btn { flex: 0 0 auto; width: 36px; height: 42px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #e2e8f0; font-size: 10px; color: #64748b; cursor: pointer; transition: all 0.2s; }
        .map-day-btn.active { background: var(--theme-primary); color: white; border-color: var(--theme-primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .map-day-number { font-size: 14px; font-weight: 800; line-height: 1; }
        .btn-gmap { background: white; border: 1px solid #E2E8F0; color: #EA4335; width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; margin-left: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .group-divider { position: absolute; bottom: 0; left: 16px; right: 16px; height: 1px; border-bottom: 2px dashed #CBD5E1; opacity: 0.5; }
        .transport-strip-full { width: 100%; background-color: #f8fafc; border-top: 1px dashed #E2E8F0; border-bottom: 1px dashed #E2E8F0; padding: 4px 8px; display: flex; align-items: center; justify-content: center; color: var(--theme-primary); font-size: 11px; font-weight: bold; gap: 8px; z-index: 40; position: relative; pointer-events: auto; }
        .pin-wrapper { position: relative; width: 36px; height: 36px; }
        .pin-main { width: 36px; height: 36px; border-radius: 50%; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.3); color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: transform 0.2s; }
        .pin-badge { position: absolute; bottom: -4px; right: -4px; width: 18px; height: 18px; background-color: #1E293B; color: white; border-radius: 50%; border: 1.5px solid white; font-family: 'Oswald', sans-serif; font-weight: bold; font-size: 10px; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .drag-handle { cursor: grab; padding: 4px; border-radius: 4px; color: #cbd5e1; touch-action: none; }
        .drag-handle:active { cursor: grabbing; color: var(--theme-primary); background-color: #f1f5f9; }
        .sortable-ghost { opacity: 0.3; background-color: #f0f9ff; border: 2px dashed var(--theme-light); }
        .sortable-drag { opacity: 1; background-color: white; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transform: scale(1.02); z-index: 99; }
        .type-selector-btn { width: 28px; height: 28px; border-radius: 50%; background-color: #F1F5F9; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: all 0.2s; font-size: 14px; z-index: 50; border: none; outline: none; padding: 0; appearance: none; }
        .global-type-popup { position: fixed; z-index: 9999; background: white; padding: 6px; border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.25), 0 8px 10px -6px rgba(0, 0, 0, 0.2); display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; width: 130px; border: 1px solid #F1F5F9; animation: fadeIn 0.15s ease-out forwards; }
        .type-option { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 6px 4px; border-radius: 8px; cursor: pointer; transition: background-color 0.1s; }
        .type-option:hover { background-color: #F8FAFC; }
        .trip-card { border: 1px solid #E2E8F0; border-radius: 16px; padding: 12px 16px; margin-bottom: 8px; background: white; transition: all 0.2s; cursor: pointer; position: relative; }
        .trip-card:hover { border-color: var(--theme-light); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .trip-card.active { border-color: var(--theme-primary); background-color: #F0FAFC; }
        .btn-dashed-add { border: 2px dashed var(--theme-light); color: var(--theme-primary); border-radius: 16px; padding: 12px; width: 100%; font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 12px; transition: all 0.2s; }
        .input-invisible { background: transparent; border: none; padding: 0; width: 100%; outline: none; }
        .auto-textarea { 
            resize: none; 
            overflow: hidden; 
            background: transparent; 
            border: none; 
            width: 100%; 
            padding: 0; 
            min-height: 20px; 
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
        }
        .auto-textarea:focus { outline: none; border: none; ring: 0; }
        .weather-font { font-family: 'Oswald', sans-serif; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        #map { height: 100%; width: 100%; z-index: 0; position: relative; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(-0); } }
        .card-connected-top { border-top: none; padding-top: 10px; border-top-left-radius: 0; border-top-right-radius: 0; }
        .card-connected-bottom { border-bottom: none; padding-bottom: 4px; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .card-dashed-border { border: 2px dashed var(--theme-light) !important; box-shadow: none !important; }
        .subtle-link-btn { pointer-events: auto; color: var(--theme-primary); background: white; border: 1px solid #E2E8F0; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); z-index: 60; }
        .settlement-card { background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border: 1px solid #BAE6FD; border-radius: 12px; padding: 12px; margin-bottom: 8px; }
        .participant-tag { display: inline-flex; align-items: center; background: var(--theme-primary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; gap: 6px; cursor: pointer; transition: all 0.2s; }
        .participant-tag:hover { transform: translateY(-1px); opacity: 0.9; }
        .todo-item { 
            background: white; 
            border: 1px solid #E2E8F0; 
            border-radius: 12px; 
            padding: 12px; 
            margin-bottom: 8px; 
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
        }
        .todo-item.completed { opacity: 0.6; background: #F8FAFC; }
        .todo-item.completed .todo-text { text-decoration: line-through; color: #94A3B8; }
        .todo-item.editing {
            border-color: var(--theme-primary);
            box-shadow: 0 4px 12px rgba(0,108,132,0.15);
            background: #F0FAFC;
        }
        .todo-checkbox { width: 20px; height: 20px; border-radius: 6px; border: 2px solid #CBD5E1; cursor: pointer; transition: all 0.2s; }
        .todo-checkbox:checked { background: var(--theme-primary); border-color: var(--theme-primary); }
        .clean-input { background: transparent; border: none !important; outline: none !important; box-shadow: none !important; margin: 0; }
        .clean-input:focus { ring: 0; outline: none; }
        .clean-select { background: transparent; border: none !important; outline: none; box-shadow: none; appearance: none; -webkit-appearance: none; text-align: center; padding-right: 14px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 256 256'%3E%3Cpath fill='%2394a3b8' d='M213.66 101.66l-80 80a8 8 0 0 1-11.32 0l-80-80A8 8 0 0 1 53.66 90.34L128 164.69l74.34-74.35a8 8 0 0 1 11.32 11.32z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right center; }
        .todo-edit-input {
            background: white;
            border: 2px solid var(--theme-primary);
            border-radius: 8px;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #334155;
            width: 100%;
        }
        .todo-edit-input:focus {
            outline: none;
            border-color: var(--theme-light);
        }
        .trip-drag-handle { cursor: grab; color: #CBD5E1; padding: 4px; border-radius: 6px; transition: all 0.2s; touch-action: none; }
        .trip-drag-handle:hover { color: var(--theme-primary); background: #F1F5F9; }
        .trip-drag-handle:active { cursor: grabbing; }
        .trip-list-sortable .sortable-ghost { opacity: 0.4; background: #F0F9FF; border: 2px dashed var(--theme-primary); }
        .trip-list-sortable .sortable-drag { opacity: 1; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transform: scale(1.03); border-color: var(--theme-primary); }
        .flex-input-safe { min-width: 0 !important; flex: 1 1 0%; }
        .flex-btn-safe { flex-shrink: 0; }
        .safe-container { max-width: 100%; overflow: hidden; }
        .sticky-header {
            position: sticky; 
            top: 0; 
            z-index: 3000;
            background: rgba(253, 251, 247, 0.98); 
            backdrop-filter: blur(10px);
            margin-left: -1rem; 
            margin-right: -1rem;
            padding: 10px 16px 14px 16px; 
            box-shadow: 0 4px 20px -5px rgba(0,0,0,0.1);
            transition: all 0.2s;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .date-card {
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid #F1F5F9;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .date-card.active {
            background: var(--theme-primary);
            color: white;
            border-color: var(--theme-primary);
            box-shadow: 0 4px 8px -2px rgba(0,0,0,0.25);
            transform: translateY(-2px);
        }
        .toggle-btn { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: bold; border: 1px solid #cbd5e1; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .toggle-btn.active { background: #0f172a; color: white; border-color: #0f172a; }
        .toggle-btn.settled.active { background: #10b981; color: white; border-color: #10b981; }
        .expense-item-settled { 
            opacity: 0.75; 
            background: #F0FDF4 !important; 
            border-color: #86EFAC !important;
        }
        .expense-item-settled .amount { 
            color: #10b981 !important;
        }
        .expense-list-separator { font-size: 10px; font-weight: bold; color: #94a3b8; text-align: center; margin: 12px 0 8px 0; display: flex; align-items: center; gap: 8px; }
        .expense-list-separator::before, .expense-list-separator::after { content: ''; height: 1px; background: #e2e8f0; flex: 1; }
        .itinerary-expense-card { border-left: 3px solid #8b5cf6 !important; position: relative; transition: all 0.3s; user-select: none; -webkit-user-select: none; }
        .itinerary-expense-card.settled { opacity: 0.5; background: #F8FAFC; border-color: #cbd5e1 !important; border-style: dashed !important; }
        .itinerary-expense-card.settled:after { content: '\f10c'; font-family: "Phosphor-Bold"; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 24px; color: #10b981; opacity: 0.3; pointer-events: none; }
        .press-hint { font-size: 9px; color: #cbd5e1; margin-top: 2px; display: block; text-align: right; }
    </style>
</head>

<body class="text-slate-700 h-dynamic-screen flex flex-col overflow-hidden fixed inset-0">
    <div id="app" v-cloak class="flex flex-col h-full max-w-md mx-auto w-full bg-white shadow-2xl sm:border-x sm:border-slate-200 relative">

        <!-- ÁúÅÁï• Header, Modals... (‰∏é‰πãÂâçÂÆåÂÖ®Áõ∏Âêå) -->
        <div v-if="globalMenu.visible" class="fixed inset-0 z-[9998]" @click="closeGlobalMenu"></div>
        <div v-if="globalMenu.visible" class="global-type-popup" :style="{ top: globalMenu.y + 'px', left: globalMenu.x + 'px' }">
            <div v-for="type in TYPES_LIST" :key="type.val" @click="confirmTypeSelection(type.val)" class="type-option">
                <span class="text-xl">{{ type.emoji }}</span><span class="text-[10px] font-bold text-slate-600">{{ type.label }}</span>
            </div>
        </div>

        <header class="bg-theme-main text-white shrink-0 z-20 shadow-md relative transition-all duration-500">
            <div class="px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3 flex-1 min-w-0">
                    <button @click="showTripList = true" class="relative hover:opacity-80 transition active:scale-95 flex-shrink-0" title="ÂàáÊèõÊóÖÁ®ã">
                        <div class="bg-white/20 p-1.5 rounded-lg backdrop-blur-sm border border-white/20"><i class="ph-bold ph-house text-2xl"></i></div>
                        <div v-if="isConnected" class="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-green-400 rounded-full border-2 border-white"></div>
                    </button>
                    <div class="flex items-center gap-2 mt-1 min-w-0 flex-1">
                        <span class="font-bold text-lg leading-tight truncate">{{ settings.name }}</span>
                        <button @click="showSettings = true" class="text-white/70 hover:text-white transition p-1 hover:bg-white/10 rounded-full flex-shrink-0" title="ÊóÖÁ®ãË®≠ÂÆö"><i class="ph-bold ph-gear-six text-lg"></i></button>
                        <button @click="toggleLock" class="lock-toggle-btn relative text-white/70 hover:text-white transition p-1 hover:bg-white/10 rounded-full flex-shrink-0" :title="settings.isLocked ? 'Â∑≤ÈéñÂÆöÔºàÈªûÊìäËß£ÈéñÔºâ' : 'ÈªûÊìäÈéñÂÆö'">
                            <i class="ph-bold text-lg" :class="settings.isLocked ? 'ph-lock' : 'ph-lock-open'"></i>
                            <div v-if="settings.isLocked" class="lock-badge">
                                <i class="ph-fill ph-lock text-white" style="font-size: 7px;"></i>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="flex flex-col items-end text-right flex-shrink-0 ml-2">
                    <div class="flex items-center gap-1.5"><i :class="getWeatherIcon(weather.icon)" class="text-xl"></i><span class="weather-font text-2xl font-bold leading-none">{{ weather.temp }}¬∞</span></div>
                    <span class="text-[10px] opacity-80 font-bold uppercase tracking-widest -mt-0.5 flex items-center gap-1"><i class="ph-fill ph-map-pin text-[9px]"></i> {{ settings.location }}</span>
                </div>
            </div>
            <div class="px-4 pb-3 flex gap-2 overflow-x-auto header-tabs">
                 <button v-for="m in ['flight','plan','map','todo','money']" :key="m" @click="viewMode=m" 
                 class="flex-1 py-1.5 rounded-lg text-xs font-bold flex justify-center gap-1 items-center transition whitespace-nowrap" 
                 :class="viewMode===m ? 'bg-white text-theme-main shadow' : 'bg-black/20 text-white/70'">
                    <i class="ph-bold" :class="{'flight':'ph-airplane-tilt','plan':'ph-list-dashes','map':'ph-map-trifold','todo':'ph-check-square','money':'ph-coins'}[m]"></i>
                    {{ {'flight':'Ëà™Áè≠','plan':'Ë°åÁ®ã','map':'Âú∞Âúñ','todo':'ÂæÖËæ¶','money':'ÂàÜÂ∏≥'}[m] }}
                 </button>
            </div>
        </header>

        <!-- Settings Modal -->
        <div v-if="showSettings" class="modal-overlay" @click.self="showSettings = false">
            <div class="bg-white w-11/12 max-w-sm rounded-2xl shadow-2xl p-5 animate__animated animate__fadeInUp safe-container">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2"><i class="ph-duotone ph-gear-six text-theme-main"></i> ÊóÖÁ®ãË®≠ÂÆö</h2>
                    <button @click="showSettings = false"><i class="ph-bold ph-x text-slate-400 text-xl"></i></button>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 space-y-3">
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">ÊóÖÁ®ãÂêçÁ®±</label><input v-model="settings.name" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold focus:border-theme-main outline-none transition" placeholder="‰æãÂ¶Ç: Êó•Êú¨Êù±‰∫¨‰πãÊóÖ"></div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">ÂâçÂæÄÂú∞Èªû</label>
                        <div class="flex gap-2 items-stretch">
                            <input v-model="settings.location" @change="applyGlobalTheme" class="flex-input-safe bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold focus:border-theme-main outline-none transition" placeholder="‰æãÂ¶Ç: Tokyo">
                            <button @click="applyGlobalTheme" class="flex-btn-safe bg-white border border-slate-200 w-10 h-10 rounded-lg text-theme-main hover:bg-slate-50 flex items-center justify-center"><i class="ph-bold ph-magic-wand"></i></button>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Ë≤®Âπ£</label>
                            <input v-model="settings.currency" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold text-center">
                        </div>
                        <div class="flex-[1.5]">
                            <label class="text-[10px] font-bold text-slate-400 uppercase flex items-center gap-1">
                                ÂåØÁéá
                                <button @click="autoSetRate" class="text-blue-500 hover:text-blue-700 text-xs" title="Ëá™ÂãïË®≠ÂÆöÂåØÁéá">
                                    <i class="ph-bold ph-arrows-clockwise"></i>
                                </button>
                            </label>
                            <input v-model="settings.rate" type="number" step="0.01" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold text-center">
                        </div>
                    </div>
                    
                    <div class="mt-3 pt-3 border-t border-slate-200">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase flex items-center gap-1">
                                <i class="ph-bold ph-lock"></i> ÊóÖÁ®ãÈéñÂÆö
                            </label>
                            <button @click="settings.isLocked = !settings.isLocked" class="px-3 py-1 rounded-full text-xs font-bold transition" :class="settings.isLocked ? 'bg-red-500 text-white' : 'bg-slate-200 text-slate-600'">
                                {{ settings.isLocked ? 'üîí Â∑≤ÈéñÂÆö' : 'üîì Êú™ÈéñÂÆö' }}
                            </button>
                        </div>
                        <div v-if="settings.isLocked" class="space-y-2 animate__animated animate__fadeIn">
                            <input v-model="settings.password" type="password" placeholder="Ë®≠ÂÆöËß£ÈéñÂØÜÁ¢ºÔºàÈÅ∏Â°´Ôºâ" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm">
                            <p class="text-[10px] text-amber-600 flex items-start gap-1">
                                <i class="ph-fill ph-warning-circle mt-0.5"></i>
                                <span>ÈéñÂÆöÂæåÊâÄÊúâÂÖßÂÆπÂ∞áÁÑ°Ê≥ïÁ∑®ËºØ„ÄÇÂ¶ÇË®≠ÂÆöÂØÜÁ¢ºÔºåËß£ÈéñÊôÇÈúÄËº∏ÂÖ•ÂØÜÁ¢º„ÄÇ</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trip List Modal -->
        <div v-if="showTripList" class="modal-overlay" @click.self="showTripList = false">
            <div class="bg-white w-11/12 max-w-sm rounded-2xl shadow-2xl p-5 animate__animated animate__fadeInUp max-h-[85vh] overflow-y-auto hide-scroll">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2"><i class="ph-duotone ph-house text-theme-main"></i> ÊàëÁöÑÊóÖÁ®ã ({{ tripOrderList.length }})</h2>
                    <button @click="showTripList = false"><i class="ph-bold ph-x text-slate-400 text-xl"></i></button>
                </div>
                <div id="trip-list-container" class="space-y-3 trip-list-sortable mb-4">
                    <div v-for="id in tripOrderList" :key="id" :data-trip-id="id" @click="switchTrip(id)" class="trip-card group relative" :class="currentTripId === id ? 'active ring-2 ring-theme-main bg-blue-50' : 'hover:bg-slate-50'">
                        <div class="flex items-start gap-3">
                            <div class="trip-drag-handle pt-1 flex-shrink-0" title="ÊãñÊãΩË™øÊï¥È†ÜÂ∫è"><i class="ph-bold ph-dots-six-vertical text-xl"></i></div>
                            <div class="flex-1 min-w-0" @click.stop="switchTrip(id)">
                                <div class="font-bold text-base text-slate-800 mb-0.5 truncate">{{ allTrips[id]?.settings?.name || 'Êú™ÂëΩÂêçÊóÖÁ®ã' }}</div>
                                <div class="text-[10px] text-slate-400 uppercase font-medium flex items-center gap-1"><i class="ph-fill ph-calendar-blank"></i> {{ allTrips[id]?.days?.[0]?.fullDate || 'Plan' }}<span v-if="allTrips[id]?.days">‚Ä¢ {{ allTrips[id].days.length }} Â§©</span></div>
                            </div>
                            <div class="flex flex-col items-end gap-1 flex-shrink-0">
                                <div v-if="currentTripId === id" class="bg-theme-main text-white text-[10px] px-2 py-0.5 rounded-full font-bold">CURRENT</div>
                                <button @click.stop="deleteTrip(id)" class="text-slate-300 hover:text-red-500 p-1.5 transition rounded-full hover:bg-red-50" title="Âà™Èô§ÊóÖÁ®ã"><i class="ph-bold ph-trash text-lg"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pt-4 border-t border-dashed border-slate-200"><button @click="createNewTrip" class="btn-dashed-add"><i class="ph-bold ph-plus-circle"></i> Âª∫Á´ãÊñ∞ÊóÖÁ®ã</button></div>
            </div>
        </div>

        <div v-if="showUnlockPrompt" class="locked-overlay">
            <div class="bg-white rounded-2xl shadow-2xl p-6 w-11/12 max-w-sm animate__animated animate__bounceIn">
                <div class="text-center mb-4">
                    <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="ph-fill ph-lock text-amber-600 text-3xl"></i>
                    </div>
                    <h2 class="text-lg font-bold text-slate-700">üîí ÊóÖÁ®ãÂ∑≤ÈéñÂÆö</h2>
                    <p class="text-sm text-slate-500 mt-1">Ë´ãËº∏ÂÖ•ÂØÜÁ¢º‰ª•Ëß£ÈéñÁ∑®ËºØÊ¨äÈôê</p>
                </div>
                <input v-model="unlockPassword" @keyup.enter="attemptUnlock" type="password" placeholder="Ë´ãËº∏ÂÖ•Ëß£ÈéñÂØÜÁ¢º" class="password-input mb-4">
                <div class="flex gap-2">
                    <button @click="showUnlockPrompt = false" class="flex-1 bg-slate-200 text-slate-600 py-3 rounded-lg font-bold">ÂèñÊ∂à</button>
                    <button @click="attemptUnlock" class="unlock-btn flex-1 bg-theme-main text-white py-3 rounded-lg font-bold">Ëß£Èéñ</button>
                </div>
                <p class="text-[10px] text-slate-400 text-center mt-3">
                    ÂøòË®òÂØÜÁ¢ºÔºüË´ãËÅØÁπ´ÊóÖÁ®ãÂª∫Á´ãËÄÖ
                </p>
            </div>
        </div>

        <main class="flex-1 overflow-y-auto relative hide-scroll" id="main-scroller" style="background-color: var(--theme-bg);" :class="{'locked-mode': settings.isLocked && !isUnlocked}">
            <div v-if="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-[1000]"><i class="ph-duotone ph-spinner-gap animate-spin text-4xl text-theme-main mb-2"></i><p class="text-xs text-slate-400">{{ loadingText }}</p></div>
            
            <!-- Flight View (ÁúÅÁï•Ôºå‰∏é‰πãÂâçÂÆåÂÖ®Áõ∏Âêå) -->
            <div v-show="viewMode === 'flight'" class="p-4 space-y-0 pb-20">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-6 relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 text-theme-main opacity-10"><i class="ph-fill ph-airplane-tilt text-9xl"></i></div>
                    <h2 class="font-bold text-slate-700 mb-3 text-sm relative z-10">Êñ∞Â¢ûËà™Áè≠</h2>
                    <div class="flex gap-2 mb-2 relative z-10">
                        <input v-model="newFlight.dep" @input="e => newFlight.dep = e.target.value.toUpperCase()" placeholder="DEP" class="w-1/2 bg-slate-50 p-2 rounded text-sm uppercase font-bold text-center border-none">
                        <div class="self-center text-slate-300"><i class="ph-bold ph-airplane-tilt"></i></div>
                        <input v-model="newFlight.arr" @input="e => newFlight.arr = e.target.value.toUpperCase()" placeholder="ARR" class="w-1/2 bg-slate-50 p-2 rounded text-sm uppercase font-bold text-center border-none">
                    </div>
                    <div class="flex gap-2 items-center mb-3 relative z-10">
                        <div class="flex-[2]"><input v-model="newFlight.depTime" type="time" class="w-full bg-slate-50 p-2 rounded text-sm border-none"></div>
                        <div class="flex-[2]"><input v-model="newFlight.arrTime" type="time" class="w-full bg-slate-50 p-2 rounded text-sm border-none"></div>
                        <div class="flex-1"><select v-model="newFlight.nextDay" class="w-full bg-slate-50 p-2 rounded text-sm h-[36px] border-none"><option :value="false">ÁÑ°</option><option :value="true">+1</option></select></div>
                    </div>
                    <button @click="addFlight" class="w-full bg-theme-main text-white py-2 rounded-lg font-bold text-sm shadow-md active:scale-95 transition relative z-10">Êñ∞Â¢û</button>
                </div>
                <template v-for="(flight, index) in sortedFlights" :key="flight.id">
                    <div class="boarding-pass-light relative" :class="[(flight.connected && index < sortedFlights.length - 1) ? 'connected-bottom' : '', (index > 0 && sortedFlights[index-1].connected) ? 'connected-top' : '']">
                        <div class="flight-header">
                            <div class="flex items-center gap-2 text-theme-main">
                                <i class="ph-fill ph-airplane-tilt text-xl"></i>
                                <input v-model="flight.flightNumber" @input="e => flight.flightNumber = e.target.value.toUpperCase()" class="bg-transparent border-none font-bold text-sm w-24 placeholder-slate-300 text-theme-main uppercase" placeholder="FLIGHT NO">
                            </div>
                            <div class="text-xs font-bold text-slate-400 tracking-wide">BOARDING PASS</div>
                        </div>
                        <div class="flight-body">
                            <div class="flex justify-between items-center mb-4">
                                <div class="text-left"><span class="flight-time">{{ flight.depTime }}</span><span class="flight-code">{{ flight.dep }}</span><div class="flex items-center gap-1 mt-1"><i class="ph-fill ph-airplane-takeoff text-slate-300 text-xs"></i><span class="flight-label">DEPARTURE</span></div></div>
                                <div class="flex-1 px-4 flex flex-col items-center justify-center"><div class="w-full h-px bg-slate-200 relative top-1"></div><i class="ph-fill ph-airplane text-theme-light text-lg bg-white px-2 relative z-10"></i></div>
                                <div class="text-right"><div class="flex items-center justify-end gap-1"><span class="flight-time">{{ flight.arrTime }}</span><span v-if="flight.nextDay" class="text-[10px] text-red-400 font-black">+1</span></div><span class="flight-code">{{ flight.arr }}</span><div class="flex items-center justify-end gap-1 mt-1"><span class="flight-label">ARRIVAL</span><i class="ph-fill ph-airplane-landing text-slate-300 text-xs"></i></div></div>
                            </div>
                            <div class="flight-meta">
                                <div class="flex-1 border-r border-slate-200 pr-2">
                                    <span class="flight-label block text-center mb-1">Âá∫ÁôºËà™Âªà</span>
                                    <input v-model="flight.terminal" placeholder="T1" class="flight-input-meta">
                                </div>
                                <div class="flex-1">
                                    <span class="flight-label block text-center mb-1">ÊäµÈÅîËà™Âªà</span>
                                    <input v-model="flight.arrivalTerminal" placeholder="T2" class="flight-input-meta">
                                </div>
                            </div>
                        </div>
                        <button @click="removeFlight(flight.id)" class="absolute top-3 right-3 text-slate-300 hover:text-red-400 transition"><i class="ph-bold ph-trash"></i></button>
                    </div>
                    <div v-if="index < sortedFlights.length - 1">
                        <div v-if="!flight.connected" class="flex justify-center -my-3 relative z-20"><button @click="flight.connected = true" class="link-btn hover:text-theme-main text-slate-400 transition shadow-sm"><i class="ph-bold ph-link text-lg"></i></button></div>
                        <div v-else @click="flight.connected = false" class="flight-connector-strip">‚Ä¢ ËΩâÊ©üÁ≠âÂæÖ {{ calculateLayover(index) }} ‚Ä¢</div>
                    </div>
                </template>
            </div>

            <!-- Plan View (ÁúÅÁï•Ôºå‰∏é‰πãÂâçÂÆåÂÖ®Áõ∏ÂêåÔºåÂåÖÂê´ÊâÄÊúâË°åÁ®ãÂç°Áâá‰ª£Á†Å) -->
            <div v-show="viewMode === 'plan'" class="p-4 pb-20">
                <div v-if="days.length > 0" class="sticky-header mb-6">
                    <div class="flex overflow-x-auto hide-scroll space-x-2 items-center">
                        <div v-for="(day, index) in days" :key="index" @click="currentDayIdx = index" class="date-card shrink-0 w-12 h-14 rounded-xl flex flex-col items-center justify-center cursor-pointer" :class="currentDayIdx === index ? 'active' : 'text-slate-400'">
                            <span class="text-[10px] font-bold opacity-70">D{{ index + 1 }}</span>
                            <span class="text-base font-black leading-none mt-0.5">{{ new Date(day.fullDate).getDate() }}</span>
                        </div>
                        <button @click="addDay" class="shrink-0 w-10 h-14 rounded-xl border-2 border-dashed border-theme-dashed text-slate-300 flex items-center justify-center hover:bg-white hover:text-theme-main transition"><i class="ph-bold ph-plus"></i></button>
                    </div>
                </div>
                
                <div class="bg-white p-3 rounded-xl shadow-sm mb-4 border border-slate-100"><div class="flex justify-between"><input type="date" v-model="currentDay.fullDate" @change="sortDays()" class="text-xs text-slate-400 bg-transparent border-none p-0"><button @click="confirmAndDeleteDay" class="text-slate-300 hover:text-red-400"><i class="ph-bold ph-trash"></i></button></div><input v-model="currentDay.title" class="text-lg font-black w-full border-none p-0 text-slate-700 focus:ring-0" placeholder="Ë®≠ÂÆöÊú¨Êó•‰∏ªÈ°å"></div>
                
                <div id="itinerary-list" class="space-y-0 pl-2">
                    <div v-for="(item, idx) in currentDay.items" :key="item.id" class="itinerary-wrapper relative group" :class="[(item.connected || (isConnectedToPrev(idx))) ? 'mb-0' : 'mb-5']" :data-id="idx">
                        <div class="p-3 shadow-sm bg-white relative transition flex gap-3 border border-slate-100 rounded-xl" :class="[isConnectedToNext(idx) ? 'card-connected-bottom' : '', isConnectedToPrev(idx) ? 'card-connected-top' : '', (isConnectedToNext(idx) || isConnectedToPrev(idx)) ? 'card-dashed-border' : '']">
                            <div v-if="isConnectedToPrev(idx) && !getPrevItem(idx)?.showTransport" class="group-divider"></div>
                            <div class="absolute left-0 top-4 bottom-4 w-1 rounded-r-md" :class="getTypeColor(item.type)"></div>
                            <div class="flex flex-col items-center w-20 shrink-0 gap-1 pt-1 relative">
                                <input v-model="item.time" type="time" class="text-xs font-black bg-transparent rounded px-1 w-full text-center border-none p-1 text-slate-600">
                                <button type="button" @click="openGlobalMenu($event, item)" class="type-selector-btn no-drag" :class="globalMenu.activeItem === item ? 'ring-2 ring-blue-200' : ''"><span class="text-base leading-none">{{ getTypeEmoji(item.type) }}</span></button>
                                <span class="text-[9px] font-bold text-slate-400 mt-0.5 scale-90">{{ getTypeName(item.type) }}</span>
                            </div>
                            <div class="flex-1 min-w-0 space-y-2">
                                <div class="flex justify-between items-start">
                                    <input v-model="item.activity" class="font-bold text-sm border-none p-0 w-full bg-transparent placeholder-slate-300 focus:ring-0 text-slate-800 mt-1.5" placeholder="Ë°åÁ®ãÂêçÁ®±">
                                    <div class="flex items-center gap-1 ml-1"><i class="ph-bold ph-dots-six-vertical drag-handle text-lg text-slate-300 hover:text-theme-main" title="Èï∑ÊåâÊãñÊõ≥ÊéíÂ∫è"></i><button @click="deleteItem(idx)" class="text-slate-200 hover:text-red-400 p-1"><i class="ph-bold ph-x"></i></button></div>
                                </div>
                                <div class="relative">
                                    <div class="flex items-center gap-2" :class="item.error ? 'text-red-500' : 'text-slate-600'">
                                        <i :class="item.error ? 'ph-warning-circle text-red-500' : 'ph-map-pin-fill text-teal-500'" class="ph-fill text-sm mt-0.5 shrink-0 animate__animated" :class="{'animate__headShake': item.error}"></i>
                                        <input v-model="item.location" @blur="checkLocation(item)" @input="item.error = false" class="input-invisible text-xs font-medium placeholder-slate-300" :class="{'text-red-500 font-bold': item.error}" placeholder="Ëº∏ÂÖ•Âú∞Èªû">
                                        <a v-if="item.location" :href="'https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(item.location)" target="_blank" class="btn-gmap" title="ÊâìÈñã Google Map"><i class="ph-bold ph-navigation-arrow"></i></a>
                                    </div>
                                </div>
                                <div class="flex items-start gap-2 mt-1"><i class="ph-fill ph-info text-orange-400 text-sm mt-0.5 shrink-0"></i><textarea v-model="item.note" @input="autoResize($event)" rows="1" class="auto-textarea text-xs text-orange-500 font-medium placeholder-orange-200/70" placeholder="ÂÇôË®ª..."></textarea></div>
                                <div class="mt-3 p-2 bg-slate-50 rounded-lg flex flex-col gap-2">
                                    <div class="flex items-center gap-2">
                                        <div class="flex items-center gap-2 shrink-0"><span class="text-xs font-bold text-slate-400 whitespace-nowrap">Ë≤ªÁî®</span><input v-model="item.ticket" class="clean-input w-16 text-xs font-bold text-slate-700 placeholder-slate-300" placeholder="---"></div>
                                        <div @click="item.isPaid = !item.isPaid" class="cursor-pointer flex items-center text-lg transition active:scale-95 shrink-0" title="Â∑≤‰ªòÊ¨æ?"><i :class="item.isPaid ? 'ph-fill ph-check-square text-theme-main' : 'ph-bold ph-square text-slate-300'"></i></div>
                                        <div v-if="item.isPaid" class="flex items-center gap-1 animate__animated animate__fadeInLeft flex-input-safe">
                                            <span class="text-[10px] font-bold text-slate-400 whitespace-nowrap">‰ªòÊ¨æ</span>
                                            <select v-model="item.payer" class="clean-select clean-input w-full text-xs font-bold text-blue-600"><option value="" disabled selected>Ë™∞?</option><option v-for="p in participants" :value="p">{{ p }}</option><option v-if="item.payer && !participants.includes(item.payer)" :value="item.payer">{{ item.payer }}</option></select>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2"><span class="text-xs font-bold text-slate-400 whitespace-nowrap">ÊôÇÈñì</span><input v-model="item.openTime" class="clean-input w-full text-xs font-bold text-slate-700 placeholder-slate-300" placeholder="--:--"></div>
                                </div>
                            </div>
                            <div v-if="item.connected && idx < currentDay.items.length - 1 && !item.showTransport" class="transport-connector-bridge">
                                <div @click="item.showTransport = true" class="transport-btn-car" title="‰∫§ÈÄöÈÄ£Áµê"><i class="ph-bold ph-car"></i></div>
                                <div @click="item.connected = false" class="transport-break-btn" title="Êñ∑ÈñãÈÄ£Áµê"><i class="ph-bold ph-link-break"></i></div>
                            </div>
                        </div>
                        <div v-if="item.connected && item.showTransport && idx < currentDay.items.length - 1" class="mb-0 relative z-20">
                             <div class="transport-strip-full animate__animated animate__fadeIn rounded-b-xl border-x-2 border-b-2 border-dashed border-[var(--theme-light)] border-t-0 shadow-sm"><i class="ph-fill ph-car-profile text-theme-main"></i><input v-model="item.transportNote" class="bg-transparent border-none text-[10px] w-full text-center text-slate-600 focus:ring-0 p-0 placeholder-slate-400" placeholder="Ëº∏ÂÖ•‰∫§ÈÄöÊñπÂºè"><button @click="item.showTransport = false" class="text-slate-300 hover:text-theme-main px-1"><i class="ph-bold ph-minus-circle"></i></button><div class="w-px h-3 bg-slate-300 mx-1"></div><button @click="item.connected = false" class="text-slate-300 hover:text-red-400 px-1"><i class="ph-bold ph-link-break"></i></button></div>
                        </div>
                        <div v-if="!item.connected && idx < currentDay.items.length - 1" class="flex justify-center -mt-2.5 mb-2.5 relative z-0 h-4 items-center">
                            <div @click="item.connected = true; item.showTransport = false" class="subtle-link-btn text-slate-300 shadow-sm" title="ÈÄ£Áµê"><i class="ph-bold ph-link-simple"></i></div>
                        </div>
                    </div>
                </div>
                <button @click="addItem" class="w-full mt-4 py-2 border-2 border-dashed border-theme-dashed rounded-xl text-slate-400 font-bold text-xs hover:bg-white hover:text-theme-main transition">+ Êñ∞Â¢ûË°åÁ®ã</button>
            </div>
            
            <!-- Map View -->
            <div v-show="viewMode === 'map'" class="h-full flex flex-col relative w-full">
                <div v-if="days.length > 0" class="map-day-selector hide-scroll">
                    <div v-for="(day, index) in days" :key="index" @click="switchMapDay(index)" class="map-day-btn" :class="currentDayIdx === index ? 'active' : ''">
                        <span>D{{ index + 1 }}</span><span class="map-day-number">{{ new Date(day.fullDate).getDate() }}</span>
                    </div>
                </div>
                <div id="map" class="flex-1"></div>
                <div class="absolute bottom-6 left-4 right-4 z-[5000] flex justify-center gap-3"><button @click="locateUser" class="bg-[#1E293B] text-white px-5 py-2.5 rounded-full shadow-xl font-bold text-sm flex items-center gap-2 transition hover:bg-[#0F172A] active:scale-95 border border-slate-600"><i class="ph-bold ph-navigation-arrow"></i> ÊàëÁöÑ‰ΩçÁΩÆ</button></div>
            </div>
            
            <!-- Todo View (ÁúÅÁï•Ôºå‰∏é‰πãÂâçÂÆåÂÖ®Áõ∏Âêå) -->
            <div v-show="viewMode === 'todo'" class="p-4 pb-20">
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-xl mb-4 border border-blue-100">
                    <h2 class="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2"><i class="ph-duotone ph-check-square text-theme-main text-lg"></i> Êñ∞Â¢ûÂæÖËæ¶‰∫ãÈ†Ö</h2>
                    <div class="space-y-2">
                        <input v-model="newTodo.text" @keyup.enter="addTodo" placeholder="‰æãÂ¶ÇÔºöË®ÇÈñÄÁ•®„ÄÅÊèõÂ§ñÂπ£" class="w-full bg-white border-none rounded-lg px-3 py-2 text-sm font-bold text-slate-700">
                        <div class="flex gap-2"><select v-model="newTodo.category" class="flex-1 bg-white border-none rounded-lg px-3 py-2 text-sm font-bold text-slate-600"><option value="before">Âá∫ÁôºÂâç</option><option value="during">ÊóÖÁ®ã‰∏≠</option><option value="after">ËøîÂÆ∂Âæå</option></select><input v-model="newTodo.deadline" type="date" class="flex-1 bg-white border-none rounded-lg px-3 py-2 text-sm font-bold text-slate-600"></div>
                        <button @click="addTodo" class="w-full bg-theme-main text-white py-2 rounded-lg font-bold text-sm"><i class="ph-bold ph-plus mr-1"></i> Êñ∞Â¢û</button>
                    </div>
                </div>
                <div v-for="cat in ['before', 'during', 'after']" :key="cat" class="mb-6">
                    <h3 class="font-bold text-slate-600 mb-2 text-sm flex items-center gap-2"><i class="ph-bold" :class="{'before':'ph-calendar-check','during':'ph-airplane-in-flight','after':'ph-clipboard-text'}[cat]"></i> {{ {'before':'Âá∫ÁôºÂâçÊ∫ñÂÇô','during':'ÊóÖÁ®ã‰∏≠','after':'ËøîÂÆ∂Âæå'}[cat] }} <span class="text-xs text-slate-400">({{ getSortedTodosByCategory(cat).length }})</span></h3>
                    <div class="space-y-2">
                        <div v-for="todo in getSortedTodosByCategory(cat)" :key="todo.id" 
                             class="todo-item bg-white shadow-sm border border-slate-100" 
                             :class="{ 'completed': todo.completed, 'editing': editingTodoId === todo.id }"
                             @touchstart="startTodoLongPress(todo)" 
                             @touchend="clearTodoLongPress" 
                             @mousedown="startTodoLongPress(todo)" 
                             @mouseup="clearTodoLongPress" 
                             @mouseleave="clearTodoLongPress">
                            <div v-if="editingTodoId !== todo.id" class="flex items-start gap-3">
                                <input type="checkbox" v-model="todo.completed" class="todo-checkbox mt-0.5 flex-shrink-0">
                                <div class="flex-1 min-w-0">
                                    <div class="todo-text font-bold text-sm text-slate-700">{{ todo.text }}</div>
                                    <div v-if="todo.deadline" class="text-xs text-slate-400 mt-1 flex items-center gap-1"><i class="ph-bold ph-calendar-blank"></i> {{ todo.deadline }}</div>
                                </div>
                                <button @click="deleteTodo(todo.id)" class="text-slate-300 hover:text-red-400 p-1 flex-shrink-0"><i class="ph-bold ph-trash"></i></button>
                            </div>
                            <div v-else class="space-y-2">
                                <input v-model="todo.text" @blur="finishEditingTodo" @keyup.enter="finishEditingTodo" class="todo-edit-input" placeholder="ÂæÖËæ¶‰∫ãÈ†Ö">
                                <input v-model="todo.deadline" @blur="finishEditingTodo" type="date" class="todo-edit-input">
                                <div class="flex gap-2">
                                    <button @click="finishEditingTodo" class="flex-1 bg-theme-main text-white py-2 rounded-lg text-xs font-bold">ÂÆåÊàê</button>
                                    <button @click="cancelEditingTodo" class="flex-1 bg-slate-200 text-slate-600 py-2 rounded-lg text-xs font-bold">ÂèñÊ∂à</button>
                                </div>
                            </div>
                        </div>
                        <div v-if="getSortedTodosByCategory(cat).length === 0" class="text-center py-6 text-slate-300 text-sm"><i class="ph-duotone ph-check-circle text-3xl mb-2"></i><div>Ê≤íÊúâÂæÖËæ¶‰∫ãÈ†Ö</div></div>
                    </div>
                </div>
            </div>
            
            <!-- Money View (ÁúÅÁï•Ôºå‰∏é‰πãÂâçÂÆåÂÖ®Áõ∏ÂêåÔºåÂåÖÂê´ÊâÄÊúâÂàÜË¥¶‰ª£Á†Å) -->
            <div v-show="viewMode === 'money'" class="p-4 pb-20">
                <div class="bg-[#1E293B] text-white p-6 rounded-2xl mb-4 text-center shadow-lg">
                    <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Á∏ΩÊîØÂá∫ Total</div>
                    <div class="text-4xl font-black font-mono tracking-tight">{{ settings.currency }} {{ totalExpense.toFixed(1) }}</div>
                    <div class="text-sm font-bold text-cyan-400 mt-1 font-mono mb-4">‚âà NT$ {{ Math.round(totalExpense * settings.rate).toLocaleString() }}</div>
                    <div v-if="participants.length > 0" class="border-t border-slate-700 pt-3 mt-2">
                        <div class="text-[10px] text-slate-400 mb-1">Âπ≥ÂùáÊØè‰∫∫Ëä±Ë≤ª</div>
                        <div class="flex items-center justify-center gap-2">
                            <span class="text-lg font-bold font-mono">{{ settings.currency }} {{ (totalExpense / participants.length).toFixed(1) }}</span>
                            <span class="text-xs text-cyan-400 font-mono font-bold">(NT$ {{ Math.round((totalExpense / participants.length) * settings.rate).toLocaleString() }})</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-4">
                    <h3 class="font-bold text-sm text-slate-700 mb-3 flex items-center gap-2"><i class="ph-duotone ph-users text-theme-main"></i> ÊóÖ‰º¥ÁÆ°ÁêÜ</h3>
                    <div class="flex gap-2 mb-3 items-stretch">
                        <input v-model="newParticipant" @keyup.enter="addParticipant" placeholder="Êñ∞Â¢ûÊóÖ‰º¥ (Â¶Ç: Â∞èÊòé)" class="flex-input-safe bg-slate-50 border-none rounded-lg text-sm p-2">
                        <button @click="addParticipant" class="flex-btn-safe bg-theme-main text-white w-10 h-10 rounded-lg text-sm font-bold flex items-center justify-center"><i class="ph-bold ph-plus"></i></button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <div v-for="(p, idx) in participants" :key="idx" class="participant-tag group" @click="startEditingParticipant(idx, p)">
                            <span v-if="editingParticipantIdx !== idx">{{ p }}</span>
                            <input v-if="editingParticipantIdx === idx" :ref="'pInput'+idx" v-model="editingParticipantName" @blur="finishEditingParticipant(idx)" @keyup.enter="finishEditingParticipant(idx)" class="w-16 bg-transparent text-white border-none outline-none text-xs font-bold p-0 m-0">
                            <button v-if="editingParticipantIdx !== idx" @click.stop="participants.splice(idx, 1)" class="hover:text-red-200 ml-1"><i class="ph-bold ph-x text-xs"></i></button>
                        </div>
                    </div>
                </div>

                <div v-if="participants.length > 0" class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-4">
                    <h3 class="font-bold text-sm text-slate-700 mb-3 flex items-center gap-2"><i class="ph-duotone ph-chart-pie-slice text-theme-main"></i> ÂÄã‰∫∫Êî∂ÊîØÊ¶ÇÊ≥Å</h3>
                    <div class="space-y-2">
                        <div v-for="d in splitCalculation.summary" :key="d.name" class="flex justify-between items-center text-xs border-b border-slate-50 pb-1 last:border-0">
                            <div class="font-bold text-slate-600">{{ d.name }}</div>
                            <div class="flex gap-3">
                                <span class="text-slate-400">Â∑≤‰ªò {{ settings.currency }}{{ d.paid }}</span>
                                <span :class="d.diff >= 0 ? 'text-green-500' : 'text-red-500'" class="font-bold w-20 text-right">{{ d.diff >= 0 ? 'ÊáâÊî∂' : 'Êáâ‰ªò' }} {{ Math.abs(d.diff) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="splitCalculation.transactions.length > 0" class="mb-4">
                    <h3 class="font-bold text-sm text-slate-700 mb-3 flex items-center gap-2"><i class="ph-duotone ph-hand-coins text-theme-main"></i> ÁµêÁÆóÂª∫Ë≠∞ (Ââ©È§òÊú™Âπ≥ÂàÜ)</h3>
                    <div v-for="(t, idx) in splitCalculation.transactions" :key="idx" class="settlement-card">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2"><span class="font-bold text-slate-700">{{ t.from }}</span><div class="flex flex-col items-center px-2"><span class="text-[9px] text-slate-400">ÊîØ‰ªòÁµ¶</span><i class="ph-bold ph-arrow-right text-theme-main"></i></div><span class="font-bold text-slate-700">{{ t.to }}</span></div>
                            <div class="text-right">
                                <span class="font-mono font-bold text-theme-main text-lg block">{{ settings.currency }} {{ t.amount }}</span>
                                <span class="font-mono text-xs text-slate-400 font-bold">(‚âà NT$ {{ t.twdAmount }})</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 mb-4">
                    <div class="space-y-2">
                        <div class="flex justify-between items-center mb-1">
                            <div class="text-xs font-bold text-slate-400">Êñ∞Â¢ûÊîØÂá∫</div>
                            <div class="flex gap-2">
                                <button @click="newExpense.isSettled = !newExpense.isSettled" class="toggle-btn settled" :class="{ 'active': newExpense.isSettled }">
                                    <i :class="newExpense.isSettled ? 'ph-fill ph-check-circle' : 'ph-bold ph-users'"></i> 
                                    {{ newExpense.isSettled ? 'Â∑≤ÁµêÊ∏Ö' : '‰∏ÄËà¨' }}
                                </button>
                                <button @click="newExpense.isNTD = !newExpense.isNTD" class="toggle-btn" :class="{ 'active': newExpense.isNTD }">
                                    {{ newExpense.isNTD ? 'NT$' : settings.currency }}
                                </button>
                            </div>
                        </div>
                        <input v-model="newExpense.item" placeholder="È†ÖÁõÆ (‰æãÂ¶Ç: Uber)" class="w-full bg-slate-50 border-none rounded-lg text-sm p-2">
                        <div class="flex gap-2">
                            <select v-model="newExpense.payer" class="flex-1 bg-slate-50 border-none rounded-lg text-sm p-2 text-slate-600"><option value="" disabled selected>ÈÅ∏Êìá‰ªòÊ¨æ‰∫∫</option><option v-for="p in participants" :value="p">{{ p }}</option></select>
                            <input v-model.number="newExpense.amount" type="number" :placeholder="newExpense.isNTD ? 'Âè∞Âπ£ÈáëÈ°ç' : 'ÈáëÈ°ç'" class="w-24 bg-slate-50 border-none rounded-lg text-sm p-2">
                        </div>
                        <button @click="addExpense" class="w-full bg-theme-main text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-1"><i class="ph-bold ph-plus"></i> Êñ∞Â¢ûË≤ªÁî®</button>
                    </div>
                </div>

                <div class="space-y-2 pb-10">
                    <div v-for="(exp, idx) in expenses" :key="idx" 
                         class="bg-white p-3 rounded-xl border border-slate-50 shadow-sm relative group" 
                         :class="{'expense-item-settled': exp.isSettled}"
                         @touchstart="startLongPress(exp)" 
                         @touchend="clearLongPress" 
                         @mousedown="startLongPress(exp)" 
                         @mouseup="clearLongPress" 
                         @mouseleave="clearLongPress">
                        <div class="flex justify-between items-center">
                            <div class="flex flex-col min-w-0 flex-1">
                                <span class="text-sm font-bold text-slate-700 flex items-center gap-2">
                                    {{ exp.item }}
                                    <i v-if="exp.isSettled" class="ph-fill ph-check-circle text-green-500 text-xs" title="Â∑≤ÁµêÊ∏Ö"></i>
                                </span>
                                <span v-if="exp.payer" class="text-[10px] text-slate-400">Paid by {{ exp.payer }}</span>
                            </div>
                            <div class="flex items-center gap-3 flex-shrink-0 ml-2">
                                <div class="text-right">
                                    <span class="font-mono font-bold block amount" :class="exp.isSettled ? 'text-green-600' : 'text-theme-main'">
                                        {{ exp.originalCurrency === 'TWD' ? 'NT$' : settings.currency }} {{ exp.originalAmount || exp.amount }}
                                    </span>
                                    <span v-if="exp.originalCurrency === 'TWD'" class="text-[9px] text-slate-300 block">‚âà {{ settings.currency }} {{ Number(exp.amount).toFixed(1) }}</span>
                                    <span v-if="!exp.isSettled" class="press-hint">Èï∑ÊåâÊ®ôË®òÁµêÊ∏Ö</span>
                                </div>
                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button @click="expenses.splice(idx, 1)" class="text-slate-300 hover:text-red-400"><i class="ph-bold ph-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="expense-list-separator">üëá ‰æÜËá™Ë°åÁ®ãÁöÑË≤ªÁî® (Èï∑ÊåâÂèØÊ®ôË®òÁÇ∫Â∑≤ÁµêÊ∏Ö)</div>
                    
                    <template v-for="day in days">
                        <template v-for="item in day.items">
                            <div v-if="item.isPaid && (Number(item.ticket)>0 || item.ticket)" 
                                 class="bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center shadow-sm itinerary-expense-card"
                                 :class="{'settled': item.isSettled}"
                                 @touchstart="startLongPress(item)" @touchend="clearLongPress" @mousedown="startLongPress(item)" @mouseup="clearLongPress" @mouseleave="clearLongPress">
                                <div class="flex flex-col min-w-0 flex-1">
                                    <span class="text-sm font-bold text-slate-700">{{ item.activity || 'Ë°åÁ®ãË≤ªÁî®' }}</span>
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <span class="text-[10px] text-white px-1.5 py-0.5 rounded font-bold bg-red-300">D{{ days.indexOf(day)+1 }}</span>
                                        <span v-if="item.payer" class="text-[10px] text-slate-400">Paid by {{ item.payer }}</span>
                                        <span v-if="item.isSettled" class="text-[10px] text-green-600 font-bold bg-green-50 px-1 rounded border border-green-200">Â∑≤ÁµêÊ∏Ö</span>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end">
                                    <span class="font-mono font-bold flex-shrink-0 ml-2 text-red-300" :class="{'line-through opacity-50': item.isSettled}">
                                        {{settings.currency}} {{ item.ticket }}
                                    </span>
                                    <span v-if="!item.isSettled" class="press-hint">Èï∑ÊåâÊ®ôË®òÁµêÊ∏Ö</span>
                                </div>
                            </div>
                        </template>
                    </template>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, reactive, watch, nextTick, onMounted } = Vue;
        
        const THEMES = {'lisbon': { main: '#006C84', light: '#6EB5C0', bg: '#FDFBF7' }, 'japan': { main: '#E11D48', light: '#FDA4AF', bg: '#FFF1F2' }, 'tokyo': { main: '#0EA5E9', light: '#7DD3FC', bg: '#F0F9FF' }, 'london': { main: '#1E3A8A', light: '#93C5FD', bg: '#F8FAFC' }, 'uk': { main: '#B91C1C', light: '#FCA5A5', bg: '#FEF2F2' }, 'korea': { main: '#8B5CF6', light: '#C4B5FD', bg: '#F5F3FF' }, 'nature': { main: '#059669', light: '#6EE7B7', bg: '#ECFDF5' }};
        
        const CURRENCY_RATES = {
            'japan': { currency: '¬•', rate: 0.21 }, 'tokyo': { currency: '¬•', rate: 0.21 }, 'uk': { currency: '¬£', rate: 40.5 }, 'london': { currency: '¬£', rate: 40.5 }, 'korea': { currency: '‚Ç©', rate: 0.024 }, 'seoul': { currency: '‚Ç©', rate: 0.024 }, 'usa': { currency: '$', rate: 31.5 }, 'america': { currency: '$', rate: 31.5 }, 'europe': { currency: '‚Ç¨', rate: 34.5 }, 'lisbon': { currency: '‚Ç¨', rate: 34.5 }, 'portugal': { currency: '‚Ç¨', rate: 34.5 }
        };
        
        const TYPES_LIST = [{ val: 'spot', label: 'ÊôØÈªû', emoji: 'üìç', bg: 'bg-[#006C84]' }, { val: 'restaurant', label: 'ÁæéÈ£ü', emoji: 'üçî', bg: 'bg-[#E11D48]' }, { val: 'cafe', label: 'ÂíñÂï°', emoji: '‚òï', bg: 'bg-[#D97706]' }, { val: 'shop', label: 'Ë≥ºÁâ©', emoji: 'üõçÔ∏è', bg: 'bg-[#7C3AED]' }, { val: 'transport', label: '‰∫§ÈÄö', emoji: 'üöá', bg: 'bg-[#334155]' }, { val: 'hotel', label: '‰ΩèÂÆø', emoji: 'üè®', bg: 'bg-[#475569]' }];
        const firebaseConfig = {apiKey: "AIzaSyC_mIkGuJCMKAcoRf78bipUJzzodTk_zVs",authDomain: "lisboaaa-2c65b.firebaseapp.com",databaseURL: "https://lisboaaa-2c65b-default-rtdb.firebaseio.com",projectId: "lisboaaa-2c65b",appId: "1:391483387676:web:d527043aee656dfc5854d9"};
        
        let db; try { firebase.initializeApp(firebaseConfig); db = firebase.database(); } catch(e){}
        
        const app = createApp({
            setup() {
                const viewMode=ref('plan'), loading=ref(false), loadingText=ref(''), isConnected=ref(false), showSettings=ref(false), showTripList=ref(false);
                const allTrips=ref({}), currentTripId=ref(localStorage.getItem('currentTripId')||null), tripOrder=ref([]);
                
                const settings = reactive({
                    name: 'Êñ∞ÊóÖÁ®ã',
                    location: '',
                    currency: '‚Ç¨',
                    rate: 34.5,
                    isLocked: false,
                    password: ''
                });
                
                const flights=ref([]), newFlight=reactive({dep:'TPE',arr:'LIS',depTime:'23:30',arrTime:'06:15',flightNumber:'CI000',nextDay:false});
                const currentDayIdx=ref(0), days=ref([{fullDate:new Date().toISOString().split('T')[0],title:'Day 1',items:[]}]);
                const expenses=ref([]), newExpense=reactive({item:'', amount:null, payer:'', isNTD: false, isSettled: false});
                const participants=ref([]), newParticipant=ref(''), editingParticipantIdx=ref(-1), editingParticipantName=ref('');
                const todos=ref([]), newTodo=reactive({text:'', category:'before', deadline:''});
                const editingTodoId = ref(null), todoLongPressTimer = ref(null), todoBeforeEdit = ref(null);
                const weather=reactive({temp:'--',icon:'sun'});
                const globalMenu=reactive({visible:false,x:0,y:0,activeItem:null});
                
                const currentDay=computed(()=> {
                    const day = days.value[currentDayIdx.value];
                    if (!day) return { fullDate: '', title: '', items: [] };
                    if (!Array.isArray(day.items)) day.items = [];
                    return day;
                });
                
                const sortedFlights=computed(()=>flights.value);
                const longPressTimer = ref(null);
                const showUnlockPrompt = ref(false), unlockPassword = ref(''), isUnlocked = ref(false);
                const urlParams = new URLSearchParams(window.location.search);
                const isReadOnlyMode = urlParams.get('readonly') === 'true';
                
                const tripOrderList=computed(()=>{
                    if(tripOrder.value.length===0) return Object.keys(allTrips.value);
                    const v=tripOrder.value.filter(id=>allTrips.value[id]);
                    return [...v, ...Object.keys(allTrips.value).filter(id=>!v.includes(id))];
                });
                
                let map, markersLayer, routeLine, userMarker, sortableInstance, tripSortableInstance;
                let saveDebounceTimer = null;
                
                const autoSetRate = () => {
                    if(!settings.location) return;
                    const loc = settings.location.toLowerCase();
                    for(const [key, value] of Object.entries(CURRENCY_RATES)) {
                        if(loc.includes(key)) {
                            settings.currency = value.currency;
                            settings.rate = value.rate;
                            return;
                        }
                    }
                };
                
                const toggleLock = () => {
                    if (settings.isLocked && !isUnlocked.value) {
                        if (settings.password) {
                            showUnlockPrompt.value = true;
                        } else {
                            isUnlocked.value = true;
                            setTimeout(() => {
                                settings.isLocked = false;
                                isUnlocked.value = false;
                            }, 300);
                        }
                    } else {
                        settings.isLocked = !settings.isLocked;
                        isUnlocked.value = false;
                    }
                };
                
                const attemptUnlock = () => {
                    if (unlockPassword.value === settings.password) {
                        isUnlocked.value = true;
                        showUnlockPrompt.value = false;
                        unlockPassword.value = '';
                        if (navigator.vibrate) navigator.vibrate([50, 100, 50]);
                        setTimeout(() => {
                            settings.isLocked = false;
                            isUnlocked.value = false;
                        }, 300);
                    } else {
                        if (navigator.vibrate) navigator.vibrate([200, 50, 200]);
                        alert('‚ùå ÂØÜÁ¢ºÈåØË™§ÔºÅ');
                        unlockPassword.value = '';
                    }
                };
                
                const openGlobalMenu=(e,i)=>{ const r=e.currentTarget.getBoundingClientRect(); globalMenu.x=Math.max(10,Math.min(window.innerWidth-140, r.left+(r.width/2)-65)); globalMenu.y=r.bottom+5; globalMenu.activeItem=i; globalMenu.visible=true; };
                const closeGlobalMenu=()=>{ globalMenu.visible=false; globalMenu.activeItem=null; };
                const confirmTypeSelection=(v)=>{ if(globalMenu.activeItem) globalMenu.activeItem.type=v; closeGlobalMenu(); };
                const getTypeName=v=>TYPES_LIST.find(t=>t.val===v)?.label||'ÊôØÈªû';
                const getTypeEmoji=v=>TYPES_LIST.find(t=>t.val===v)?.emoji||'üìç';
                const getTypeColor=v=>TYPES_LIST.find(t=>t.val===v)?.bg||'bg-slate-400';
                
                const autoResize=e=>{ const el=e.target; el.style.height='auto'; el.style.height=el.scrollHeight+'px'; };
                const resizeAllTextareas = () => { nextTick(() => { const textareas = document.querySelectorAll('.auto-textarea'); textareas.forEach(textarea => { textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px'; }); }); };
                const checkLocation = async (item) => { if (!item.location?.trim()) { item.error = false; return; } try { const r = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(item.location)}&format=json&limit=1`); const d = await r.json(); item.error = d.length === 0; } catch { item.error = true; } };
                
                const isConnectedToNext=i=>currentDay.value.items[i]?.connected&&i<currentDay.value.items.length-1;
                const isConnectedToPrev=i=>i>0&&currentDay.value.items[i-1]?.connected;
                const getPrevItem=i=>i>0?currentDay.value.items[i-1]:null;
                
                const applyGlobalTheme=async()=>{
                    if(!settings.location)return;
                    const loc=settings.location.toLowerCase();
                    let theme=THEMES['lisbon'];
                    for(const k in THEMES) if(loc.includes(k)){ theme=THEMES[k]; break; }
                    document.documentElement.style.setProperty('--theme-primary',theme.main);
                    document.documentElement.style.setProperty('--theme-light',theme.light);
                    document.documentElement.style.setProperty('--theme-bg',theme.bg);
                    autoSetRate();
                    try{
                        const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(settings.location)}&format=json&limit=1`);
                        const d=await r.json();
                        if(d.length){
                            const w=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${d[0].lat}&longitude=${d[0].lon}&current=temperature_2m,weather_code`);
                            const wd=await w.json();
                            if(wd.current){ weather.temp=Math.round(wd.current.temperature_2m); weather.icon=wd.current.weather_code<=3?'sun':'cloud'; }
                        }
                    }catch(e){}
                };
                
                const initSortable=()=>{
                    nextTick(()=>{
                        const el=document.getElementById('itinerary-list');
                        if(sortableInstance){ sortableInstance.destroy(); sortableInstance=null; }
                        if(!el) return;
                        sortableInstance=new Sortable(el, {
                            handle:'.drag-handle', animation:150, ghostClass:'sortable-ghost', dragClass:'sortable-drag', filter:'.no-drag', preventOnFilter:false,
                            delay: 250, delayOnTouchOnly: true, scroll: true, scrollSensitivity: 80, scrollSpeed: 20, 
                            onEnd:(e)=>{
                                if(e.oldIndex===e.newIndex)return;
                                const item=currentDay.value.items.splice(e.oldIndex,1)[0];
                                currentDay.value.items.splice(e.newIndex,0,item);
                                if(currentDay.value.items.length>0) currentDay.value.items[currentDay.value.items.length-1].connected=false;
                                if(viewMode.value==='map') nextTick(() => drawRoute());
                            }
                        });
                    });
                };
                
                const initTripSortable=()=>{ nextTick(()=>{ const el=document.getElementById('trip-list-container'); if(tripSortableInstance){ tripSortableInstance.destroy(); tripSortableInstance=null; } if(el){ tripSortableInstance=new Sortable(el, { handle:'.trip-drag-handle', animation:200, ghostClass:'sortable-ghost', dragClass:'sortable-drag', delay: 250, delayOnTouchOnly: true, scroll: true, onEnd:(e)=>{ if(e.oldIndex===e.newIndex)return; const n=[...tripOrderList.value], m=n.splice(e.oldIndex,1)[0]; n.splice(e.newIndex,0,m); tripOrder.value=n; if(db) db.ref('tripOrder').set(n); } }); } }); };
                
                const syncData=()=>{ if(db){ db.ref('tripOrder').on('value',s=>{if(s.val()) tripOrder.value=s.val()}); db.ref('trips').on('value',s=>{ isConnected.value=true; allTrips.value=s.val()||{}; const savedId = localStorage.getItem('currentTripId'); if(savedId && allTrips.value[savedId]) { currentTripId.value = savedId; loadCurrentTripData(); } else if(!currentTripId.value || !allTrips.value[currentTripId.value]) { const firstId = Object.keys(allTrips.value)[0]; if(firstId) { currentTripId.value = firstId; localStorage.setItem('currentTripId', firstId); loadCurrentTripData(); } else { createNewTrip(); } } else { loadCurrentTripData(); } }); } else createNewTrip(); };
                
                const createNewTrip=()=>{ const id='t_'+Date.now(); const d={ settings:{name:'My Travel',location:'',currency:'‚Ç¨',rate:34.5,isLocked:false,password:''}, days:[{fullDate:new Date().toISOString().split('T')[0],title:'Day 1',items:[]}], participants:[], todos:[] }; allTrips.value[id]=d; currentTripId.value=id; localStorage.setItem('currentTripId', id); if(db){ db.ref('trips/'+id).set(d); const newOrder = [id, ...tripOrder.value]; tripOrder.value = newOrder; db.ref('tripOrder').set(newOrder); } loadCurrentTripData(); return id; };
                
                const loadCurrentTripData=()=>{ const t=allTrips.value[currentTripId.value]; if(!t)return; Object.assign(settings, t.settings); flights.value=t.flights?Object.values(t.flights):[]; days.value = (t.days || []).map(day => ({ ...day, items: Array.isArray(day.items) ? day.items.map(item => ({ ...item, error: item.error || false })) : [] })); participants.value=t.participants||[]; expenses.value=t.expenses||[]; todos.value=t.todos||[]; sortDays(); applyGlobalTheme(); initSortable(); resizeAllTextareas(); };
                
                const switchTrip=id=>{ currentTripId.value=id; localStorage.setItem('currentTripId', id); currentDayIdx.value=0; loadCurrentTripData(); showTripList.value=false; };
                const deleteTrip=id=>{ if(confirm('Delete?')) { if(db) db.ref('trips/'+id).remove(); delete allTrips.value[id]; tripOrder.value=tripOrder.value.filter(x=>x!==id); if(db) db.ref('tripOrder').set(tripOrder.value); if(currentTripId.value===id) { const newId = Object.keys(allTrips.value)[0]; if(newId) { switchTrip(newId); } else { createNewTrip(); } } } };

                watch(viewMode, (newVal) => {
                    if (newVal === 'map') {
                        nextTick(() => {
                            setTimeout(() => {
                                if (!map) {
                                    map = L.map('map').setView([38.72, -9.14], 14);
                                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {maxZoom: 20}).addTo(map);
                                    markersLayer = L.layerGroup().addTo(map);
                                }
                                map.invalidateSize();
                                drawRoute();
                            }, 100);
                        });
                    }
                    if (newVal === 'plan') resizeAllTextareas();
                });

                watch(currentDayIdx, () => { initSortable(); resizeAllTextareas(); if (viewMode.value === 'map') nextTick(() => drawRoute()); });
                watch(showTripList, v=>{if(v)initTripSortable()});
                watch([days,expenses,settings,participants,todos], ()=>{ if(!db || !currentTripId.value) return; if(saveDebounceTimer) clearTimeout(saveDebounceTimer); saveDebounceTimer = setTimeout(() => { db.ref(`trips/${currentTripId.value}`).update({ days: JSON.parse(JSON.stringify(days.value)), expenses: JSON.parse(JSON.stringify(expenses.value)), settings: settings, participants: participants.value, todos: JSON.parse(JSON.stringify(todos.value)) }); }, 500); }, {deep:true});

                const sortDays = (targetDate = null) => { const currentDate = targetDate || currentDay.value?.fullDate; days.value.sort((a, b) => new Date(a.fullDate) - new Date(b.fullDate)); if (currentDate) { const newIndex = days.value.findIndex(d => d.fullDate === currentDate); if (newIndex !== -1) currentDayIdx.value = newIndex; } };
                const addFlight=()=>{ flights.value.push({id:Date.now(),...newFlight,connected:false}); };
                const removeFlight=id=>flights.value=flights.value.filter(x=>x.id!==id);
                const addDay = () => { let lastDate; if (days.value.length > 0) lastDate = days.value[days.value.length - 1].fullDate; else lastDate = new Date().toISOString().split('T')[0]; const d = new Date(lastDate); d.setDate(d.getDate() + 1); const newDate = d.toISOString().split('T')[0]; days.value.push({ fullDate: newDate, title: '', items: [] }); sortDays(newDate); };
                const addItem=()=>{ if (!currentDay.value || !Array.isArray(currentDay.value.items)) { alert('‚ö†Ô∏è ÁÑ°Ê≥ïÊñ∞Â¢ûË°åÁ®ã'); return; } currentDay.value.items.push({ id: Date.now(), time: '10:00', type: 'spot', activity: '', location: '', connected: false, error: false }); nextTick(()=>{ resizeAllTextareas(); }); };
                const deleteItem=i=>currentDay.value.items.splice(i,1);
                const confirmAndDeleteDay=()=>{ if(confirm('Delete Day?')) { days.value.splice(currentDayIdx.value,1); currentDayIdx.value=Math.max(0, currentDayIdx.value-1); } };
                
                const addParticipant=()=>{ if(newParticipant.value.trim()){ participants.value.push(newParticipant.value.trim()); newParticipant.value=''; } };
                const startEditingParticipant=(idx, name)=>{ editingParticipantIdx.value=idx; editingParticipantName.value=name; };
                const finishEditingParticipant=(idx)=>{ const oldName=participants.value[idx]; const newName=editingParticipantName.value.trim(); if(newName && newName !== oldName) { participants.value[idx]=newName; expenses.value.forEach(e=>{if(e.payer===oldName)e.payer=newName;}); days.value.forEach(d=>d.items.forEach(i=>{if(i.payer===oldName)i.payer=newName;})); } editingParticipantIdx.value=-1; };
                const addExpense=()=>{ if(newExpense.item && newExpense.amount){ const finalAmount = newExpense.isNTD ? (newExpense.amount / settings.rate) : newExpense.amount; expenses.value.push({ item: newExpense.item, amount: Number(finalAmount.toFixed(2)), originalAmount: newExpense.amount, originalCurrency: newExpense.isNTD ? 'TWD' : settings.currency, payer: newExpense.payer, isSettled: newExpense.isSettled }); newExpense.item=''; newExpense.amount=null; newExpense.payer=''; } };
                const startLongPress = (item) => { longPressTimer.value = setTimeout(() => { item.isSettled = !item.isSettled; if(navigator.vibrate) navigator.vibrate(50); }, 600); };
                const clearLongPress = () => { if(longPressTimer.value) { clearTimeout(longPressTimer.value); longPressTimer.value = null; } };
                
                const totalExpense=computed(()=>{ let t=expenses.value.reduce((a,b)=>a+(Number(b.amount)||0),0); if (days.value && Array.isArray(days.value)) { days.value.forEach(d => { if (d && d.items && Array.isArray(d.items)) { d.items.forEach(i => { if(i && i.isPaid && i.ticket) t += (Number(i.ticket) || 0); }); } }); } return t; });
                
                const splitCalculation=computed(()=>{ if(!participants.value.length) return { perPerson:0, balances:{}, transactions:[], summary:[] }; const validExpenses = expenses.value.filter(e => !e.isSettled); const expenseTotal = validExpenses.reduce((a,b)=>a+(Number(b.amount)||0),0); let dayTotal = 0; if (days.value && Array.isArray(days.value)) { days.value.forEach(d => { if (d && d.items && Array.isArray(d.items)) { d.items.forEach(i => { if(i && i.isPaid && i.ticket && !i.isSettled) dayTotal += (Number(i.ticket) || 0); }); } }); } const total = expenseTotal + dayTotal; const perPerson = total / participants.value.length; const balances = {}; participants.value.forEach(p=>balances[p] = -perPerson); validExpenses.forEach(e=>{ if(e.payer && participants.value.includes(e.payer)) balances[e.payer]+=Number(e.amount); }); if (days.value && Array.isArray(days.value)) { days.value.forEach(d => { if (d && d.items && Array.isArray(d.items)) { d.items.forEach(i => { if(i && i.isPaid && i.ticket && i.payer && participants.value.includes(i.payer) && !i.isSettled) balances[i.payer] += Number(i.ticket); }); } }); } const summary = participants.value.map(p=>({ name:p, paid:Number((balances[p]+perPerson).toFixed(0)), diff:Math.round(balances[p]) })); let creditors=[], debtors=[]; Object.entries(balances).forEach(([n,a])=>{ if(a>0.01) creditors.push({name:n,amount:a}); else if(a<-0.01) debtors.push({name:n,amount:-a}); }); creditors.sort((a,b)=>b.amount-a.amount); debtors.sort((a,b)=>b.amount-a.amount); const transactions=[]; let i=0,j=0; while(i<creditors.length && j<debtors.length){ const amt = Math.min(creditors[i].amount, debtors[j].amount); transactions.push({ from:debtors[j].name, to:creditors[i].name, amount:amt.toFixed(1), twdAmount: Math.round(amt * settings.rate).toLocaleString() }); creditors[i].amount-=amt; debtors[j].amount-=amt; if(creditors[i].amount<0.01)i++; if(debtors[j].amount<0.01)j++; } return { perPerson:perPerson.toFixed(1), balances, transactions, summary }; });
                
                const addTodo=()=>{ if(newTodo.text){ todos.value.push({id:Date.now(),...newTodo,completed:false}); newTodo.text=''; newTodo.deadline=''; } };
                const deleteTodo=id=>todos.value=todos.value.filter(t=>t.id!==id);
                const getSortedTodosByCategory = (c) => { const filtered = todos.value.filter(t => t.category === c); return filtered.sort((a, b) => { if (a.deadline && b.deadline) return new Date(a.deadline) - new Date(b.deadline); if (a.deadline && !b.deadline) return -1; if (!a.deadline && b.deadline) return 1; return 0; }); };
                const startTodoLongPress = (todo) => { todoLongPressTimer.value = setTimeout(() => { todoBeforeEdit.value = JSON.parse(JSON.stringify({text: todo.text, deadline: todo.deadline})); editingTodoId.value = todo.id; if(navigator.vibrate) navigator.vibrate(50); }, 600); };
                const clearTodoLongPress = () => { if(todoLongPressTimer.value) { clearTimeout(todoLongPressTimer.value); todoLongPressTimer.value = null; } };
                const finishEditingTodo = () => { editingTodoId.value = null; todoBeforeEdit.value = null; };
                const cancelEditingTodo = () => { if (todoBeforeEdit.value && editingTodoId.value) { const todo = todos.value.find(t => t.id === editingTodoId.value); if (todo) { todo.text = todoBeforeEdit.value.text; todo.deadline = todoBeforeEdit.value.deadline; } } editingTodoId.value = null; todoBeforeEdit.value = null; };
                const calculateLayover=i=>{ const c=flights.value[i],n=flights.value[i+1]; if(!c||!n)return''; const m=(t,d)=>{const[h,mm]=t.split(':').map(Number);return h*60+mm+(d?1440:0)}; let a=m(c.arrTime,c.nextDay),d=m(n.depTime,false); if(d<a)d+=1440; const df=d-a; return `${Math.floor(df/60)}h ${df%60}m`; };
                
                const getAdvancedIcon = (t, idx) => {
                    const type = TYPES_LIST.find(x => x.val === t);
                    const bgClass = type?.bg || 'bg-slate-400';
                    const colorMatch = bgClass.match(/\[([^\]]+)\]/);
                    const bgColor = colorMatch ? colorMatch[1] : '#64748b';
                    const iconMap = { 'spot': 'ph-map-pin', 'restaurant': 'ph-fork-knife', 'cafe': 'ph-coffee', 'shop': 'ph-shopping-bag', 'transport': 'ph-train', 'hotel': 'ph-bed' };
                    const iconClass = iconMap[t] || 'ph-map-pin';
                    return L.divIcon({
                        html: `<div class="pin-wrapper"><div class="pin-main" style="background-color:${bgColor}"><i class="ph-bold ${iconClass}"></i></div><div class="pin-badge">${idx + 1}</div></div>`,
                        className: '',
                        iconSize: [36, 36],
                        iconAnchor: [18, 18],
                        popupAnchor: [0, -10]
                    });
                };
                
                // ‚úÖ Ë∂ÖÈÄü‰ºòÂåñÁâà drawRoute
                const drawRoute = async () => {
                    if (!map) {
                        map = L.map('map').setView([38.72, -9.14], 14);
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);
                        markersLayer = L.layerGroup().addTo(map);
                    }
                    
                    markersLayer.clearLayers();
                    if (routeLine) {
                        map.removeLayer(routeLine);
                        routeLine = null;
                    }
                    
                    const it = currentDay.value.items || [];
                    const l = it.filter(x => x.location?.trim());
                    if (!l.length) return;
                    
                    // ‚úÖ Âπ∂ÂèëËØ∑Ê±ÇÊâÄÊúâÂú∞ÁÇπÔºàÂÖ≥ÈîÆ‰ºòÂåñÔºâ
                    const geocodePromises = l.map(async (item) => {
                        if (item.lat && item.lon && item.cachedLoc === item.location) {
                            return { lat: item.lat, lon: item.lon, item };
                        }
                        
                        try {
                            const r = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(item.location)}&format=json&limit=1`);
                            const d = await r.json();
                            if (d.length) {
                                const lat = parseFloat(d[0].lat);
                                const lon = parseFloat(d[0].lon);
                                item.lat = lat;
                                item.lon = lon;
                                item.cachedLoc = item.location;
                                return { lat, lon, item };
                            }
                        } catch (e) {}
                        
                        return null;
                    });
                    
                    loading.value = true;
                    loadingText.value = 'ËºâÂÖ•Âú∞Âúñ‰∏≠...';
                    
                    const results = await Promise.all(geocodePromises);
                    const pts = [], b = [];
                    
                    results.forEach((result) => {
                        if (result && result.lat && result.lon) {
                            const { lat, lon, item } = result;
                            L.marker([lat, lon], { icon: getAdvancedIcon(item.type, it.indexOf(item)) })
                                .addTo(markersLayer)
                                .bindPopup(item.activity || item.location);
                            pts.push([lat, lon]);
                            b.push([lat, lon]);
                        }
                    });
                    
                    if (pts.length > 1) {
                        routeLine = L.polyline(pts, {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--theme-primary'),
                            weight: 3,
                            opacity: 0.6,
                            dashArray: '4,8'
                        }).addTo(map);
                    }
                    
                    if (b.length) map.fitBounds(b, { padding: [60, 60] });
                    loading.value = false;
                };
                
                const switchMapDay = (index) => { currentDayIdx.value = index; nextTick(() => drawRoute()); };
                const locateUser = () => { if (!navigator.geolocation) { alert('ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÂÆö‰ΩçÂäüËÉΩ'); return; } loading.value = true; loadingText.value = 'Ê≠£Âú®ÂÆö‰Ωç‰∏≠...'; navigator.geolocation.getCurrentPosition( (position) => { const { latitude, longitude } = position.coords; if (userMarker) map.removeLayer(userMarker); userMarker = L.marker([latitude, longitude], { icon: L.divIcon({ html: '<div class="w-10 h-10 bg-blue-500 border-4 border-white rounded-full shadow-lg flex items-center justify-center"><i class="ph-fill ph-navigation-arrow text-white text-lg"></i></div>', className: '', iconSize: [40, 40], iconAnchor: [20, 20] }) }).addTo(map).bindPopup("<b>üìç ÊàëÁöÑ‰ΩçÁΩÆ</b>").openPopup(); map.flyTo([latitude, longitude], 16, { duration: 1.5 }); loading.value = false; }, (error) => { loading.value = false; alert('‚ùå ÂÆö‰ΩçÂ§±Êïó'); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 } ); };
                const getWeatherIcon=i=>i=='sun'?'ph-fill ph-sun text-accent':(i=='rain'?'ph-fill ph-cloud-rain text-blue-300':'ph-fill ph-cloud text-white/90');

                if (isReadOnlyMode && !settings.isLocked) settings.isLocked = true;
                onMounted(()=>{ syncData(); applyGlobalTheme(); });
                
                return {
                    viewMode, loading, loadingText, isConnected, showSettings, showTripList, settings, flights, newFlight, addFlight, removeFlight, sortedFlights, calculateLayover,
                    days, currentDayIdx, currentDay, addDay, addItem, deleteItem, confirmAndDeleteDay, sortDays,
                    drawRoute, locateUser, expenses, newExpense, addExpense, totalExpense,
                    weather, allTrips, currentTripId, switchTrip, createNewTrip, applyGlobalTheme, getWeatherIcon,
                    TYPES_LIST, getTypeName, getTypeEmoji, getTypeColor, autoResize, resizeAllTextareas, isConnectedToNext, isConnectedToPrev, getPrevItem, deleteTrip, checkLocation, globalMenu, openGlobalMenu, closeGlobalMenu, confirmTypeSelection,
                    participants, newParticipant, addParticipant, splitCalculation, startEditingParticipant, editingParticipantIdx, editingParticipantName, finishEditingParticipant,
                    todos, newTodo, addTodo, deleteTodo, getSortedTodosByCategory, tripOrderList, tripOrder,
                    startLongPress, clearLongPress, switchMapDay,
                    editingTodoId, startTodoLongPress, clearTodoLongPress, finishEditingTodo, cancelEditingTodo,
                    showUnlockPrompt, unlockPassword, isUnlocked, toggleLock, attemptUnlock, autoSetRate
                };
            }
        });
        app.mount('#app');
    </script>
</body>
</html>
