<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‘¡è±¬è±¬æ—…éŠè¨ˆç•« | GPS å®šä½ç‰ˆ</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet CSS (åœ°åœ–) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F0FDF4; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; } 
        .sync-pulse { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        /* å®šä½é»å‹•ç•« */
        .gps-marker {
            background-color: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            width: 16px; height: 16px;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.6); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        input:focus, select:focus { outline: none; }
    </style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden fixed inset-0">

    <div id="app" class="flex flex-col h-full max-w-md mx-auto w-full bg-white shadow-2xl relative sm:border-x sm:border-slate-200">

        <!-- Header -->
        <header class="bg-teal-600 text-white shrink-0 z-20 shadow-md transition-all duration-300">
            <div class="p-4 flex justify-between items-center pb-2">
                <div class="flex items-center gap-3 min-w-0 flex-1">
                    <div class="relative shrink-0">
                         <div v-if="isConnected" class="w-3 h-3 bg-green-400 rounded-full sync-pulse border border-white" title="å·²é€£ç·š"></div>
                         <div v-else class="w-3 h-3 bg-red-400 rounded-full border border-white" title="é›¢ç·šä¸­"></div>
                    </div>
                    <div class="overflow-hidden flex-1">
                        <input v-model="currentTrip.destination" class="bg-transparent border-none text-lg font-bold text-white placeholder-teal-200 w-full p-0 focus:ring-0 truncate" placeholder="è¼¸å…¥æ—…ç¨‹åç¨±...">
                    </div>
                </div>
                <button @click="copyShareLink" class="text-[10px] bg-teal-700/50 px-2 py-1 rounded-full flex items-center gap-1 hover:bg-teal-700 transition">
                    <i class="ph-bold ph-users"></i> ID: {{ roomId || '...' }}
                </button>
            </div>

            <div class="px-4 pb-3 flex gap-2">
                 <button @click="viewMode = 'plan'" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-colors flex justify-center gap-1" :class="viewMode === 'plan' ? 'bg-white text-teal-600' : 'bg-teal-700/30 text-teal-100'">
                    <i class="ph-bold ph-list-dashes text-sm"></i> è¡Œç¨‹
                 </button>
                 <button @click="viewMode = 'map'" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-colors flex justify-center gap-1" :class="viewMode === 'map' ? 'bg-white text-teal-600' : 'bg-teal-700/30 text-teal-100'">
                    <i class="ph-bold ph-map-trifold text-sm"></i> åœ°åœ–
                 </button>
                 <button @click="viewMode = 'money'" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-colors flex justify-center gap-1" :class="viewMode === 'money' ? 'bg-white text-teal-600' : 'bg-teal-700/30 text-teal-100'">
                    <i class="ph-bold ph-coins text-sm"></i> åˆ†å¸³
                 </button>
            </div>

            <div v-if="viewMode === 'plan' && days.length > 0" class="flex overflow-x-auto hide-scroll px-2 pb-3 space-x-2 snap-x items-center bg-teal-50 border-t border-teal-100 pt-2">
                <div v-for="(day, index) in days" :key="index" @click="currentDayIdx = index" class="snap-center shrink-0 flex flex-col items-center justify-center w-12 h-14 rounded-xl cursor-pointer transition-all border-2 relative overflow-hidden" :class="currentDayIdx === index ? 'bg-white text-teal-600 border-teal-400 shadow-md scale-105' : 'bg-white border-transparent text-slate-400 hover:bg-slate-50'">
                    <span class="text-[10px] font-medium opacity-80">Day</span>
                    <span class="text-sm font-black">{{ index + 1 }}</span>
                </div>
                <button @click="addDay" class="shrink-0 w-10 h-14 rounded-xl flex items-center justify-center border-2 border-teal-300 border-dashed text-teal-300 hover:text-teal-500 hover:border-teal-500 transition"><i class="ph-bold ph-plus"></i></button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto bg-slate-50 relative hide-scroll">
            <div v-if="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 backdrop-blur-sm z-50">
                <i class="ph-duotone ph-spinner animate-spin text-4xl text-teal-500 mb-3"></i>
                <p class="text-sm font-medium text-slate-500">æ­£åœ¨é€£ç·šåŒæ­¥ä¸­...</p>
            </div>

            <!-- 1. è¡Œç¨‹è¡¨ -->
            <div v-show="viewMode === 'plan' && !loading" class="p-4 pb-32">
                <div class="bg-white p-3 rounded-xl shadow-sm mb-4 border border-slate-100">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="ph-bold ph-calendar-blank text-teal-500"></i>
                        <input type="date" v-model="currentDay.fullDate" class="text-xs text-slate-500 bg-transparent border-none p-0">
                    </div>
                    <input v-model="currentDay.title" class="text-base font-bold w-full border-none p-0 placeholder-slate-300" placeholder="ç•¶æ—¥ä¸»é¡Œ (ä¾‹å¦‚: æŠµé”é‡Œæ–¯æœ¬)">
                </div>

                <div class="space-y-3 relative pl-4 border-l-2 border-teal-100 ml-1">
                    <div v-for="(item, idx) in currentDay.items" :key="idx" class="relative group">
                        <div class="absolute -left-[23px] top-4 w-4 h-4 rounded-full border-2 border-white shadow-sm z-10" :class="getTypeColor(item.type)"></div>
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-all">
                            <div class="flex items-start gap-2">
                                <div class="flex flex-col items-center w-14 shrink-0 gap-1">
                                    <input v-model="item.time" type="time" class="text-sm font-black bg-slate-100 rounded px-1 w-full text-center border-none text-slate-600">
                                    <select v-model="item.type" class="text-[10px] w-full bg-transparent border-none text-center p-0 cursor-pointer text-slate-400">
                                        <option value="spot">ğŸ“ æ™¯é»</option>
                                        <option value="food">ğŸ´ ç¾é£Ÿ</option>
                                        <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                                        <option value="transport">ğŸš‡ äº¤é€š</option>
                                        <option value="hotel">ğŸ¨ ä½å®¿</option>
                                    </select>
                                </div>
                                <div class="flex-1 min-w-0 space-y-1">
                                    <input v-model="item.activity" class="w-full font-bold text-sm border-none p-0 text-slate-800 placeholder-slate-300 bg-transparent" placeholder="è¡Œç¨‹åç¨±">
                                    <input v-model="item.location" class="w-full text-xs text-slate-500 border-none p-0 bg-transparent truncate" placeholder="åœ°é» / å°èˆªé—œéµå­—">
                                    <input v-model="item.note" class="w-full text-[10px] bg-orange-50/50 text-orange-600 px-1.5 py-0.5 rounded border-none placeholder-orange-300" placeholder="å‚™è¨»...">
                                </div>
                                <button @click="currentDay.items.splice(idx, 1)" class="text-slate-200 hover:text-red-400 p-1"><i class="ph-bold ph-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    <button @click="addItem" class="w-full py-3 border-2 border-dashed border-teal-200 rounded-xl text-teal-400 font-bold text-sm hover:bg-teal-50 flex items-center justify-center gap-2">
                        <i class="ph-bold ph-plus-circle"></i> æ–°å¢è¡Œç¨‹
                    </button>
                </div>
                <div class="mt-8 text-center">
                     <button @click="removeCurrentDay" class="text-xs text-slate-300 hover:text-red-400 underline">åˆªé™¤ç•¶å¤©è¡Œç¨‹</button>
                </div>
            </div>

            <!-- 2. åœ°åœ– -->
            <div v-show="viewMode === 'map'" class="h-full flex flex-col relative">
                <div id="map" class="flex-1 w-full h-full bg-slate-100 z-0"></div>
                <!-- å®šä½æŒ‰éˆ• -->
                <div class="absolute bottom-6 left-4 right-4 z-[1000] flex gap-2 justify-center">
                    <button @click="locateUser" class="bg-blue-600 text-white px-4 py-2.5 rounded-full shadow-xl font-bold text-sm flex items-center gap-2 active:scale-95 transition hover:bg-blue-700">
                        <i v-if="isLocating" class="ph-bold ph-spinner animate-spin"></i>
                        <i v-else class="ph-bold ph-crosshair"></i>
                        {{ isLocating ? 'å®šä½ä¸­...' : 'æˆ‘çš„ä½ç½®' }}
                    </button>
                    <button @click="initMap" class="bg-white text-slate-600 px-4 py-2.5 rounded-full shadow-xl font-bold text-sm flex items-center gap-2 active:scale-95 transition">
                        <i class="ph-bold ph-arrows-clockwise"></i> é‡æ•´åœ°åœ–
                    </button>
                </div>
            </div>

            <!-- 3. åˆ†å¸³ -->
            <div v-show="viewMode === 'money'" class="p-4 pb-32">
                <div class="bg-slate-800 text-white rounded-2xl p-6 shadow-lg mb-4 text-center">
                    <div class="text-xs text-slate-400 mb-1">ç¸½æ”¯å‡º Total</div>
                    <div class="text-3xl font-bold font-mono tracking-tight">NT$ {{ totalExpense.toLocaleString() }}</div>
                </div>
                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 mb-4">
                    <div class="flex gap-2 mb-2">
                         <input v-model="newExpense.item" placeholder="é …ç›® (å¦‚: æ™šé¤)" class="flex-[2] bg-slate-100 border-none rounded-lg px-3 py-2 text-sm">
                         <input v-model="newExpense.payer" placeholder="èª°ä»˜çš„" class="flex-1 bg-slate-100 border-none rounded-lg px-3 py-2 text-sm text-center">
                    </div>
                    <div class="flex gap-2">
                         <input v-model.number="newExpense.amount" type="number" placeholder="é‡‘é¡" class="flex-1 bg-slate-100 border-none rounded-lg px-3 py-2 text-sm font-mono">
                         <button @click="addExpense" class="bg-teal-600 text-white rounded-lg px-4 py-2 font-bold text-sm"><i class="ph-bold ph-plus"></i></button>
                    </div>
                </div>
                <div class="space-y-2">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-teal-50 text-teal-600 flex items-center justify-center text-xs font-bold">{{ exp.payer ? exp.payer[0] : '?' }}</div>
                            <div><div class="font-bold text-slate-700 text-sm">{{ exp.item }}</div></div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold font-mono text-slate-700">${{ exp.amount }}</span>
                            <button @click="expenses.splice(idx, 1)" class="text-slate-300 hover:text-red-400"><i class="ph-bold ph-x"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div v-if="showRoomModal" class="fixed inset-0 bg-slate-900/80 z-[999] flex items-center justify-center p-6 backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-8 w-full max-w-sm text-center">
                <div class="w-20 h-20 bg-teal-50 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="ph-duotone ph-airplane-tilt text-4xl text-teal-600"></i>
                </div>
                <h2 class="text-2xl font-black text-slate-800 mb-2">è‘¡è±¬è±¬æ—…éŠè¨ˆç•«</h2>
                <div class="space-y-3">
                    <input v-model="inputRoomId" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-center font-mono text-lg uppercase placeholder-slate-400" placeholder="è¼¸å…¥æˆ¿é–“ ID">
                    <button @click="joinRoom" class="w-full bg-teal-600 text-white font-bold py-3 rounded-xl">é€²å…¥è¡Œç¨‹</button>
                    <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-slate-200"></div><span class="flex-shrink mx-4 text-slate-300 text-xs">æˆ–</span><div class="flex-grow border-t border-slate-200"></div></div>
                    <button @click="createNewRoom" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl">å»ºç«‹æ–°è¡Œç¨‹</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, reactive, watch, computed, nextTick, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref as dbRef, onValue, set } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC_mIkGuJCMKAcoRf78bipUJzzodTk_zVs",
            authDomain: "lisboaaa-2c65b.firebaseapp.com",
            databaseURL: "https://lisboaaa-2c65b-default-rtdb.firebaseio.com",
            projectId: "lisboaaa-2c65b",
            storageBucket: "lisboaaa-2c65b.firebasestorage.app",
            messagingSenderId: "391483387676",
            appId: "1:391483387676:web:d527043aee656dfc5854d9",
            measurementId: "G-NPDLH60580"
        };

        const fbApp = initializeApp(firebaseConfig);
        const db = getDatabase(fbApp);

        createApp({
            setup() {
                const viewMode = ref('plan');
                const currentDayIdx = ref(0);
                const isConnected = ref(false);
                const loading = ref(false);
                const showRoomModal = ref(true);
                const inputRoomId = ref('');
                const roomId = ref(new URLSearchParams(window.location.search).get('room'));
                const isLocating = ref(false); // å®šä½ç‹€æ…‹

                const defaultTrip = { destination: 'æ–°æ—…ç¨‹', days: [{ fullDate: new Date().toISOString().split('T')[0], title: '', items: [] }], expenses: [] };
                const currentTrip = ref(JSON.parse(JSON.stringify(defaultTrip)));
                const isRemoteUpdate = ref(false);

                const days = computed(() => currentTrip.value.days || []);
                const currentDay = computed(() => days.value[currentDayIdx.value] || {});
                const expenses = computed(() => currentTrip.value.expenses || []);
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (Number(item.amount) || 0), 0));
                const newExpense = reactive({ item: '', amount: null, payer: '' });

                const connectToFirebase = () => {
                    if (!roomId.value) return;
                    loading.value = true;
                    const tripRef = dbRef(db, 'trips/' + roomId.value);
                    onValue(tripRef, (snapshot) => {
                        isConnected.value = true;
                        const val = snapshot.val();
                        isRemoteUpdate.value = true;
                        if (val) {
                            if(!val.days) val.days = [];
                            if(!val.expenses) val.expenses = [];
                            currentTrip.value = val;
                        } else {
                            set(tripRef, defaultTrip);
                            currentTrip.value = JSON.parse(JSON.stringify(defaultTrip));
                        }
                        loading.value = false;
                        nextTick(() => isRemoteUpdate.value = false);
                    });
                };

                watch(currentTrip, (newVal) => {
                    if (roomId.value && !loading.value && !isRemoteUpdate.value) {
                        const tripRef = dbRef(db, 'trips/' + roomId.value);
                        set(tripRef, newVal).catch(e => console.error(e));
                    }
                }, { deep: true });

                const createNewRoom = () => { roomId.value = Math.random().toString(36).substr(2, 6).toUpperCase(); finalizeJoin(); };
                const joinRoom = () => { if(!inputRoomId.value.trim()) return; roomId.value = inputRoomId.value.trim().toUpperCase(); finalizeJoin(); };
                const finalizeJoin = () => { 
                    const url = new URL(window.location); url.searchParams.set('room', roomId.value); window.history.pushState({}, '', url); 
                    showRoomModal.value = false; connectToFirebase(); 
                };
                const copyShareLink = () => { navigator.clipboard.writeText(window.location.href); alert("é€£çµå·²è¤‡è£½ï¼"); };

                const addDay = () => {
                    const last = days.value[days.value.length-1]; const next = new Date(last ? last.fullDate : new Date()); if(last) next.setDate(next.getDate() + 1);
                    days.value.push({ fullDate: next.toISOString().split('T')[0], title: '', items: [] }); currentDayIdx.value = days.value.length - 1;
                };
                const addItem = () => { if(!currentDay.value.items) currentDay.value.items = []; currentDay.value.items.push({ time: '', type: 'spot', activity: '', location: '', note: '' }); };
                const removeCurrentDay = () => { if(days.value.length<=1) return alert('è‡³å°‘ä¿ç•™ä¸€å¤©'); if(confirm('åˆªé™¤é€™ä¸€å¤©ï¼Ÿ')) { days.value.splice(currentDayIdx.value, 1); currentDayIdx.value = Math.max(0, currentDayIdx.value - 1); } }
                const addExpense = () => { if(newExpense.item && newExpense.amount) { expenses.value.unshift({ ...newExpense }); newExpense.item = ''; newExpense.amount = null; } };
                const getTypeColor = (type) => { return ({ spot: 'bg-teal-500', food: 'bg-orange-500', shop: 'bg-purple-500', transport: 'bg-blue-500', hotel: 'bg-indigo-500' })[type] || 'bg-slate-400'; };

                // --- åœ°åœ–èˆ‡å®šä½ ---
                let map = null;
                let userMarker = null;

                const initMap = () => {
                    if (map) { map.remove(); map = null; }
                    // é è¨­å…ˆé¡¯ç¤ºé è¨­ä½ç½®ï¼Œç¨å¾Œå®šä½æœƒè¦†è“‹
                    map = L.map('map').setView([25.0330, 121.5654], 13); 
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
                    
                    // å…¶ä»–è¡Œç¨‹é» (ç›®å‰ç„¡çœŸå¯¦åº§æ¨™ï¼Œä½¿ç”¨æ¨¡æ“¬åç§»å±•ç¤º)
                    const itemsWithLoc = currentDay.value.items?.filter(i => i.location) || [];
                    if(itemsWithLoc.length > 0) {
                        itemsWithLoc.forEach((item, i) => {
                            // è‹¥æ²’æœ‰çœŸå¯¦åº§æ¨™ï¼Œç„¡æ³•è‡ªå‹•æ¨™è¨˜ï¼Œæ­¤è™•åƒ…ä½œç¤ºæ„ï¼Œé¿å…åœ°åœ–ç©ºç™½
                            // é€™è£¡ä¸å¼·åˆ¶æ¨™è¨˜ï¼Œé¿å…èª¤å°ã€‚æœªä¾†è‹¥èƒ½ä¸²æ¥ Google API å¯åœ¨æ­¤å¯¦ä½œ
                        });
                    }
                };

                // æ ¸å¿ƒï¼šç²å–çœŸå¯¦å®šä½
                const locateUser = () => {
                    if (!navigator.geolocation) return alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
                    isLocating.value = true;
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            if(!map) initMap();

                            // é£›åˆ°ä½¿ç”¨è€…ä½ç½®
                            map.flyTo([latitude, longitude], 16);

                            // ç•«å‡ºä½¿ç”¨è€…ä½ç½®çš„å°è—é»
                            if(userMarker) map.removeLayer(userMarker);
                            const myIcon = L.divIcon({ className: 'gps-marker', iconSize: [16, 16], iconAnchor: [8, 8] });
                            userMarker = L.marker([latitude, longitude], {icon: myIcon}).addTo(map).bindPopup("æˆ‘ç¾åœ¨çš„ä½ç½®").openPopup();
                            
                            isLocating.value = false;
                        },
                        (error) => {
                            alert("ç„¡æ³•ç²å–ä½ç½®ï¼Œè«‹ç¢ºèªæ˜¯å¦å…è¨±å®šä½æ¬Šé™\n(éŒ¯èª¤: " + error.message + ")");
                            isLocating.value = false;
                        },
                        { enableHighAccuracy: true }
                    );
                };

                watch(viewMode, (v) => { if(v==='map') nextTick(initMap); });
                onMounted(() => { if (roomId.value) { showRoomModal.value = false; connectToFirebase(); } });

                return {
                    viewMode, currentTrip, currentDayIdx, days, currentDay, expenses, totalExpense, newExpense,
                    loading, isConnected, showRoomModal, inputRoomId, roomId, isLocating,
                    createNewRoom, joinRoom, copyShareLink, addDay, addItem, removeCurrentDay, addExpense, getTypeColor, initMap, locateUser
                };
            }
        }).mount('#app');
    </script>
</body>
</html>